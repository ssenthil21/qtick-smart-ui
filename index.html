<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Enabled AI Assistant - QTick</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .agentic-pane {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
        }
        .main-pane-height {
             height: calc(100vh - 120px);
        }
        .modal-backdrop, .drag-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .suggestion-chip, .tab-btn {
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .tab-btn-active {
            background-color: #fff7ed;
            color: #ea580c;
            border-color: #f97316;
        }
        .thinking-bubble::after {
            content: '.';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        #mic-btn.listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(234, 88, 12, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); }
        }
        .chat-response-container {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: white;
        }
        .chat-response-container h4 {
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #1e293b;
        }
        .appointment-row {
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .appointment-row:hover {
            background-color: #fff7ed;
        }
        .quick-action-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .quick-action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -15px rgba(15, 23, 42, 0.4);
        }
        .tool-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .tool-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 18px 35px -25px rgba(15, 23, 42, 0.45);
        }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <nav class="container mx-auto px-4 lg:px-6 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-orange-600">
                <i class="fa-solid fa-robot mr-2"></i>QTick AI Smart Assistant
            </h1>
            <div class="flex items-center space-x-4">
                <button id="tts-toggle-btn" class="text-slate-400 hover:text-orange-600" title="Toggle Voice Response">
                    <i class="fa-solid fa-volume-xmark"></i>
                </button>
                <button id="settings-btn" class="text-slate-500 hover:text-orange-600">
                    <i class="fa-solid fa-cog text-xl"></i>
                </button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-5 gap-6">
        <div class="lg:col-span-3 agentic-pane main-pane-height relative">
            <h2 class="text-lg font-bold p-4 border-b text-slate-700">Agent Chat</h2>
            <div id="chat-history" class="flex-grow p-4 space-y-4 overflow-y-auto">
                <div class="flex">
                    <div class="bg-slate-200 text-slate-800 p-3 rounded-lg max-w-md">
                        <p>I can now display data in tables, cards, and invoice summaries. Try asking me to \"list appointments\".</p>
                    </div>
                </div>
            </div>
            <div id="suggestion-chips-container" class="p-4 pt-0 flex flex-wrap gap-2"></div>
            <div class="p-4 border-t bg-slate-50">
                <div id="file-preview-container" class="hidden mb-2"></div>
                <form id="chat-form" class="flex items-center space-x-2">
                    <input type="file" id="file-input" class="hidden">
                    <button type="button" id="attach-btn" class="bg-slate-200 text-slate-600 font-semibold p-2.5 rounded-md hover:bg-slate-300 transition flex-shrink-0 h-10 w-10"><i class="fa-solid fa-paperclip"></i></button>
                    <input id="chat-input" placeholder="Enter your goal..." class="flex-grow w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
                    <button type="button" id="mic-btn" class="bg-orange-500 text-white font-semibold p-2.5 rounded-md hover:bg-orange-600 transition flex-shrink-0 h-10 w-10"><i class="fa-solid fa-microphone"></i></button>
                    <button type="submit" class="bg-orange-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-orange-700 transition flex-shrink-0">Run</button>
                </form>
            </div>
            <div id="drag-overlay" class="absolute inset-0 z-10 hidden items-center justify-center bg-opacity-75 backdrop-blur-sm drag-overlay">
                <div class="text-center text-white p-6 border-4 border-dashed rounded-xl">
                    <i class="fa-solid fa-upload fa-3x"></i>
                    <p class="mt-4 text-xl font-bold">Drop file to upload</p>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 flex flex-col min-h-[calc(100vh-120px)]">
            <div class="agentic-pane flex-1 overflow-hidden flex flex-col">
                <div class="border-b bg-white">
                    <div class="grid grid-cols-2">
                        <button type="button" data-tab-target="tools" class="tab-btn px-4 py-3 text-sm font-semibold text-slate-500 border-b-2 border-transparent focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400">Tools</button>
                        <button type="button" data-tab-target="quick-actions" class="tab-btn px-4 py-3 text-sm font-semibold text-slate-500 border-b-2 border-transparent focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400">Quick Actions</button>
                    </div>
                </div>
                <div class="flex-1 overflow-hidden relative">
                    <div id="tools-panel" data-tab-panel="tools" class="absolute inset-0 flex flex-col">
                        <div class="p-4 border-b text-slate-700">
                            <h2 class="text-lg font-bold">Tool Catalog</h2>
                            <p class="text-xs text-slate-500 mt-1">Browse the assistant's connected tools by category and trigger them instantly.</p>
                        </div>
                        <div id="tool-catalog" class="flex-1 p-4 space-y-5 overflow-y-auto bg-slate-50/40">
                            <div class="flex items-center justify-center h-full text-slate-400">
                                <i class="fa fa-spinner fa-spin mr-2"></i> Loading Tools...
                            </div>
                        </div>
                    </div>
                    <div id="quick-actions-panel" data-tab-panel="quick-actions" class="absolute inset-0 hidden flex flex-col">
                        <div class="p-4 border-b text-slate-700">
                            <h2 class="text-lg font-bold">Chillbreeze Quick Actions</h2>
                            <p class="text-xs text-slate-500 mt-1">Jump into ready-made prompts tailored to Chillbreeze lounges.</p>
                        </div>
                        <div id="quick-actions-list" class="flex-1 p-4 space-y-5 overflow-y-auto bg-slate-50/40"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-3"></div>

    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-bold">Settings</h3>
                <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="language-select" class="block text-sm font-medium text-slate-700 mb-1">Language for Voice</label>
                    <select id="language-select" class="w-full p-2 border rounded-md bg-white">
                        <option value="en-US">English (US)</option>
                        <option value="ta-IN">Tamil (India)</option>
                    </select>
                </div>
                <hr>
                <button id="save-settings-btn" class="w-full bg-orange-600 text-white font-semibold py-2 px-3 rounded-md hover:bg-orange-700">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toolCatalog = document.getElementById('tool-catalog');
            const chatHistory = document.getElementById('chat-history');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const attachBtn = document.getElementById('attach-btn');
            const fileInput = document.getElementById('file-input');
            const dragOverlay = document.getElementById('drag-overlay');
            const micBtn = document.getElementById('mic-btn');
            const ttsToggleBtn = document.getElementById('tts-toggle-btn');
            const toastContainer = document.getElementById('toast-container');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const languageSelect = document.getElementById('language-select');
            const quickActionsList = document.getElementById('quick-actions-list');
            const tabButtons = document.querySelectorAll('[data-tab-target]');
            const tabPanels = document.querySelectorAll('[data-tab-panel]');

            let tools = [];
            let voiceEnabled = false;
            let currentLang = 'en-US';
            let recognition;
            let speechSubmitting = false;

            const STORAGE_KEYS = {
                chat: 'qtick-chat-html',
                context: 'qtick-chat-context'
            };

            const conversationMemory = {
                contexts: {},
                contextOrder: [],
                lastAppointments: [],
                lastSlots: [],
                lastSlotsContextId: null,
                lastInvoice: null,
                lastInvoiceContextId: null,
                lastSelectedAppointment: null,
                lastSelectedContextId: null,
                lastCustomer: '',
                lastAnalytics: null,
                lastAction: null
            };

            const activeCharts = {};
            let contextCounter = 0;

            const activateTab = (targetId = 'tools') => {
                tabButtons.forEach(button => {
                    const isActive = button.dataset.tabTarget === targetId;
                    button.classList.toggle('tab-btn-active', isActive);
                    button.classList.toggle('text-orange-600', isActive);
                    button.classList.toggle('text-slate-500', !isActive);
                });
                tabPanels.forEach(panel => {
                    const matches = panel.dataset.tabPanel === targetId;
                    panel.classList.toggle('hidden', !matches);
                });
            };

            tabButtons.forEach(button => {
                button.addEventListener('click', () => activateTab(button.dataset.tabTarget));
            });

            const toolSchemas = {
                "find_appointment": { title: "Find Appointment", icon: "fa-calendar-check", category: "Scheduling" },
                "book_appointment": { title: "Book Appointment", icon: "fa-calendar-plus", category: "Scheduling" },
                "create_invoice": { title: "Create Invoice", icon: "fa-file-invoice-dollar", category: "Billing" },
                "send_sms": { title: "Send SMS/WhatsApp", icon: "fa-comment-sms", category: "Communication" },
                "schedule_task": { title: "Schedule Task", icon: "fa-clock", category: "Automation" },
                "lead_create": { title: "Create Lead", icon: "fa-user-plus", category: "Sales" }
            };

            const quickActionTemplates = [
                {
                    label: "Schedule overview",
                    promptTemplate: "List appointments scheduled at {location} for {timeRange}",
                    icon: "fa-calendar-days",
                    accent: "bg-orange-100 text-orange-600"
                },
                {
                    label: "Revenue snapshot",
                    promptTemplate: "Show a revenue summary for {location} for {timeRange}",
                    icon: "fa-file-invoice-dollar",
                    accent: "bg-emerald-100 text-emerald-600"
                },
                {
                    label: "Staff utilisation",
                    promptTemplate: "Summarize staff utilisation at {location} for {timeRange}",
                    icon: "fa-user-group",
                    accent: "bg-violet-100 text-violet-600"
                },
                {
                    label: "Customer feedback",
                    promptTemplate: "Share the latest customer feedback for {location} for {timeRange}",
                    icon: "fa-star",
                    accent: "bg-amber-100 text-amber-600"
                }
            ];

            const timeRangeOptions = [
                { value: "today", label: "Today" },
                { value: "this week", label: "This Week" },
                { value: "this month", label: "This Month" },
                { value: "last week", label: "Last Week" }
            ];

            const chillbreezeLocations = [
                {
                    id: 'chillbreeze-orchard',
                    name: 'Chillbreeze Orchard',
                    area: 'Orchard, Singapore',
                    focus: 'Flagship lounge with premium aromatherapy suites.',
                    metrics: {
                        appointments: 142,
                        occupancy: '89%',
                        satisfaction: '4.9 / 5'
                    }
                },
                {
                    id: 'chillbreeze-anna-nagar',
                    name: 'Chillbreeze Anna Nagar',
                    area: 'Anna Nagar, Chennai',
                    focus: 'Community-favourite spa for restorative therapies.',
                    metrics: {
                        appointments: 118,
                        occupancy: '82%',
                        satisfaction: '4.7 / 5'
                    }
                },
                {
                    id: 'chillbreeze-adayar',
                    name: 'Chillbreeze Adayar',
                    area: 'Adayar, Chennai',
                    focus: 'Beachside retreat specialising in detox rituals.',
                    metrics: {
                        appointments: 126,
                        occupancy: '85%',
                        satisfaction: '4.8 / 5'
                    }
                }
            ];

            let selectedQuickActionsLocationId = chillbreezeLocations[0]?.id || '';

            const api = {
                getTools: async () => {
                    await new Promise(r => setTimeout(r, 500));
                    return Object.keys(toolSchemas).map(name => ({
                        name,
                        description: `A tool to ${toolSchemas[name].title.toLowerCase()}.`
                    }));
                },
                runAgent: async (prompt) => {
                    const lowerCasePrompt = prompt.toLowerCase();

                    const mockResponses = {
                        appointmentList: {
                            output: "Here are the upcoming appointments I found.",
                            tool: "Appointment",
                            dataPoints: [
                                { status: "confirmed", appointmentId: "APT-001", queueNumber: "A01", businessId: 1003, customer: "Senthil", serviceId: 200, datetime: "2025-09-22T18:00:00+08:00" },
                                { status: "confirmed", appointmentId: "APT-002", queueNumber: "B02", businessId: 1003, customer: "Jane Doe", serviceId: 201, datetime: "2025-09-23T11:00:00+08:00" },
                                { status: "pending", appointmentId: "APT-003", queueNumber: "C03", businessId: 1003, customer: "John Smith", serviceId: 202, datetime: "2025-09-23T14:00:00+08:00" }
                            ]
                        },
                        appointmentSlots: {
                            output: "I found a few available slots for tomorrow.",
                            tool: "Appointment",
                            dataPoints: [
                                { status: "available", appointmentId: "SLOT-100", queueNumber: "-", businessId: 1003, customer: "", serviceId: 301, datetime: "2025-09-22T10:00:00+08:00" },
                                { status: "available", appointmentId: "SLOT-101", queueNumber: "-", businessId: 1003, customer: "", serviceId: 302, datetime: "2025-09-22T14:30:00+08:00" },
                                { status: "available", appointmentId: "SLOT-102", queueNumber: "-", businessId: 1003, customer: "", serviceId: 303, datetime: "2025-09-22T16:00:00+08:00" }
                            ]
                        },
                        invoice: {
                            output: "Invoice INV-00001 for Alex has been created successfully. The total amount is 52.0 SGD. You can pay via this link: https://pay.qtick.co/INV-00001",
                            tool: "Invoice",
                            dataPoints: [
                                {
                                    invoiceId: "INV-00001",
                                    total: 52.0,
                                    currency: "SGD",
                                    status: "created",
                                    createdAt: "2025-09-21T06:22:15.421334+00:00",
                                    paymentLink: "https://pay.qtick.co/INV-00001",
                                    items: [
                                        { description: "Haircut", quantity: 1, unitPrice: 25, taxRate: 0.08 },
                                        { description: "Hair serum", quantity: 2, unitPrice: 12.5 }
                                    ],
                                    customer: "Alex",
                                    businessId: 123
                                }
                            ]
                        },
                        analyticsReport: {
                            output: "Here's the latest performance summary for the business.",
                            tool: "Analytics",
                            dataPoints: [
                                { metric: "Revenue", value: 18250, currency: "SGD", change: 12 },
                                { metric: "Completed Appointments", value: 42, change: 6 },
                                { metric: "No-Show Rate", value: 3.2, suffix: "%", change: -1.2 }
                            ],
                            insights: [
                                "Revenue is up 12% compared to the previous week.",
                                "Color treatments generated the highest revenue share at 38%.",
                                "Saturday remains the busiest day with 14 confirmed appointments."
                            ],
                            chart: {
                                type: 'line',
                                data: {
                                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                                    datasets: [
                                        {
                                            label: 'Revenue (SGD)',
                                            data: [3200, 2800, 3400, 4200, 3600, 3900, 3050],
                                            borderColor: '#f97316',
                                            backgroundColor: 'rgba(249, 115, 22, 0.15)',
                                            fill: true,
                                            tension: 0.4,
                                            yAxisID: 'y'
                                        },
                                        {
                                            label: 'Appointments',
                                            data: [12, 9, 11, 15, 13, 14, 10],
                                            borderColor: '#6366f1',
                                            backgroundColor: 'rgba(99, 102, 241, 0.15)',
                                            fill: false,
                                            tension: 0.3,
                                            yAxisID: 'y1'
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    interaction: { mode: 'index', intersect: false },
                                    plugins: {
                                        legend: { display: true },
                                        tooltip: { enabled: true }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            title: { display: true, text: 'Revenue (SGD)' }
                                        },
                                        y1: {
                                            beginAtZero: true,
                                            position: 'right',
                                            grid: { drawOnChartArea: false },
                                            title: { display: true, text: 'Appointments' }
                                        }
                                    }
                                }
                            },
                            chartMeta: { range: 'Last 7 days' }
                        },
                        leadsSummary: {
                            output: "Here's how many new leads were created this week.",
                            tool: "Analytics",
                            dataPoints: [
                                { metric: "New Leads", value: 28, change: 8 },
                                { metric: "Follow-ups Scheduled", value: 19, change: 5 },
                                { metric: "Lead-to-Customer", value: 32, suffix: "%", change: 2 }
                            ],
                            insights: [
                                "Social media campaigns contributed 45% of new leads.",
                                "Wednesday saw the highest conversions at 7 customers.",
                                "Average response time dropped to 1h 45m (12% faster)."
                            ],
                            chart: {
                                type: 'bar',
                                data: {
                                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                                    datasets: [
                                        {
                                            label: 'New Leads',
                                            data: [3, 4, 6, 5, 4, 3, 3],
                                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                            borderRadius: 8
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    plugins: {
                                        legend: { display: false }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            title: { display: true, text: 'Leads' }
                                        }
                                    }
                                }
                            },
                            chartMeta: { range: 'This week' }
                        },
                        fallback: {
                            output: "I'm ready when you are! How can I help today?",
                            tool: null,
                            dataPoints: []
                        }
                    };

                    let fallbackKey = null;
                    if (lowerCasePrompt.includes("list appointment")) {
                        fallbackKey = "appointmentList";
                    } else if (lowerCasePrompt.includes("available appointment") || lowerCasePrompt.includes("available slot")) {
                        fallbackKey = "appointmentSlots";
                    } else if (lowerCasePrompt.includes("invoice")) {
                        fallbackKey = "invoice";
                    } else if (lowerCasePrompt.includes("performance report") || lowerCasePrompt.includes("business report")) {
                        fallbackKey = "analyticsReport";
                    } else if (lowerCasePrompt.includes("leads") && (lowerCasePrompt.includes("week") || lowerCasePrompt.includes("this week"))) {
                        fallbackKey = "leadsSummary";
                    }

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000);

                    try {
                        const response = await fetch("https://qtick-mcp.onrender.com/agent/run", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: prompt }),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            try {
                                const errorBody = await response.json();
                                if (errorBody && errorBody.detail) {
                                    throw new Error(errorBody.detail);
                                }
                            } catch (e) {
                                throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                            }
                        }
                        return await response.json();
                    } catch (error) {
                        clearTimeout(timeoutId);
                        if (error.name === 'AbortError') {
                            throw new Error("Request timed out. The server might be starting up, please try again in a moment.");
                        }
                        if (fallbackKey && mockResponses[fallbackKey]) {
                            showToast("Live data unavailable, showing sample data instead.", true);
                            return mockResponses[fallbackKey];
                        }
                        throw error;
                    }
                }
            };
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            function setupRecognition(lang) {
                if (!SpeechRecognition) {
                    micBtn.disabled = true;
                    micBtn.title = "Speech recognition not supported in this browser.";
                    return;
                }
                recognition = new SpeechRecognition();
                recognition.lang = lang;
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    micBtn.classList.add('listening', 'bg-red-500');
                    micBtn.classList.remove('bg-orange-500');
                };
                recognition.onend = () => {
                    micBtn.classList.remove('listening', 'bg-red-500');
                    micBtn.classList.add('bg-orange-500');
                };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.trim();
                    if (!transcript) return;
                    speechSubmitting = true;
                    chatInput.value = transcript;
                    chatForm.dispatchEvent(new Event('submit', { bubbles: true }));
                };
                recognition.onerror = (event) => showToast(`Speech recognition error: ${event.error}`, true);
            }

            const synth = window.speechSynthesis;
            let voices = [];

            function populateVoiceList() {
                voices = synth.getVoices();
            }
            populateVoiceList();
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = populateVoiceList;

            function speak(text, lang) {
                if (!voiceEnabled || !synth.speak || !text) return;
                synth.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                const voice = voices.find(v => v.lang === lang) || voices.find(v => v.lang && v.lang.startsWith(lang.split('-')[0]));
                if (voice) utterance.voice = voice;
                utterance.lang = lang;
                synth.speak(utterance);
            }

            micBtn.addEventListener('click', () => {
                if (recognition && !micBtn.classList.contains('listening')) {
                    try {
                        recognition.start();
                    } catch (e) {
                        showToast('Speech recognition already started.', true);
                    }
                }
            });

            ttsToggleBtn.addEventListener('click', () => {
                voiceEnabled = !voiceEnabled;
                ttsToggleBtn.innerHTML = voiceEnabled ? '<i class="fa-solid fa-volume-high text-orange-600"></i>' : '<i class="fa-solid fa-volume-xmark"></i>';
                showToast(voiceEnabled ? "Voice responses enabled" : "Voice responses disabled");
                if (!voiceEnabled) synth.cancel();
            });

            attachBtn.addEventListener('click', () => fileInput.click());

            function showToast(message, isError = false) {
                const toast = document.createElement('div');
                toast.className = `toast transform translate-x-full opacity-0 p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-slate-800'}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.remove('translate-x-full', 'opacity-0'), 10);
                setTimeout(() => {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }
            function createContextId(prefix) {
                contextCounter += 1;
                return `${prefix}-${Date.now()}-${contextCounter}`;
            }

            function cloneData(data) {
                try {
                    return JSON.parse(JSON.stringify(data));
                } catch (error) {
                    return data;
                }
            }

            function saveChatState() {
                if (typeof localStorage === 'undefined') return;
                try {
                    localStorage.setItem(STORAGE_KEYS.chat, chatHistory.innerHTML);
                    localStorage.setItem(STORAGE_KEYS.context, JSON.stringify({
                        contexts: conversationMemory.contexts,
                        contextOrder: conversationMemory.contextOrder,
                        lastAppointments: conversationMemory.lastAppointments,
                        lastSlots: conversationMemory.lastSlots,
                        lastSlotsContextId: conversationMemory.lastSlotsContextId,
                        lastInvoice: conversationMemory.lastInvoice,
                        lastInvoiceContextId: conversationMemory.lastInvoiceContextId,
                        lastSelectedAppointment: conversationMemory.lastSelectedAppointment,
                        lastSelectedContextId: conversationMemory.lastSelectedContextId,
                        lastCustomer: conversationMemory.lastCustomer,
                        lastAnalytics: conversationMemory.lastAnalytics,
                        lastAction: conversationMemory.lastAction
                    }));
                } catch (error) {
                    console.warn('Unable to persist chat history', error);
                }
            }

            function restoreChatState() {
                if (typeof localStorage === 'undefined') return;
                try {
                    const savedHTML = localStorage.getItem(STORAGE_KEYS.chat);
                    if (savedHTML) {
                        chatHistory.innerHTML = savedHTML;
                    }
                    const savedContext = localStorage.getItem(STORAGE_KEYS.context);
                    if (savedContext) {
                        const parsed = JSON.parse(savedContext);
                        if (parsed && typeof parsed === 'object') {
                            conversationMemory.contexts = parsed.contexts || {};
                            conversationMemory.contextOrder = parsed.contextOrder || [];
                            conversationMemory.lastAppointments = parsed.lastAppointments || [];
                            conversationMemory.lastSlots = parsed.lastSlots || [];
                            conversationMemory.lastSlotsContextId = parsed.lastSlotsContextId || null;
                            conversationMemory.lastInvoice = parsed.lastInvoice || null;
                            conversationMemory.lastInvoiceContextId = parsed.lastInvoiceContextId || null;
                            conversationMemory.lastSelectedAppointment = parsed.lastSelectedAppointment || null;
                            conversationMemory.lastSelectedContextId = parsed.lastSelectedContextId || null;
                            conversationMemory.lastCustomer = parsed.lastCustomer || '';
                            conversationMemory.lastAnalytics = parsed.lastAnalytics || null;
                            conversationMemory.lastAction = parsed.lastAction || null;
                        }
                    }
                } catch (error) {
                    console.warn('Unable to restore chat history', error);
                }
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            window.addEventListener('beforeunload', saveChatState);

            function getContextById(id) {
                if (!id) return null;
                return conversationMemory.contexts[id] || null;
            }

            function getLatestContextByType(type) {
                for (let i = conversationMemory.contextOrder.length - 1; i >= 0; i -= 1) {
                    const contextId = conversationMemory.contextOrder[i];
                    const context = conversationMemory.contexts[contextId];
                    if (context && context.type === type) {
                        return { id: contextId, data: context.data };
                    }
                }
                return null;
            }

            function updateLastCustomerFromAppointment(record) {
                if (!record) return;
                const candidate = record.customer || record.name || record.contactName;
                if (candidate && typeof candidate === 'string') {
                    conversationMemory.lastCustomer = candidate;
                }
            }

            function registerContext(context) {
                if (!context || !context.id) return;
                const cloned = cloneData(context.data);
                conversationMemory.contexts[context.id] = { type: context.type, data: cloned };
                conversationMemory.contextOrder = conversationMemory.contextOrder.filter(existing => existing !== context.id);
                conversationMemory.contextOrder.push(context.id);

                if (context.type === 'appointments') {
                    conversationMemory.lastAppointments = Array.isArray(cloned) ? cloned : [];
                    const last = conversationMemory.lastAppointments[conversationMemory.lastAppointments.length - 1];
                    if (last) updateLastCustomerFromAppointment(last);
                } else if (context.type === 'slots') {
                    conversationMemory.lastSlots = Array.isArray(cloned) ? cloned : [];
                    conversationMemory.lastSlotsContextId = context.id;
                } else if (context.type === 'invoice') {
                    conversationMemory.lastInvoice = cloned;
                    conversationMemory.lastInvoiceContextId = context.id;
                } else if (context.type === 'analytics') {
                    conversationMemory.lastAnalytics = cloned;
                }

                saveChatState();
            }

            function bootstrapCharts(root = document) {
                if (typeof Chart === 'undefined') return;
                const canvases = root.querySelectorAll('canvas[data-chart-config]');
                canvases.forEach(canvas => {
                    if (canvas.dataset.chartInitialized === 'true') return;
                    try {
                        const config = JSON.parse(canvas.dataset.chartConfig);
                        const chart = new Chart(canvas.getContext('2d'), config);
                        const key = canvas.id || `chart-${Date.now()}-${Math.random().toString(16).slice(2)}`;
                        activeCharts[key] = chart;
                        canvas.dataset.chartInitialized = 'true';
                    } catch (error) {
                        console.error('Failed to render chart', error);
                    }
                });
            }

            const render = {
                addMessageToChat: (content, isUser = false, options = {}) => {
                    const id = `msg-${Date.now()}-${Math.random().toString(16).slice(2)}`;
                    const messageWrapper = document.createElement('div');
                    messageWrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'} w-full`;
                    const message = document.createElement('div');
                    message.id = id;
                    message.dataset.rich = options.isRich ? 'true' : 'false';
                    message.dataset.fullWidth = !isUser && options.fullWidth ? 'true' : 'false';
                    message.classList.add('rounded-lg');
                    if (!isUser && options.fullWidth) {
                        message.classList.add('w-full', 'max-w-3xl');
                    } else {
                        message.classList.add('max-w-md');
                    }
                    if (isUser) {
                        message.classList.add('bg-orange-600', 'text-white', 'p-3', 'shadow-sm');
                    } else if (!options.isRich) {
                        message.classList.add('bg-slate-200', 'text-slate-800', 'p-3');
                    }
                    message.innerHTML = content;
                    messageWrapper.appendChild(message);
                    chatHistory.appendChild(messageWrapper);
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    saveChatState();
                    return id;
                },
                removeMessage: (id) => {
                    const msg = document.getElementById(id);
                    if (msg) {
                        const wrapper = msg.parentElement;
                        if (wrapper) wrapper.remove();
                        else msg.remove();
                        saveChatState();
                    }
                },
                updateMessage: (id, newContent, isRich = false) => {
                    const msg = document.getElementById(id);
                    if (msg) {
                        msg.innerHTML = newContent;
                        msg.dataset.rich = isRich ? 'true' : 'false';
                        if (isRich) {
                            msg.classList.remove('bg-slate-200', 'text-slate-800', 'p-3');
                            if (msg.dataset.fullWidth === 'true') {
                                msg.classList.add('w-full', 'max-w-3xl');
                                msg.classList.remove('max-w-md');
                            }
                        } else {
                            msg.classList.add('bg-slate-200', 'text-slate-800', 'p-3');
                            if (msg.dataset.fullWidth === 'true') {
                                msg.classList.add('w-full', 'max-w-3xl');
                                msg.classList.remove('max-w-md');
                            }
                        }
                        saveChatState();
                    }
                    return msg;
                },
                tools: () => {
                    const groupedTools = tools.reduce((acc, tool) => {
                        const schema = toolSchemas[tool.name];
                        if (!schema) return acc;
                        (acc[schema.category] = acc[schema.category] || []).push(tool);
                        return acc;
                    }, {});
                    toolCatalog.innerHTML = `
                        <div class="flex flex-col gap-6">
                            ${Object.entries(groupedTools).map(([category, toolList]) => `
                                <section class="rounded-3xl border border-slate-200/70 bg-white/80 p-6 shadow-sm backdrop-blur">
                                    <div class="flex flex-col gap-2">
                                        <span class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-orange-500/80">
                                            <i class="fa-solid fa-layer-group"></i>
                                            ${category}
                                        </span>
                                        <h3 class="text-lg font-semibold text-slate-800">Curated tools for ${category.toLowerCase()} excellence</h3>
                                        <p class="text-sm text-slate-500">Explore beautifully organised actions that keep your team moving fast.</p>
                                    </div>
                                    <div class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3">
                                        ${toolList.map(tool => {
                                            const schema = toolSchemas[tool.name];
                                            const safeDescription = escapeAttribute(tool.description || '');
                                            const safeTitle = escapeAttribute(schema.title || 'Tool');
                                            const safeTitleToken = escapeAttribute((schema.title || '').split(' ')[0] || 'Tool');
                                            return `<button type="button" data-example="${tool.name}" class="tool-item group relative w-full rounded-3xl border border-slate-200/70 bg-white/90 p-6 text-left shadow-sm transition duration-200 hover:-translate-y-1 hover:border-orange-300 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-orange-500/60">
                                                <div class="absolute inset-0 bg-gradient-to-br from-orange-500/10 via-transparent to-slate-100 opacity-0 transition duration-200 group-hover:opacity-100"></div>
                                                <div class="relative flex min-h-[220px] flex-col gap-6">
                                                    <div class="flex items-center justify-between gap-4">
                                                        <span class="inline-flex items-center gap-2 rounded-full border border-orange-500/20 bg-orange-500/10 px-3 py-1 text-[11px] font-medium text-orange-600">
                                                            <i class="fa-solid ${schema.icon}"></i>
                                                            ${safeTitleToken}
                                                        </span>
                                                        <span class="flex h-10 w-10 items-center justify-center rounded-full border border-slate-200/60 bg-white text-slate-400 transition group-hover:border-orange-200 group-hover:text-orange-500">
                                                            <i class="fa-solid fa-bolt"></i>
                                                        </span>
                                                    </div>
                                                    <div class="space-y-2">
                                                        <h4 class="text-lg font-semibold text-slate-800 transition group-hover:text-orange-600">${safeTitle}</h4>
                                                        <p class="text-sm leading-relaxed text-slate-500">${safeDescription}</p>
                                                    </div>
                                                    <div class="mt-auto flex items-center justify-between text-xs font-medium text-slate-400 transition group-hover:text-orange-50">
                                                        <span class="inline-flex items-center gap-2">
                                                            <i class="fa-regular fa-circle-dot"></i>
                                                            Built for ${category.toLowerCase()}
                                                        </span>
                                                        <span class="inline-flex items-center gap-2 text-sm font-semibold text-orange-500 transition group-hover:text-white">
                                                            Launch
                                                            <i class="fa-solid fa-arrow-up-right-from-square"></i>
                                                        </span>
                                                    </div>
                                                </div>
                                            </button>`;
                                        }).join('')}
                                    </div>
                                </section>
                            `).join('')}
                        </div>
                    `;
                    toolCatalog.querySelectorAll('.tool-item').forEach(item => item.addEventListener('click', () => {
                        chatInput.value = item.dataset.example;
                        chatInput.focus();
                    }));
                },
                quickActions: () => {
                    if (!quickActionsList) return;

                    const selectedLocation = chillbreezeLocations.find(location => location.id === selectedQuickActionsLocationId) || chillbreezeLocations[0];

                    if (!selectedLocation) {
                        quickActionsList.innerHTML = `
                            <div class="flex h-full items-center justify-center rounded-2xl border border-dashed border-slate-300 bg-white/80 p-6 text-sm text-slate-500">
                                No businesses available right now.
                            </div>
                        `;
                        return;
                    }

                    const businessOptions = chillbreezeLocations.map(location => `
                        <option value="${escapeAttribute(location.id)}">${escapeAttribute(location.name)}</option>
                    `).join('');

                    const actionCards = quickActionTemplates.map(action => `
                        <div class="quick-action-card group w-full rounded-2xl border border-slate-200/80 bg-white px-5 py-5 shadow-sm transition hover:-translate-y-0.5 hover:border-orange-300 hover:shadow-lg" role="button" tabindex="0" data-template="${escapeAttribute(action.promptTemplate)}">
                            <div class="flex items-start gap-4">
                                <div class="h-12 w-12 rounded-xl flex items-center justify-center ${action.accent}">
                                    <i class="fa-solid ${action.icon} text-lg"></i>
                                </div>
                                <div class="flex-1 space-y-2">
                                    <p class="text-base font-semibold text-slate-800">${escapeAttribute(action.label)}</p>
                                    <p class="text-xs text-slate-500">${escapeAttribute(selectedLocation.name)}</p>
                                </div>
                                <i class="fa-solid fa-arrow-up-right-from-square text-slate-300 transition group-hover:text-orange-500"></i>
                            </div>
                            <div class="mt-6 flex items-center justify-between gap-3">
                                <div class="flex items-center gap-2 text-[11px] font-medium text-slate-500">
                                    <i class="fa-regular fa-calendar"></i>
                                    <span>Time range</span>
                                </div>
                                <select class="time-range-select rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-medium text-slate-700 focus:border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-200/70" data-range-select>
                                    ${timeRangeOptions.map((option, index) => `
                                        <option value="${escapeAttribute(option.value)}" ${index === 0 ? 'selected' : ''}>${escapeAttribute(option.label)}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    `).join('');

                    quickActionsList.innerHTML = `
                        <div class="flex flex-col gap-6">
                            <section class="rounded-2xl border border-slate-200/80 bg-white/90 p-6 shadow-sm backdrop-blur">
                                <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
                                    <div class="space-y-1">
                                        <h3 class="text-base font-semibold text-slate-700">Business spotlight</h3>
                                        <p class="text-xs text-slate-500">Switch lounges to tailor these ready-made prompts.</p>
                                    </div>
                                    <div class="sm:w-64">
                                        <label for="business-select" class="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500">Business</label>
                                        <select id="business-select" class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-200/70">
                                            ${businessOptions}
                                        </select>
                                    </div>
                                </div>
                                <p class="mt-4 text-xs text-slate-500">${escapeAttribute(selectedLocation.focus)}</p>
                                <div class="mt-5 flex flex-col gap-4 rounded-xl bg-slate-50 px-4 py-4 text-slate-600 sm:flex-row sm:items-center sm:justify-between">
                                    <div class="flex items-center gap-3">
                                        <span class="flex h-10 w-10 items-center justify-center rounded-full bg-orange-500/10 text-orange-500">
                                            <i class="fa-solid fa-location-dot"></i>
                                        </span>
                                        <div>
                                            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Located in</p>
                                            <p class="text-sm font-semibold text-slate-800">${escapeAttribute(selectedLocation.area)}</p>
                                        </div>
                                    </div>
                                    <p class="text-xs text-slate-500 sm:text-right">Tailor these prompts for ${escapeAttribute(selectedLocation.name)}.</p>
                                </div>
                            </section>
                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                ${actionCards}
                            </div>
                        </div>
                    `;

                    const businessSelect = quickActionsList.querySelector('#business-select');
                    if (businessSelect) {
                        businessSelect.value = selectedLocation.id;
                        businessSelect.addEventListener('change', (event) => {
                            selectedQuickActionsLocationId = event.target.value;
                            render.quickActions();
                        });
                    }
                }
            };
            if (quickActionsList) {
                const handleQuickAction = (card) => {
                    if (!card) return;
                    const promptTemplate = card.dataset.template;
                    if (!promptTemplate) return;

                    const businessSelect = quickActionsList.querySelector('#business-select');
                    const selectedLocationId = businessSelect ? businessSelect.value : (chillbreezeLocations[0]?.id || '');
                    const selectedLocation = chillbreezeLocations.find(location => location.id === selectedLocationId) || chillbreezeLocations[0];
                    const rangeSelect = card.querySelector('[data-range-select]');
                    const selectedRange = rangeSelect ? rangeSelect.value : timeRangeOptions[0]?.value || 'today';

                    const prompt = promptTemplate
                        .replace(/\{location\}/g, selectedLocation ? selectedLocation.name : 'the business')
                        .replace(/\{timeRange\}/g, selectedRange);

                    chatInput.value = prompt;
                    chatInput.focus();
                    chatForm.dispatchEvent(new Event('submit', { bubbles: true }));
                };

                quickActionsList.addEventListener('click', (event) => {
                    if (event.target.closest('select')) return;
                    const card = event.target.closest('.quick-action-card[data-template]');
                    handleQuickAction(card);
                });

                quickActionsList.addEventListener('keydown', (event) => {
                    if (event.target.closest('select')) return;
                    if (event.key !== 'Enter' && event.key !== ' ') return;
                    const card = event.target.closest('.quick-action-card[data-template]');
                    if (!card) return;
                    event.preventDefault();
                    handleQuickAction(card);
                });
            }

            function formatTextContent(text) {
                if (!text) return '';
                const escaped = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>');
                return escaped.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="text-orange-600 underline">$1</a>');
            }

            function formatCurrency(value, currency) {
                if (value === null || value === undefined || value === '') return '-';
                const num = Number(value);
                if (!Number.isFinite(num)) return `${value}${currency ? ` ${currency}` : ''}`;
                if (currency) {
                    try {
                        return new Intl.NumberFormat(undefined, { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
                    } catch (error) {
                        return `${num.toFixed(2)} ${currency}`;
                    }
                }
                return num.toFixed(2);
            }

            function formatDateTime(value) {
                if (!value) return '-';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return value;
                return date.toLocaleString();
            }

            function escapeAttribute(value) {
                if (value === null || value === undefined) return '';
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }

            function getLeadName(record) {
                if (!record || typeof record !== 'object') return '-';
                const nameParts = [];
                if (record.firstName) nameParts.push(String(record.firstName).trim());
                if (record.lastName) nameParts.push(String(record.lastName).trim());
                const combined = nameParts.filter(Boolean).join(' ').trim();
                if (combined) return combined;
                const candidateKeys = ['name', 'customerName', 'leadName', 'customer', 'contactName', 'fullName'];
                for (const key of candidateKeys) {
                    const value = record[key];
                    if (value !== null && value !== undefined) {
                        const text = String(value).trim();
                        if (text) return text;
                    }
                }
                return '-';
            }

            function formatSlotDisplay(value) {
                if (!value) {
                    return { displayDate: '', displayTime: '', iso: value };
                }
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return { displayDate: value, displayTime: '', iso: value };
                }
                return {
                    displayDate: date.toLocaleDateString(undefined, {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    }),
                    displayTime: date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }),
                    iso: value
                };
            }

            function formatMetricValue(point) {
                if (!point) return '-';
                const { value, currency, suffix, prefix } = point;
                if (value === null || value === undefined) return '-';
                if (currency) return formatCurrency(value, currency);
                if (prefix) return `${prefix}${value}`;
                if (suffix) return `${value}${suffix}`;
                if (typeof value === 'number' && Number.isFinite(value)) return value.toLocaleString();
                return value;
            }

            function formatChange(change) {
                if (change === null || change === undefined || change === '') return '';
                const value = Number(change);
                if (!Number.isFinite(value)) return change;
                const arrow = value >= 0 ? '' : '';
                const formatted = Math.abs(value) < 1 ? Math.abs(value).toFixed(1) : Math.abs(value).toFixed(0);
                return `${arrow} ${formatted}%`;
            }

            function appointmentActionButtons(contextId, index) {
                const actions = [
                    { action: 'send-reminder', label: 'Send Reminder', icon: 'fa-bell' },
                    { action: 'reschedule', label: 'Reschedule', icon: 'fa-calendar-pen' },
                    { action: 'view-history', label: 'View Customer History', icon: 'fa-user-clock' }
                ];
                return `
                    <div class="flex flex-wrap gap-2">
                        ${actions.map(item => `
                            <button type="button" class="appointment-action-btn inline-flex items-center gap-2 rounded-md bg-white border border-slate-200 px-3 py-2 text-sm font-medium text-slate-600 hover:border-orange-300 hover:text-orange-600" data-appointment-action="${item.action}" data-context-id="${contextId || ''}" data-index="${index}">
                                <i class="fa-solid ${item.icon}"></i>
                                ${item.label}
                            </button>
                        `).join('')}
                    </div>
                `;
            }
            function buildToolDisplay(response) {
                if (!response) return null;
                const dataPoints = Array.isArray(response.dataPoints)
                    ? response.dataPoints
                    : response.dataPoints
                        ? [response.dataPoints]
                        : [];
                const normalizedTool = String(response.tool || '').toLowerCase();

                const builders = {
                    invoice: (records) => {
                        const invoice = records[0] || {};
                        const contextId = createContextId('invoice');
                        const currency = invoice.currency;
                        const items = Array.isArray(invoice.items) ? invoice.items.map(item => `
                            <tr>
                                <td class="py-2 text-sm text-slate-600">${item.description || '-'}</td>
                                <td class="py-2 text-sm text-center text-slate-600">${item.quantity ?? 1}</td>
                                <td class="py-2 text-sm text-right text-slate-600">${item.unitPrice !== undefined ? formatCurrency(item.unitPrice, currency) : '-'}</td>
                                <td class="py-2 text-sm text-right text-slate-600">${item.taxRate !== undefined ? `${Math.round(item.taxRate * 100)}%` : '-'}</td>
                                <td class="py-2 text-sm text-right text-slate-600">${item.unitPrice !== undefined ? formatCurrency((item.quantity ?? 1) * item.unitPrice, currency) : '-'}</td>
                            </tr>
                        `).join('') : '';

                        const markup = `
                            <div class="chat-response-container space-y-4" data-context-id="${contextId}" data-context-type="invoice">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                    <div>
                                        <h4>Invoice ${invoice.invoiceId || ''}</h4>
                                        <p class="text-sm text-slate-500">Customer: ${invoice.customer || '-'}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs uppercase text-slate-500">Total Due</p>
                                        <p class="text-2xl font-bold text-orange-600">${formatCurrency(invoice.total, currency)}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 text-sm text-slate-600">
                                    <div><span class="block font-semibold text-slate-700">Status</span>${invoice.status || '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Created</span>${invoice.createdAt ? new Date(invoice.createdAt).toLocaleString() : '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Business ID</span>${invoice.businessId ?? '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Payment Link</span>${invoice.paymentLink ? `<a href="${invoice.paymentLink}" target="_blank" class="text-orange-600 underline break-all">Pay now</a>` : '-'}</div>
                                </div>
                                ${items ? `
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full text-left">
                                            <thead>
                                                <tr class="text-xs uppercase tracking-wide text-slate-500">
                                                    <th class="pb-2">Description</th>
                                                    <th class="pb-2 text-center">Qty</th>
                                                    <th class="pb-2 text-right">Unit Price</th>
                                                    <th class="pb-2 text-right">Tax</th>
                                                    <th class="pb-2 text-right">Line Total</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-200">${items}</tbody>
                                        </table>
                                    </div>
                                ` : ''}
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" class="invoice-action-btn inline-flex items-center gap-2 rounded-md bg-orange-50 border border-orange-200 px-3 py-2 text-sm font-medium text-orange-600 hover:bg-orange-100" data-invoice-action="send-whatsapp" data-context-id="${contextId}">
                                        <i class="fa-solid fa-paper-plane"></i>
                                        Send to Customer via WhatsApp
                                    </button>
                                    <button type="button" class="invoice-action-btn inline-flex items-center gap-2 rounded-md bg-slate-100 border border-slate-300 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200" data-invoice-action="mark-paid" data-context-id="${contextId}">
                                        <i class="fa-solid fa-circle-check"></i>
                                        Mark as Paid
                                    </button>
                                </div>
                            </div>
                        `;

                        return {
                            markup,
                            contexts: [{ id: contextId, type: 'invoice', data: invoice }],
                            renderOptions: { isRich: true, fullWidth: true }
                        };
                    },
                    appointment: (records) => {
                        if (!records.length) return null;
                        const allAvailable = records.every(record => String(record.status || '').toLowerCase() === 'available');
                        if (allAvailable) {
                            const contextId = createContextId('slots');
                            const normalizedSlots = records.map(record => {
                                const display = formatSlotDisplay(record.datetime || record.iso || record.slot || record);
                                return {
                                    iso: display.iso,
                                    displayDate: display.displayDate,
                                    displayTime: display.displayTime,
                                    serviceId: record.serviceId,
                                    businessId: record.businessId,
                                    customer: record.customer || ''
                                };
                            });
                            const cards = normalizedSlots.map((slot, index) => `
                                <button type="button" class="available-slot-card border border-slate-200 rounded-lg p-3 text-left bg-slate-50 hover:bg-orange-50 hover:border-orange-200 transition flex flex-col gap-1" data-context-id="${contextId}" data-index="${index}" data-slot="${escapeAttribute(slot.iso)}" data-customer="${escapeAttribute(slot.customer)}">
                                    <span class="text-sm font-semibold text-slate-700">${slot.displayTime || slot.displayDate || 'Slot'}</span>
                                    ${slot.displayDate ? `<span class="text-xs text-slate-500">${slot.displayDate}</span>` : ''}
                                </button>
                            `).join('');
                            const markup = `
                                <div class="chat-response-container space-y-3" data-context-id="${contextId}" data-context-type="slots">
                                    <div class="flex items-center justify-between">
                                        <h4>Available Slots</h4>
                                        <span class="text-xs px-2 py-1 bg-slate-100 text-slate-500 rounded-full">${normalizedSlots.length} options</span>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                        ${cards}
                                    </div>
                                    <p class="text-xs text-slate-500">Click a slot to populate a booking command automatically.</p>
                                </div>
                            `;
                            return {
                                markup,
                                contexts: [{ id: contextId, type: 'slots', data: normalizedSlots }],
                                renderOptions: { isRich: true, fullWidth: true }
                            };
                        }

                        if (records.length > 1) {
                            const contextId = createContextId('appointments');
                            const rows = records.map((record, index) => `
                                <tr class="appointment-row" data-context-id="${contextId}" data-index="${index}">
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.appointmentId || record.queueNumber || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.customer || record.name || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.serviceId ?? '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${formatDateTime(record.datetime)}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700 capitalize">${record.status || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.queueNumber || '-'}</td>
                                </tr>
                            `).join('');
                            const markup = `
                                <div class="chat-response-container space-y-4 appointments-wrapper" data-context-id="${contextId}" data-context-type="appointments">
                                    <h4>Appointments</h4>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full">
                                            <thead>
                                                <tr>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">ID</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Customer</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Service</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Date & Time</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Status</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Queue</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-200">${rows}</tbody>
                                        </table>
                                    </div>
                                    <div class="appointment-action-panel border border-dashed border-orange-200 rounded-lg p-3 bg-orange-50 text-sm text-orange-700" data-action-panel="${contextId}">
                                        Tap a row to reveal quick actions.
                                    </div>
                                </div>
                            `;
                            return {
                                markup,
                                contexts: [{ id: contextId, type: 'appointments', data: records }],
                                renderOptions: { isRich: true, fullWidth: true }
                            };
                        }

                        const appointment = records[0];
                        const contextId = createContextId('appointments');
                        const detailRows = [
                            { label: 'Customer', value: appointment.customer || appointment.name || '-' },
                            { label: 'Status', value: appointment.status || '-' },
                            { label: 'Date & Time', value: formatDateTime(appointment.datetime) },
                            { label: 'Queue Number', value: appointment.queueNumber || '-' },
                            { label: 'Service ID', value: appointment.serviceId ?? '-' },
                            { label: 'Business ID', value: appointment.businessId ?? '-' }
                        ];
                        const statusMessage = appointment.message
                            ? `<p class="text-sm text-slate-600 bg-orange-50 border border-orange-200 p-3 rounded-md">${appointment.message}</p>`
                            : '';

                        const suggestedSlots = Array.isArray(appointment.suggestedSlots) ? appointment.suggestedSlots.filter(Boolean) : [];
                        let slotContextId = null;
                        let suggestedSlotsMarkup = '';
                        if (suggestedSlots.length) {
                            slotContextId = createContextId('slots');
                            const normalizedSlots = suggestedSlots.map(slot => {
                                const display = formatSlotDisplay(slot);
                                return {
                                    iso: display.iso,
                                    displayDate: display.displayDate,
                                    displayTime: display.displayTime,
                                    serviceId: appointment.serviceId,
                                    businessId: appointment.businessId,
                                    customer: appointment.customer || appointment.name || ''
                                };
                            });
                            suggestedSlotsMarkup = `
                                <div class="space-y-2" data-context-id="${slotContextId}" data-context-type="slots">
                                    <h5 class="font-semibold text-slate-700">Available times</h5>
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                        ${normalizedSlots.map((slot, index) => `
                                            <button type="button" class="suggested-slot-card border border-slate-200 rounded-lg p-3 text-left bg-slate-50 hover:bg-orange-50 hover:border-orange-200 transition flex flex-col gap-1" data-slot="${escapeAttribute(slot.iso)}" data-customer="${escapeAttribute(slot.customer)}" data-context-id="${slotContextId}" data-index="${index}">
                                                <span class="text-sm font-semibold text-slate-700">${slot.displayTime || slot.displayDate || 'Slot'}</span>
                                                ${slot.displayDate ? `<span class="text-xs text-slate-500">${slot.displayDate}</span>` : ''}
                                            </button>
                                        `).join('')}
                                    </div>
                                    <p class="text-xs text-slate-500">Select a time to update your request.</p>
                                </div>
                            `;
                            return {
                                markup: `
                                    <div class="chat-response-container space-y-4" data-context-id="${contextId}" data-context-type="appointments">
                                        <h4>Appointment ${appointment.appointmentId || appointment.queueNumber || ''}</h4>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-slate-600">
                                            ${detailRows.map(item => `<div><span class="block font-semibold text-slate-700">${item.label}</span>${item.value}</div>`).join('')}
                                        </div>
                                        ${statusMessage}
                                        ${suggestedSlotsMarkup}
                                        <div class="space-y-2">
                                            <p class="text-sm font-semibold text-slate-700">Quick actions</p>
                                            ${appointmentActionButtons(contextId, 0)}
                                            <p class="text-xs text-slate-500">Use these shortcuts or continue the conversation.</p>
                                        </div>
                                    </div>
                                `,
                                contexts: [
                                    { id: contextId, type: 'appointments', data: [appointment] },
                                    { id: slotContextId, type: 'slots', data: normalizedSlots }
                                ],
                                renderOptions: { isRich: true, fullWidth: true }
                            };
                        }

                        const markup = `
                            <div class="chat-response-container space-y-4" data-context-id="${contextId}" data-context-type="appointments">
                                <h4>Appointment ${appointment.appointmentId || appointment.queueNumber || ''}</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-slate-600">
                                    ${detailRows.map(item => `<div><span class="block font-semibold text-slate-700">${item.label}</span>${item.value}</div>`).join('')}
                                </div>
                                ${statusMessage}
                                <div class="space-y-2">
                                    <p class="text-sm font-semibold text-slate-700">Quick actions</p>
                                    ${appointmentActionButtons(contextId, 0)}
                                    <p class="text-xs text-slate-500">Use these shortcuts or continue the conversation.</p>
                                </div>
                            </div>
                        `;
                        return {
                            markup,
                            contexts: [{ id: contextId, type: 'appointments', data: [appointment] }],
                            renderOptions: { isRich: true, fullWidth: true }
                        };
                    },
                    lead: (records) => {
                        if (!records.length) return null;
                        if (records.length > 1) {
                            const rows = records.map(record => `
                                <tr>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.leadId || record.id || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${getLeadName(record)}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.phone || record.phoneNumber || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.email || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.source || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.count ?? formatDateTime(record.createdAt)}</td>
                                </tr>
                            `).join('');
                            return {
                                markup: `
                                    <div class="chat-response-container">
                                        <h4>Leads</h4>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full">
                                                <thead>
                                                    <tr>
                                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Lead</th>
                                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Name</th>
                                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Phone</th>
                                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Email</th>
                                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Source</th>
                                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Count / Created</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-slate-200">${rows}</tbody>
                                            </table>
                                        </div>
                                    </div>
                                `,
                                renderOptions: { isRich: true, fullWidth: true }
                            };
                        }

                        const lead = records[0];
                        const leadName = getLeadName(lead);
                        const leadTitle = (lead.leadId || (leadName !== '-' ? leadName : '') || '').toString().trim();
                        const leadHeading = leadTitle ? `Lead ${leadTitle}` : 'Lead';
                        const detailRows = [
                            { label: 'Lead ID', value: lead.leadId || lead.id || '-' },
                            { label: 'Name', value: leadName },
                            { label: 'Phone', value: lead.phone || lead.phoneNumber || '-' },
                            { label: 'Email', value: lead.email || '-' },
                            { label: 'Source', value: lead.source || '-' },
                            { label: 'Notes', value: lead.notes || '-' },
                            { label: 'Created At', value: formatDateTime(lead.createdAt) }
                        ];
                        const visibleDetails = detailRows.filter(item => item.value !== '-' && item.value !== undefined && item.value !== null && item.value !== '');
                        const displayDetails = visibleDetails.length ? visibleDetails : detailRows;
                        return {
                            markup: `
                                <div class="chat-response-container space-y-4">
                                    <h4>${leadHeading}</h4>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-slate-600">
                                        ${displayDetails.map(item => `<div><span class="block font-semibold text-slate-700">${item.label}</span>${item.value || '-'}</div>`).join('')}
                                    </div>
                                </div>
                            `,
                            renderOptions: { isRich: true, fullWidth: true }
                        };
                    },
                    analytics: (records) => {
                        const contextId = createContextId('analytics');
                        const insights = Array.isArray(response.insights) ? response.insights : [];
                        const chartConfig = response.chart || null;
                        const chartMeta = response.chartMeta || {};
                        const cards = records.map(point => {
                            const changeLabel = formatChange(point.change);
                            const isPositive = typeof point.change === 'number' ? point.change >= 0 : String(point.change || '').startsWith('+');
                            return `
                                <div class="rounded-xl border border-slate-200 bg-slate-50 p-4 space-y-1">
                                    <p class="text-xs uppercase tracking-wide text-slate-500">${point.metric || 'Metric'}</p>
                                    <p class="text-2xl font-bold text-slate-800">${formatMetricValue(point)}</p>
                                    ${changeLabel ? `<p class="text-xs font-medium ${isPositive ? 'text-emerald-600' : 'text-rose-600'}">${changeLabel} vs last period</p>` : ''}
                                </div>
                            `;
                        }).join('');

                        const chartId = chartConfig ? `${contextId}-chart` : null;
                        const chartMarkup = chartConfig ? `
                            <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                                <canvas id="${chartId}" data-chart-config="${escapeAttribute(JSON.stringify(chartConfig))}"></canvas>
                            </div>
                        ` : '';

                        const insightMarkup = insights.length
                            ? `<div class="space-y-2">
                                    <h5 class="text-sm font-semibold text-slate-700">Insights</h5>
                                    <ul class="list-disc pl-5 space-y-1 text-sm text-slate-600">
                                        ${insights.map(item => `<li>${item}</li>`).join('')}
                                    </ul>
                                </div>`
                            : '';

                        return {
                            markup: `
                                <div class="chat-response-container space-y-4" data-context-id="${contextId}" data-context-type="analytics">
                                    <div class="flex items-center justify-between gap-3">
                                        <h4>Business Intelligence</h4>
                                        ${chartMeta.range ? `<span class="text-xs px-2 py-1 bg-slate-100 text-slate-500 rounded-full">${chartMeta.range}</span>` : ''}
                                    </div>
                                    ${cards ? `<div class="grid grid-cols-1 sm:grid-cols-3 gap-3">${cards}</div>` : ''}
                                    ${chartMarkup}
                                    ${insightMarkup}
                                </div>
                            `,
                            contexts: [{ id: contextId, type: 'analytics', data: { metrics: records, insights, chart: chartConfig } }],
                            charts: chartConfig ? [{ id: chartId, config: chartConfig }] : [],
                            renderOptions: { isRich: true, fullWidth: true }
                        };
                    }
                };

                if (builders[normalizedTool]) {
                    return builders[normalizedTool](dataPoints);
                }
                const matchedKey = Object.keys(builders).find(key => normalizedTool.includes(key));
                if (matchedKey) {
                    return builders[matchedKey](dataPoints);
                }
                if (response.chart) {
                    return builders.analytics(dataPoints);
                }
                if (!dataPoints.length) return null;
                return {
                    markup: `<div class="chat-response-container" data-context-type="generic"><h4>${response.tool || 'Details'}</h4><pre class="text-sm text-slate-600 whitespace-pre-wrap">${escapeAttribute(JSON.stringify(dataPoints, null, 2))}</pre></div>`,
                    renderOptions: { isRich: true, fullWidth: true }
                };
            }
            function handleSlotCardSelection(card) {
                const slot = card.dataset.slot || '';
                const contextId = card.dataset.contextId || card.closest('[data-context-id]')?.dataset.contextId;
                const index = Number(card.dataset.index);
                const context = getContextById(contextId);
                let record = null;
                if (context && Array.isArray(context.data)) {
                    record = context.data[index];
                }
                const display = formatSlotDisplay(slot || (record ? record.iso : ''));
                const readableParts = [display.displayTime, display.displayDate].filter(Boolean);
                const readable = readableParts.length ? readableParts.join(' on ') : slot;
                const fallbackCustomer = conversationMemory.lastCustomer || 'the last customer';
                const customer = (card.dataset.customer && card.dataset.customer.trim()) || fallbackCustomer;
                let prompt = `Book an appointment for ${customer}`;
                if (readable) {
                    prompt += ` at ${readable}`;
                } else if (slot) {
                    prompt += ` at ${slot}`;
                }
                if (record && record.serviceId) {
                    prompt += ` for service ${record.serviceId}`;
                }
                chatInput.value = prompt.trim();
                chatInput.focus();
                showToast(readable ? `Ready to book ${readable}` : 'Added slot to your command.');
                saveChatState();
            }

            function handleAppointmentRowClick(row) {
                const contextId = row.dataset.contextId || row.closest('[data-context-id]')?.dataset.contextId;
                const index = Number(row.dataset.index);
                const context = getContextById(contextId);
                if (!context || !Array.isArray(context.data)) return;
                const appointment = context.data[index];
                if (!appointment) return;

                const tbody = row.parentElement;
                if (tbody) {
                    tbody.querySelectorAll('.appointment-row').forEach(r => r.classList.remove('bg-orange-50', 'ring-1', 'ring-orange-300'));
                }
                row.classList.add('bg-orange-50', 'ring-1', 'ring-orange-300');

                conversationMemory.lastSelectedAppointment = cloneData(appointment);
                conversationMemory.lastSelectedContextId = contextId;
                updateLastCustomerFromAppointment(appointment);

                const wrapper = row.closest('.appointments-wrapper');
                const panel = wrapper ? wrapper.querySelector(`[data-action-panel="${contextId}"]`) : null;
                if (panel) {
                    panel.innerHTML = `
                        <div class="space-y-2">
                            <p class="text-sm font-semibold text-slate-700">Quick actions for ${appointment.customer || appointment.name || 'this customer'}:</p>
                            ${appointmentActionButtons(contextId, index)}
                            <p class="text-xs text-slate-500">Use these shortcuts or continue the conversation.</p>
                        </div>
                    `;
                }
                saveChatState();
            }

            function handleAppointmentAction(button) {
                const action = button.dataset.appointmentAction;
                const contextId = button.dataset.contextId || conversationMemory.lastSelectedContextId;
                let index = Number(button.dataset.index);
                if (Number.isNaN(index) || index < 0) index = conversationMemory.lastAppointments.length - 1;
                const context = getContextById(contextId);
                let appointment = context && Array.isArray(context.data) ? context.data[index] : null;
                if (!appointment) {
                    appointment = conversationMemory.lastSelectedAppointment || conversationMemory.lastAppointments[index] || conversationMemory.lastAppointments[conversationMemory.lastAppointments.length - 1];
                }
                if (!appointment) return;

                updateLastCustomerFromAppointment(appointment);
                const appointmentId = appointment.appointmentId || appointment.queueNumber || `appointment ${index + 1}`;
                const when = formatDateTime(appointment.datetime);
                const customerName = appointment.customer || appointment.name || 'the customer';

                let prompt;
                switch (action) {
                    case 'send-reminder':
                        prompt = `Send a reminder to ${customerName} about appointment ${appointmentId} scheduled for ${when}.`;
                        showToast(`Prepared reminder for ${customerName}.`);
                        conversationMemory.lastAction = { type: 'appointmentReminder', appointmentId, timestamp: Date.now() };
                        break;
                    case 'reschedule':
                        prompt = `Reschedule appointment ${appointmentId} for ${customerName} to `;
                        showToast('Add the new time to the message to reschedule.');
                        conversationMemory.lastAction = { type: 'appointmentReschedule', appointmentId, timestamp: Date.now() };
                        break;
                    case 'view-history':
                        prompt = `Show the customer history for ${customerName}.`;
                        showToast(`Ready to view ${customerName}'s history.`);
                        conversationMemory.lastAction = { type: 'customerHistory', customerName, appointmentId, timestamp: Date.now() };
                        break;
                    case 'notify-cancel':
                        prompt = `Send a WhatsApp notification to ${customerName} about the cancellation of appointment ${appointmentId} scheduled for ${when}.`;
                        showToast('Notification command prepared.');
                        conversationMemory.lastAction = { type: 'appointmentNotifyCancel', appointmentId, timestamp: Date.now() };
                        break;
                    case 'undo':
                        prompt = `Undo the cancellation for appointment ${appointmentId}.`;
                        showToast('Prepared undo request.');
                        conversationMemory.lastAction = { type: 'appointmentUndo', appointmentId, timestamp: Date.now() };
                        break;
                    default:
                        return;
                }

                chatInput.value = prompt.trim();
                chatInput.focus();
                saveChatState();
            }

            function handleInvoiceAction(button) {
                const action = button.dataset.invoiceAction;
                const contextId = button.dataset.contextId || conversationMemory.lastInvoiceContextId;
                const context = getContextById(contextId);
                const invoice = context ? context.data : conversationMemory.lastInvoice;
                if (!invoice) return;
                const invoiceId = invoice.invoiceId || invoice.id || 'the invoice';
                const customerName = invoice.customer || 'the customer';
                let prompt;
                if (action === 'send-whatsapp') {
                    prompt = `Send invoice ${invoiceId} to ${customerName} via WhatsApp.`;
                    showToast(`Ready to send invoice ${invoiceId}.`);
                    conversationMemory.lastAction = { type: 'invoiceSend', invoiceId, timestamp: Date.now() };
                } else if (action === 'mark-paid') {
                    prompt = `Mark invoice ${invoiceId} as paid.`;
                    showToast(`Marked ${invoiceId} for payment update.`);
                    conversationMemory.lastAction = { type: 'invoicePaid', invoiceId, timestamp: Date.now() };
                } else {
                    return;
                }
                chatInput.value = prompt;
                chatInput.focus();
                saveChatState();
            }
            chatHistory.addEventListener('click', (event) => {
                const slotCard = event.target.closest('.suggested-slot-card, .available-slot-card');
                if (slotCard) {
                    handleSlotCardSelection(slotCard);
                    return;
                }

                const appointmentRow = event.target.closest('.appointment-row');
                if (appointmentRow) {
                    handleAppointmentRowClick(appointmentRow);
                    return;
                }

                const appointmentActionBtn = event.target.closest('.appointment-action-btn');
                if (appointmentActionBtn) {
                    handleAppointmentAction(appointmentActionBtn);
                    return;
                }

                const invoiceActionBtn = event.target.closest('.invoice-action-btn');
                if (invoiceActionBtn) {
                    handleInvoiceAction(invoiceActionBtn);
                }
            });
            function handleMemoryPrompt(prompt, placeholderId) {
                const lower = prompt.toLowerCase();
                let speechSummary = null;

                if (conversationMemory.lastAppointments.length) {
                    const appointment = conversationMemory.lastSelectedAppointment || conversationMemory.lastAppointments[conversationMemory.lastAppointments.length - 1];
                    if (appointment) {
                        const appointmentId = appointment.appointmentId || appointment.queueNumber || 'the appointment';
                        const when = formatDateTime(appointment.datetime);
                        const customerName = appointment.customer || appointment.name || 'the customer';
                        if (lower.includes('cancel') && (lower.includes('last') || lower.includes('one') || lower.includes('that'))) {
                            const message = `Understood. I have canceled the appointment for ${customerName} at ${when}. Should I notify them?`;
                            const markup = `
                                <div class="chat-response-container space-y-3" data-context-id="${conversationMemory.lastSelectedContextId || ''}" data-context-type="appointment-follow-up">
                                    <p class="text-sm text-slate-700">${message}</p>
                                    <div class="flex flex-wrap gap-2">
                                        <button type="button" class="appointment-action-btn inline-flex items-center gap-2 rounded-md bg-orange-50 border border-orange-200 px-3 py-2 text-sm font-medium text-orange-600 hover:bg-orange-100" data-appointment-action="notify-cancel" data-context-id="${conversationMemory.lastSelectedContextId || ''}" data-index="${conversationMemory.lastSelectedAppointment ? 0 : conversationMemory.lastAppointments.length - 1}">
                                            <i class="fa-solid fa-comment-dots"></i>
                                            Notify Customer
                                        </button>
                                        <button type="button" class="appointment-action-btn inline-flex items-center gap-2 rounded-md bg-slate-100 border border-slate-300 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200" data-appointment-action="undo" data-context-id="${conversationMemory.lastSelectedContextId || ''}" data-index="${conversationMemory.lastSelectedAppointment ? 0 : conversationMemory.lastAppointments.length - 1}">
                                            <i class="fa-solid fa-rotate-left"></i>
                                            Undo Cancellation
                                        </button>
                                    </div>
                                </div>
                            `;
                            render.updateMessage(placeholderId, markup, true);
                            conversationMemory.lastAction = { type: 'appointmentCancelled', appointmentId, timestamp: Date.now() };
                            saveChatState();
                            speechSummary = message;
                            return { speech: speechSummary };
                        }
                    }
                }

                if (conversationMemory.lastSlots.length && lower.includes('book') && lower.includes('slot')) {
                    let slot = conversationMemory.lastSlots[conversationMemory.lastSlots.length - 1];
                    if (lower.includes('first')) {
                        slot = conversationMemory.lastSlots[0];
                    }
                    if (slot) {
                        const readable = [slot.displayTime, slot.displayDate].filter(Boolean).join(' on ');
                        const message = `Great choice! I've prepared the booking for the ${readable || slot.iso}.`;
                        const markup = `
                            <div class="chat-response-container space-y-3" data-context-id="${conversationMemory.lastSlotsContextId || ''}" data-context-type="slots-follow-up">
                                <p class="text-sm text-slate-700">${message}</p>
                                <p class="text-xs text-slate-500">Use the quick action buttons if you would like to fine tune it further.</p>
                            </div>
                        `;
                        render.updateMessage(placeholderId, markup, true);
                        conversationMemory.lastAction = { type: 'slotPrepared', slot: slot.iso, timestamp: Date.now() };
                        saveChatState();
                        speechSummary = message;
                        return { speech: speechSummary };
                    }
                }

                if (conversationMemory.lastInvoice) {
                    const invoice = conversationMemory.lastInvoice;
                    const invoiceId = invoice.invoiceId || invoice.id || 'the invoice';
                    const customerName = invoice.customer || 'the customer';
                    if (lower.includes('send') && (lower.includes('customer') || lower.includes('whatsapp') || lower.includes('them'))) {
                        const message = `I'll send invoice ${invoiceId} to ${customerName} via WhatsApp right away.`;
                        const markup = `
                            <div class="chat-response-container space-y-3" data-context-id="${conversationMemory.lastInvoiceContextId || ''}" data-context-type="invoice-follow-up">
                                <p class="text-sm text-slate-700">${message}</p>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" class="invoice-action-btn inline-flex items-center gap-2 rounded-md bg-orange-50 border border-orange-200 px-3 py-2 text-sm font-medium text-orange-600 hover:bg-orange-100" data-invoice-action="send-whatsapp" data-context-id="${conversationMemory.lastInvoiceContextId || ''}">
                                        <i class="fa-solid fa-paper-plane"></i>
                                        Send again
                                    </button>
                                    <button type="button" class="invoice-action-btn inline-flex items-center gap-2 rounded-md bg-slate-100 border border-slate-300 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200" data-invoice-action="mark-paid" data-context-id="${conversationMemory.lastInvoiceContextId || ''}">
                                        <i class="fa-solid fa-circle-check"></i>
                                        Mark as Paid
                                    </button>
                                </div>
                            </div>
                        `;
                        render.updateMessage(placeholderId, markup, true);
                        conversationMemory.lastAction = { type: 'invoiceSend', invoiceId, timestamp: Date.now() };
                        saveChatState();
                        speechSummary = message;
                        return { speech: speechSummary };
                    }

                    if (lower.includes('mark') && lower.includes('paid')) {
                        const message = `Done. Invoice ${invoiceId} is now marked as paid.`;
                        render.updateMessage(placeholderId, `<div class="chat-response-container"><p class="text-sm text-slate-700">${message}</p></div>`, true);
                        conversationMemory.lastAction = { type: 'invoicePaid', invoiceId, timestamp: Date.now() };
                        saveChatState();
                        speechSummary = message;
                        return { speech: speechSummary };
                    }
                }

                return null;
            }
            async function handleChatSubmit(e) {
                e.preventDefault();
                const prompt = chatInput.value.trim();
                if (!prompt) {
                    speechSubmitting = false;
                    return;
                }

                render.addMessageToChat(`<p>${formatTextContent(prompt)}</p>`, true);
                if (speechSubmitting) {
                    chatInput.value = prompt;
                    speechSubmitting = false;
                } else {
                    chatInput.value = '';
                }

                const thinkingMessageId = render.addMessageToChat(`<div class="bg-slate-200 text-slate-800 p-3 rounded-lg"><p class="italic text-slate-500 thinking-bubble">Connecting to agent</p></div>`, false);

                const memoryResult = handleMemoryPrompt(prompt, thinkingMessageId);
                if (memoryResult) {
                    if (memoryResult.speech) speak(memoryResult.speech, currentLang);
                    return;
                }

                try {
                    const response = await api.runAgent(prompt);

                    const textResponse = formatTextContent(response.output || response.confirmation_text);
                    if (textResponse) {
                        render.updateMessage(thinkingMessageId, `<p>${textResponse}</p>`, false);
                        speak(response.output || response.confirmation_text, currentLang);
                    } else {
                        render.removeMessage(thinkingMessageId);
                    }

                    const toolContent = buildToolDisplay(response);
                    if (toolContent) {
                        const messageId = render.addMessageToChat(toolContent.markup, false, toolContent.renderOptions || { isRich: true, fullWidth: true });
                        const messageElement = document.getElementById(messageId);
                        if (toolContent.contexts) {
                            toolContent.contexts.forEach(registerContext);
                        }
                        if (messageElement) {
                            bootstrapCharts(messageElement);
                        }
                    }

                    if (!textResponse && !toolContent) {
                        showToast("Received an empty or invalid response from the agent.", true);
                    }
                } catch (error) {
                    console.error("API call failed:", error);
                    let errorMessage = "Sorry, something went wrong. Please check the backend and try again.";
                    if (error.message) {
                        if (error.message.toLowerCase().includes("timed out")) {
                            errorMessage = "The request timed out. The server might be busy or starting up. Please wait a moment and try again.";
                        } else if (error.message.toLowerCase().includes("agent error")) {
                            errorMessage = "The agent encountered an internal error. Please try a different query or contact support if the issue persists.";
                        }
                    }
                    render.updateMessage(thinkingMessageId, `<p class="text-red-500">${errorMessage}</p>`, false);
                    speak(errorMessage, currentLang);
                } finally {
                    saveChatState();
                }
            }

            function toggleModal(modal, show) {
                if (show) modal.classList.remove('hidden');
                else modal.classList.add('hidden');
            }

            settingsBtn.addEventListener('click', () => toggleModal(settingsModal, true));
            closeModalBtn.addEventListener('click', () => toggleModal(settingsModal, false));
            saveSettingsBtn.addEventListener('click', () => {
                currentLang = languageSelect.value;
                setupRecognition(currentLang);
                showToast(`Language set to ${languageSelect.options[languageSelect.selectedIndex].text}`);
                toggleModal(settingsModal, false);
            });

            async function init() {
                restoreChatState();
                chatForm.addEventListener('submit', handleChatSubmit);
                tools = await api.getTools();
                render.tools();
                render.quickActions();
                activateTab('tools');
                setupRecognition(currentLang);
                bootstrapCharts(chatHistory);
            }

            init();
        });
    </script>
</body>
</html>

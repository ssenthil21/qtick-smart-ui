<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Enabled AI Assistant - QTick</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .agentic-pane {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
        }
        .main-pane-height {
             height: calc(100vh - 120px);
        }
        .side-rail-toggle-btn {
            position: absolute;
            top: 1rem;
            right: -0.75rem;
            z-index: 20;
        }
        .rail-collapsed #side-rail {
            display: none;
        }
        .rail-collapsed #chat-pane {
            grid-column: span 5 / span 5;
        }
        .rail-collapsed #side-rail-reveal {
            display: flex;
        }
        #side-rail-reveal {
            display: none;
        }
        .modal-backdrop, .drag-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .suggestion-chip, .tab-btn {
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .tab-btn-active {
            background-color: #fff7ed;
            color: #ea580c;
            border-color: #f97316;
        }
        .thinking-bubble::after {
            content: '.';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        #mic-btn.listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(234, 88, 12, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); }
        }
        .chat-response-container {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: white;
        }
        .chat-response-container h4 {
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #1e293b;
        }
        .appointment-row {
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .appointment-row:hover {
            background-color: #fff7ed;
        }
        .quick-action-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .quick-action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -15px rgba(15, 23, 42, 0.4);
        }
        .tool-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .tool-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 18px 35px -25px rgba(15, 23, 42, 0.45);
        }
        .theme-dark body,
        .theme-dark {
            background-color: #0f172a;
            color: #e2e8f0;
        }
        body.theme-dark {
            background-color: #0f172a;
            color: #e2e8f0;
        }
        body.theme-dark .agentic-pane {
            background-color: #1e293b;
            color: #e2e8f0;
        }
        body.theme-dark .chat-response-container {
            background-color: #1f2937;
            border-color: #334155;
        }
        body.theme-dark .tab-btn-active {
            background-color: #1f2937;
            color: #f59e0b;
            border-color: #f97316;
        }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <nav class="container mx-auto px-4 lg:px-6 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-orange-600">
                <i class="fa-solid fa-robot mr-2"></i>QTick AI Smart Assistant
            </h1>
            <div class="flex items-center space-x-4">
                <div class="flex items-center gap-2">
                    <button id="tts-toggle-btn" class="text-slate-400 hover:text-orange-600" title="Enable voice responses" aria-pressed="false">
                        <i class="fa-solid fa-volume-xmark"></i>
                    </button>
                    <span id="tts-status" class="text-xs font-semibold text-slate-400">Voice off</span>
                </div>
                <div class="relative" id="role-switcher">
                    <button id="role-switcher-btn" class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-600 shadow-sm transition hover:border-orange-300 hover:text-orange-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400">
                        <i class="fa-solid fa-user-tie text-orange-500"></i>
                        <span id="role-switcher-label">Manager</span>
                        <i class="fa-solid fa-angle-down text-xs"></i>
                    </button>
                    <div id="role-switcher-menu" class="absolute right-0 mt-2 w-40 overflow-hidden rounded-lg border border-slate-200 bg-white py-1 text-sm shadow-lg hidden">
                        <button type="button" class="flex w-full items-center gap-2 px-4 py-2 text-left text-slate-600 transition hover:bg-orange-50" data-role-option="manager">
                            <i class="fa-solid fa-clipboard-user text-slate-400"></i>
                            Manager
                        </button>
                        <button type="button" class="flex w-full items-center gap-2 px-4 py-2 text-left text-slate-600 transition hover:bg-orange-50" data-role-option="ceo">
                            <i class="fa-solid fa-chess-king text-slate-400"></i>
                            CEO
                        </button>
                    </div>
                </div>
                <button id="settings-btn" class="text-slate-500 hover:text-orange-600">
                    <i class="fa-solid fa-cog text-xl"></i>
                </button>
            </div>
        </nav>
    </header>

    <main id="app-layout" class="container mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-5 gap-6">
        <div id="chat-pane" class="lg:col-span-3 agentic-pane main-pane-height relative">
            <h2 class="text-lg font-bold p-4 border-b text-slate-700">Agent Chat</h2>
            <div id="chat-history" class="flex-grow p-4 space-y-4 overflow-y-auto"></div>
            <div id="suggestion-chips-container" class="p-4 pt-0 flex flex-wrap gap-2"></div>
            <div class="p-4 border-t bg-slate-50">
                <div id="file-preview-container" class="hidden mb-2"></div>
                <form id="chat-form" class="flex items-center space-x-2">
                    <input type="file" id="file-input" class="hidden">
                    <button type="button" id="attach-btn" class="bg-slate-200 text-slate-600 font-semibold p-2.5 rounded-md hover:bg-slate-300 transition flex-shrink-0 h-10 w-10"><i class="fa-solid fa-paperclip"></i></button>
                    <input id="chat-input" placeholder="Enter your goal..." class="flex-grow w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
                    <button type="button" id="mic-btn" class="bg-orange-500 text-white font-semibold p-2.5 rounded-md hover:bg-orange-600 transition flex-shrink-0 h-10 w-10" aria-pressed="false" aria-label="Start voice capture">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <span id="mic-status" class="hidden text-xs text-orange-600 font-semibold whitespace-nowrap" aria-live="polite"></span>
                    <button type="submit" class="bg-orange-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-orange-700 transition flex-shrink-0">Run</button>
                </form>
            </div>
            <div id="drag-overlay" class="absolute inset-0 z-10 hidden items-center justify-center bg-opacity-75 backdrop-blur-sm drag-overlay">
                <div class="text-center text-white p-6 border-4 border-dashed rounded-xl">
                    <i class="fa-solid fa-upload fa-3x"></i>
                    <p class="mt-4 text-xl font-bold">Drop file to upload</p>
                </div>
            </div>
        </div>

        <button id="side-rail-reveal" class="side-rail-toggle-btn items-center gap-2 rounded-full bg-white px-3 py-2 text-sm font-semibold text-slate-600 shadow-md ring-1 ring-slate-200 hover:text-orange-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400" aria-label="Show tools panel" tabindex="-1">
            <i class="fa-solid fa-thumbtack"></i>
            Show tools
        </button>
        <div id="side-rail" class="lg:col-span-2 flex flex-col min-h-[calc(100vh-120px)] relative">
            <button id="collapse-rail-btn" class="side-rail-toggle-btn hidden lg:flex items-center gap-2 rounded-full bg-white px-3 py-2 text-xs font-semibold text-slate-500 shadow-md ring-1 ring-slate-200 hover:text-orange-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400" aria-label="Hide tools panel" aria-pressed="true">
                <i class="fa-solid fa-thumbtack-slash"></i>
                Hide tools
            </button>
            <div class="agentic-pane flex-1 overflow-hidden flex flex-col">
                <div class="border-b bg-white">
                    <div class="grid grid-cols-2">
                        <button type="button" data-tab-target="tools" class="tab-btn px-4 py-3 text-sm font-semibold text-slate-500 border-b-2 border-transparent focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400">Tools</button>
                        <button type="button" data-tab-target="quick-actions" class="tab-btn px-4 py-3 text-sm font-semibold text-slate-500 border-b-2 border-transparent focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400">Quick Actions</button>
                    </div>
                </div>
                <div class="flex-1 overflow-hidden relative">
                    <div id="tools-panel" data-tab-panel="tools" class="absolute inset-0 flex flex-col">
                        <div class="p-4 border-b text-slate-700 space-y-4">
                            <h2 class="text-lg font-bold">Tool Catalog</h2>
                            <p class="text-xs text-slate-500 mt-1">Browse the assistant's connected tools by category and trigger them instantly.</p>
                            <div class="grid grid-cols-1 gap-3 sm:grid-cols-6">
                                <label class="sm:col-span-4 flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600 focus-within:border-orange-300 focus-within:ring-2 focus-within:ring-orange-200/70">
                                    <i class="fa-solid fa-magnifying-glass text-slate-400"></i>
                                    <input id="tool-search" type="search" placeholder="Search tools by name or description" class="w-full border-none bg-transparent focus:outline-none" />
                                </label>
                                <label class="sm:col-span-2 flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600 focus-within:border-orange-300 focus-within:ring-2 focus-within:ring-orange-200/70">
                                    <i class="fa-solid fa-filter text-slate-400"></i>
                                    <select id="tool-category-filter" class="w-full border-none bg-transparent focus:outline-none">
                                        <option value="all">All categories</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                        <div id="tool-catalog" class="flex-1 p-4 space-y-5 overflow-y-auto bg-slate-50/40">
                            <div class="flex items-center justify-center h-full text-slate-400">
                                <i class="fa fa-spinner fa-spin mr-2"></i> Loading Tools...
                            </div>
                        </div>
                    </div>
                    <div id="quick-actions-panel" data-tab-panel="quick-actions" class="absolute inset-0 hidden flex flex-col">
                        <div class="p-4 border-b text-slate-700">
                            <h2 class="text-lg font-bold">Chillbreeze Quick Actions</h2>
                            <p class="text-xs text-slate-500 mt-1">Jump into ready-made prompts tailored to Chillbreeze lounges.</p>
                        </div>
                        <div id="quick-actions-list" class="flex-1 p-4 space-y-5 overflow-y-auto bg-slate-50/40"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-3"></div>

    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-bold">Settings</h3>
                <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-6">
                <div class="space-y-2">
                    <h4 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Voice & language</h4>
                    <label for="language-select" class="block text-sm font-medium text-slate-700">Preferred speech language</label>
                    <select id="language-select" class="w-full p-2 border rounded-md bg-white">
                        <option value="en-US">English (US)</option>
                        <option value="ta-IN">Tamil (India)</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <h4 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Theme</h4>
                    <div class="grid gap-2 sm:grid-cols-3">
                        <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600">
                            <input type="radio" name="theme" value="system" class="text-orange-600" checked>
                            System
                        </label>
                        <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600">
                            <input type="radio" name="theme" value="light" class="text-orange-600">
                            Light
                        </label>
                        <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600">
                            <input type="radio" name="theme" value="dark" class="text-orange-600">
                            Dark
                        </label>
                    </div>
                </div>
                <div class="space-y-2">
                    <h4 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Default role</h4>
                    <p class="text-xs text-slate-500">Choose which workspace opens by default when you return.</p>
                    <select id="default-role-select" class="w-full p-2 border rounded-md bg-white">
                        <option value="manager">Manager workspace</option>
                        <option value="ceo">Executive overview</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <h4 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Notification volume</h4>
                    <div class="flex items-center gap-3">
                        <input id="notification-volume" type="range" min="0" max="1" step="0.1" class="flex-1">
                        <span id="notification-volume-value" class="text-sm font-semibold text-slate-600">100%</span>
                    </div>
                    <p class="text-xs text-slate-500">Controls the loudness of spoken summaries and sound cues.</p>
                </div>
                <hr>
                <button id="save-settings-btn" class="w-full bg-orange-600 text-white font-semibold py-2 px-3 rounded-md hover:bg-orange-700">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toolCatalog = document.getElementById('tool-catalog');
            const chatHistory = document.getElementById('chat-history');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const attachBtn = document.getElementById('attach-btn');
            const fileInput = document.getElementById('file-input');
            const filePreviewContainer = document.getElementById('file-preview-container');
            const dragOverlay = document.getElementById('drag-overlay');
            const micBtn = document.getElementById('mic-btn');
            const micStatus = document.getElementById('mic-status');
            const ttsToggleBtn = document.getElementById('tts-toggle-btn');
            const ttsStatus = document.getElementById('tts-status');
            const toastContainer = document.getElementById('toast-container');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const languageSelect = document.getElementById('language-select');
            const defaultRoleSelect = document.getElementById('default-role-select');
            const notificationVolumeInput = document.getElementById('notification-volume');
            const notificationVolumeValue = document.getElementById('notification-volume-value');
            const themeRadios = Array.from(document.querySelectorAll('input[name="theme"]'));
            const quickActionsList = document.getElementById('quick-actions-list');
            const suggestionChipsContainer = document.getElementById('suggestion-chips-container');
            const tabButtons = document.querySelectorAll('[data-tab-target]');
            const tabPanels = document.querySelectorAll('[data-tab-panel]');
            const roleSwitcherBtn = document.getElementById('role-switcher-btn');
            const roleSwitcherMenu = document.getElementById('role-switcher-menu');
            const roleSwitcherLabel = document.getElementById('role-switcher-label');
            const appLayout = document.getElementById('app-layout');
            const collapseRailBtn = document.getElementById('collapse-rail-btn');
            const sideRailReveal = document.getElementById('side-rail-reveal');
            const toolSearchInput = document.getElementById('tool-search');
            const toolCategorySelect = document.getElementById('tool-category-filter');

            let tools = [];
            let voiceEnabled = false;
            let currentLang = 'en-US';
            let recognition;
            let speechSubmitting = false;
            let currentRole = 'manager';
            let toolSearchTerm = '';
            let toolCategoryFilter = 'all';
            let toolFiltersHydrated = false;
            let themePreference = 'system';
            let pendingThemePreference = 'system';
            let notificationVolume = 1;
            let sideRailCollapsed = false;
            let onboardingIndex = 0;

            const onboardingTips = [
                {
                    title: 'Review today\'s wins',
                    description: 'Ask for “Summarize today\'s revenue drivers” to see which lounges over-performed.',
                    icon: 'fa-chart-line'
                },
                {
                    title: 'Keep customers in the loop',
                    description: 'Try “Send a reminder to the next VIP guest” before the appointment begins.',
                    icon: 'fa-comments'
                },
                {
                    title: 'Spot scheduling gaps',
                    description: 'Say “Show open slots at Chillbreeze Orchard tomorrow afternoon.”',
                    icon: 'fa-calendar-check'
                }
            ];

            const suggestionPrompts = [
                'List appointments at Chillbreeze Orchard today',
                'Share a customer snapshot for Anna Nagar this week',
                'Summarize key business metrics for last month',
                'Prepare an invoice for Senthil with detox add-ons'
            ];

            const STORAGE_KEYS = {
                chat: 'qtick-chat-html',
                context: 'qtick-chat-context',
                role: 'qtick-role-preference',
                theme: 'qtick-theme-preference',
                volume: 'qtick-notification-volume',
                sideRail: 'qtick-side-rail-collapsed',
                voice: 'qtick-voice-enabled'
            };

            const conversationMemory = {
                contexts: {},
                contextOrder: [],
                lastAppointments: [],
                lastSlots: [],
                lastSlotsContextId: null,
                lastInvoice: null,
                lastInvoiceContextId: null,
                lastSelectedAppointment: null,
                lastSelectedContextId: null,
                lastCustomer: '',
                lastAnalytics: null,
                lastAction: null
            };

            const prefersDarkScheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');

            function resolveTheme(preference) {
                if (preference === 'dark' || preference === 'light') return preference;
                if (prefersDarkScheme && typeof prefersDarkScheme.matches === 'boolean') {
                    return prefersDarkScheme.matches ? 'dark' : 'light';
                }
                return 'light';
            }

            function applyTheme(preference) {
                const resolved = resolveTheme(preference);
                document.body.classList.toggle('theme-dark', resolved === 'dark');
            }

            function updateVolumeLabel(value = notificationVolume) {
                if (!notificationVolumeValue) return;
                notificationVolumeValue.textContent = `${Math.round(value * 100)}%`;
            }

            function updateTtsAffordance() {
                if (!ttsToggleBtn) return;
                ttsToggleBtn.innerHTML = voiceEnabled
                    ? '<i class="fa-solid fa-volume-high text-orange-600"></i>'
                    : '<i class="fa-solid fa-volume-xmark"></i>';
                ttsToggleBtn.setAttribute('aria-pressed', String(voiceEnabled));
                ttsToggleBtn.title = voiceEnabled ? 'Disable voice responses' : 'Enable voice responses';
                if (ttsStatus) {
                    ttsStatus.textContent = voiceEnabled ? 'Voice on' : 'Voice off';
                    ttsStatus.classList.toggle('text-orange-600', voiceEnabled);
                    ttsStatus.classList.toggle('text-slate-400', !voiceEnabled);
                }
            }

            function setMicStatus(message = '', intent = 'idle') {
                if (!micStatus) return;
                if (!message) {
                    micStatus.classList.add('hidden');
                    micStatus.textContent = '';
                    return;
                }
                micStatus.classList.remove('hidden');
                micStatus.textContent = message;
                micStatus.classList.remove('text-red-500', 'text-orange-600', 'text-emerald-500');
                const colorClass = intent === 'listening' ? 'text-red-500' : intent === 'ready' ? 'text-emerald-500' : 'text-orange-600';
                micStatus.classList.add(colorClass);
            }

            function updateSideRailState(collapsed) {
                sideRailCollapsed = collapsed;
                if (appLayout) {
                    appLayout.classList.toggle('rail-collapsed', collapsed);
                }
                if (collapseRailBtn) {
                    collapseRailBtn.setAttribute('aria-pressed', String(!collapsed));
                }
                if (sideRailReveal) {
                    sideRailReveal.setAttribute('aria-hidden', String(!collapsed));
                    sideRailReveal.setAttribute('tabindex', collapsed ? '0' : '-1');
                }
                try {
                    localStorage.setItem(STORAGE_KEYS.sideRail, String(collapsed));
                } catch (error) {
                    console.warn('Unable to persist rail preference', error);
                }
            }

            function renderSuggestionChips() {
                if (!suggestionChipsContainer) return;
                if (!suggestionPrompts.length) {
                    suggestionChipsContainer.classList.add('hidden');
                    suggestionChipsContainer.innerHTML = '';
                    return;
                }
                suggestionChipsContainer.classList.remove('hidden');
                suggestionChipsContainer.innerHTML = suggestionPrompts.map(prompt => `
                    <button type="button" class="suggestion-chip rounded-full border border-slate-200 bg-white px-3 py-1 text-sm text-slate-600 hover:border-orange-300 hover:text-orange-600" data-suggested-prompt="${escapeAttribute(prompt)}">
                        ${escapeAttribute(prompt)}
                    </button>
                `).join('');
            }

            function renderOnboardingCarousel() {
                if (!chatHistory || chatHistory.children.length > 0) return;
                if (!onboardingTips.length) return;
                const tip = onboardingTips[onboardingIndex % onboardingTips.length];
                chatHistory.dataset.onboarding = 'true';
                chatHistory.innerHTML = `
                    <div class="flex justify-center">
                        <div class="bg-white/90 border border-slate-200 rounded-2xl px-5 py-6 shadow-sm max-w-md w-full space-y-4">
                            <div class="flex items-center gap-3">
                                <span class="flex h-10 w-10 items-center justify-center rounded-full bg-orange-500/10 text-orange-500">
                                    <i class="fa-solid ${tip.icon}"></i>
                                </span>
                                <div>
                                    <p class="text-sm font-semibold text-slate-800">${escapeAttribute(tip.title)}</p>
                                    <p class="text-xs text-slate-500">${escapeAttribute(tip.description)}</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between text-xs text-slate-500">
                                <button type="button" class="rounded-full border border-slate-200 px-3 py-1 hover:border-orange-300 hover:text-orange-600" data-onboarding-nav="prev">
                                    <i class="fa-solid fa-chevron-left mr-1"></i> Previous
                                </button>
                                <span>${onboardingIndex + 1} / ${onboardingTips.length}</span>
                                <button type="button" class="rounded-full border border-slate-200 px-3 py-1 hover:border-orange-300 hover:text-orange-600" data-onboarding-nav="next">
                                    Next <i class="fa-solid fa-chevron-right ml-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            function formatFileSize(bytes) {
                if (!Number.isFinite(bytes)) return '';
                if (bytes >= 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
                if (bytes >= 1024) return `${(bytes / 1024).toFixed(1)} KB`;
                return `${bytes} B`;
            }

            function renderFilePreview(file) {
                if (!filePreviewContainer) return;
                const size = formatFileSize(file.size);
                filePreviewContainer.innerHTML = `
                    <div class="flex items-center justify-between rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600">
                        <div class="flex items-center gap-3">
                            <span class="flex h-9 w-9 items-center justify-center rounded-full bg-orange-500/10 text-orange-500">
                                <i class="fa-solid fa-file"></i>
                            </span>
                            <div>
                                <p class="font-semibold text-slate-700">${escapeAttribute(file.name)}</p>
                                <p class="text-xs text-slate-500">${size}${file.type ? ` • ${escapeAttribute(file.type)}` : ''}</p>
                            </div>
                        </div>
                        <button type="button" class="text-slate-400 hover:text-red-500" data-remove-file title="Remove attachment">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                `;
                filePreviewContainer.classList.remove('hidden');
            }

            function clearFilePreview() {
                if (!filePreviewContainer) return;
                filePreviewContainer.classList.add('hidden');
                filePreviewContainer.innerHTML = '';
                if (fileInput) {
                    fileInput.value = '';
                }
            }

            try {
                const storedRole = localStorage.getItem(STORAGE_KEYS.role);
                if (storedRole === 'ceo' || storedRole === 'manager') {
                    currentRole = storedRole;
                }
                const storedTheme = localStorage.getItem(STORAGE_KEYS.theme);
                if (storedTheme === 'light' || storedTheme === 'dark' || storedTheme === 'system') {
                    themePreference = storedTheme;
                }
                const storedVolume = localStorage.getItem(STORAGE_KEYS.volume);
                if (storedVolume !== null && storedVolume !== undefined) {
                    const parsed = Number(storedVolume);
                    if (!Number.isNaN(parsed)) {
                        notificationVolume = Math.min(1, Math.max(0, parsed));
                    }
                }
                const storedVoice = localStorage.getItem(STORAGE_KEYS.voice);
                if (storedVoice !== null) {
                    voiceEnabled = storedVoice === 'true';
                }
                const storedRail = localStorage.getItem(STORAGE_KEYS.sideRail);
                if (storedRail === 'true') {
                    sideRailCollapsed = true;
                }
            } catch (error) {
                console.warn('Unable to restore stored preferences', error);
            }

            applyTheme(themePreference);
            pendingThemePreference = themePreference;
            if (prefersDarkScheme) {
                const listener = () => { if (themePreference === 'system') applyTheme(themePreference); };
                if (typeof prefersDarkScheme.addEventListener === 'function') {
                    prefersDarkScheme.addEventListener('change', listener);
                } else if (typeof prefersDarkScheme.addListener === 'function') {
                    prefersDarkScheme.addListener(listener);
                }
            }

            if (notificationVolumeInput) {
                notificationVolumeInput.value = notificationVolume;
                updateVolumeLabel(notificationVolume);
            }
            if (defaultRoleSelect) {
                defaultRoleSelect.value = currentRole;
            }
            if (themeRadios.length) {
                themeRadios.forEach(radio => {
                    radio.checked = radio.value === themePreference;
                    radio.addEventListener('change', (event) => {
                        if (event.target.checked) {
                            pendingThemePreference = event.target.value;
                            applyTheme(pendingThemePreference);
                        }
                    });
                });
            }
            updateTtsAffordance();
            setMicStatus('Tap the mic to speak');
            updateSideRailState(sideRailCollapsed);

            const activeCharts = {};
            let contextCounter = 0;

            const activateTab = (targetId = 'tools') => {
                tabButtons.forEach(button => {
                    const isActive = button.dataset.tabTarget === targetId;
                    button.classList.toggle('tab-btn-active', isActive);
                    button.classList.toggle('text-orange-600', isActive);
                    button.classList.toggle('text-slate-500', !isActive);
                });
                tabPanels.forEach(panel => {
                    const matches = panel.dataset.tabPanel === targetId;
                    panel.classList.toggle('hidden', !matches);
                });
            };

            tabButtons.forEach(button => {
                button.addEventListener('click', () => activateTab(button.dataset.tabTarget));
            });

            if (collapseRailBtn) {
                collapseRailBtn.addEventListener('click', () => updateSideRailState(true));
            }
            if (sideRailReveal) {
                sideRailReveal.addEventListener('click', () => updateSideRailState(false));
            }

            const toolSchemas = {
                "find_appointment": { title: "Find Appointment", icon: "fa-calendar-check", category: "Scheduling" },
                "book_appointment": { title: "Book Appointment", icon: "fa-calendar-plus", category: "Scheduling" },
                "create_invoice": { title: "Create Invoice", icon: "fa-file-invoice-dollar", category: "Billing" },
                "send_sms": { title: "Send SMS/WhatsApp", icon: "fa-comment-sms", category: "Communication" },
                "schedule_task": { title: "Schedule Task", icon: "fa-clock", category: "Automation" },
                "lead_create": { title: "Create Lead", icon: "fa-user-plus", category: "Sales" }
            };

            if (toolSearchInput) {
                toolSearchInput.addEventListener('input', (event) => {
                    toolSearchTerm = event.target.value.trim().toLowerCase();
                    render.tools();
                });
            }

            if (toolCategorySelect) {
                toolCategorySelect.addEventListener('change', (event) => {
                    toolCategoryFilter = event.target.value;
                    render.tools();
                });
            }

            if (suggestionChipsContainer) {
                suggestionChipsContainer.addEventListener('click', (event) => {
                    const chip = event.target.closest('[data-suggested-prompt]');
                    if (!chip) return;
                    event.preventDefault();
                    const prompt = chip.dataset.suggestedPrompt || chip.textContent.trim();
                    if (prompt) {
                        chatInput.value = prompt;
                        chatInput.focus();
                    }
                });
            }

            if (chatHistory) {
                chatHistory.addEventListener('click', (event) => {
                    const nav = event.target.closest('[data-onboarding-nav]');
                    if (!nav) return;
                    event.preventDefault();
                    if (!onboardingTips.length) return;
                    if (nav.dataset.onboardingNav === 'next') {
                        onboardingIndex = (onboardingIndex + 1) % onboardingTips.length;
                    } else if (nav.dataset.onboardingNav === 'prev') {
                        onboardingIndex = (onboardingIndex - 1 + onboardingTips.length) % onboardingTips.length;
                    }
                    renderOnboardingCarousel();
                });
            }

            const quickActionTemplates = [
                {
                    label: "Schedule overview",
                    promptTemplate: "List appointments scheduled at {location} for {timeRange}",
                    icon: "fa-calendar-days",
                    accent: "bg-orange-100 text-orange-600"
                },
                {
                    label: "Customer snapshot",
                    promptTemplate: "Share a customer snapshot for {location} covering {timeRange}",
                    icon: "fa-user",
                    accent: "bg-sky-100 text-sky-600"
                },
                {
                    label: "Business summary",
                    promptTemplate: "Summarize key business metrics for {location} for {timeRange}",
                    icon: "fa-briefcase",
                    accent: "bg-emerald-100 text-emerald-600",
                    description: "High level performance update",
                    roles: ["manager"]
                },
                {
                    label: "Revenue snapshot",
                    promptTemplate: "Show a revenue summary for {location} for {timeRange}",
                    icon: "fa-file-invoice-dollar",
                    accent: "bg-amber-100 text-amber-600"
                },
                {
                    label: "Staff utilisation",
                    promptTemplate: "Summarize staff utilisation at {location} for {timeRange}",
                    icon: "fa-user-group",
                    accent: "bg-violet-100 text-violet-600"
                },
                {
                    label: "Lead follow-ups",
                    promptTemplate: "List priority leads for {location} requiring action in {timeRange}",
                    icon: "fa-user-plus",
                    accent: "bg-rose-100 text-rose-600",
                    description: "Who needs attention today",
                    roles: ["manager"]
                },
                {
                    label: "Business events",
                    promptTemplate: "Show notable business events at {location} for {timeRange}",
                    icon: "fa-calendar-check",
                    accent: "bg-purple-100 text-purple-600",
                    description: "What's happening on the ground",
                    roles: ["manager"]
                },
                {
                    label: "Branch consolidated summary",
                    promptTemplate: "Provide a consolidated branch performance summary for {timeRange}",
                    icon: "fa-chart-pie",
                    accent: "bg-slate-100 text-slate-600",
                    description: "Roll-up across lounges",
                    roles: ["ceo"],
                    showLocation: false
                }
            ];

            const timeRangeOptions = [
                { value: "today", label: "Today" },
                { value: "this week", label: "This Week" },
                { value: "this month", label: "This Month" },
                { value: "last week", label: "Last Week" }
            ];

            const chillbreezeLocations = [
                {
                    id: 'chillbreeze-orchard',
                    name: 'Chillbreeze Orchard',
                    area: 'Orchard, Singapore',
                    focus: 'Flagship lounge with premium aromatherapy suites.',
                    metrics: {
                        appointments: 142,
                        occupancy: '89%',
                        satisfaction: '4.9 / 5'
                    },
                    summaryMetrics: [
                        { label: "Today's revenue", value: 'S$18,750', change: 6.2 },
                        { label: 'Check-ins', value: '52', change: 3.1 },
                        { label: 'Utilisation', value: '89%', change: 1.2 }
                    ],
                    events: [
                        {
                            time: '09:30',
                            title: 'Follow up TechFin corporate lead',
                            description: 'Priya to confirm wellness retreat package.',
                            tag: 'Lead',
                            icon: 'fa-user-plus',
                            accent: 'bg-sky-100 text-sky-600'
                        },
                        {
                            time: '13:00',
                            title: 'Influencer wellness workshop',
                            description: 'Setup aroma pods and welcome kits in studio two.',
                            tag: 'Event',
                            icon: 'fa-bullhorn',
                            accent: 'bg-purple-100 text-purple-600'
                        }
                    ]
                },
                {
                    id: 'chillbreeze-anna-nagar',
                    name: 'Chillbreeze Anna Nagar',
                    area: 'Anna Nagar, Chennai',
                    focus: 'Community-favourite spa for restorative therapies.',
                    metrics: {
                        appointments: 118,
                        occupancy: '82%',
                        satisfaction: '4.7 / 5'
                    },
                    summaryMetrics: [
                        { label: "Today's revenue", value: 'S$12,140', change: 4.5 },
                        { label: 'Check-ins', value: '44', change: 2.4 },
                        { label: 'Lead conversions', value: '7', change: 1.1 }
                    ],
                    events: [
                        {
                            time: '10:15',
                            title: 'Call back bridal spa lead',
                            description: 'Rakesh awaiting customised detox quote.',
                            tag: 'Lead',
                            icon: 'fa-phone-volume',
                            accent: 'bg-amber-100 text-amber-600'
                        },
                        {
                            time: '16:00',
                            title: 'Neighbourhood wellness talk',
                            description: 'Community event hosted with local yoga collective.',
                            tag: 'Event',
                            icon: 'fa-people-group',
                            accent: 'bg-emerald-100 text-emerald-600'
                        }
                    ]
                },
                {
                    id: 'chillbreeze-adayar',
                    name: 'Chillbreeze Adayar',
                    area: 'Adayar, Chennai',
                    focus: 'Beachside retreat specialising in detox rituals.',
                    metrics: {
                        appointments: 126,
                        occupancy: '85%',
                        satisfaction: '4.8 / 5'
                    },
                    summaryMetrics: [
                        { label: "Today's revenue", value: 'S$14,680', change: 5.1 },
                        { label: 'Check-ins', value: '47', change: 2.7 },
                        { label: 'Spa packages upsold', value: '11', change: 3.4 }
                    ],
                    events: [
                        {
                            time: '11:00',
                            title: 'Yacht club guest arrival',
                            description: 'Coordinate premium detox ritual for visiting members.',
                            tag: 'Event',
                            icon: 'fa-sailboat',
                            accent: 'bg-cyan-100 text-cyan-600'
                        },
                        {
                            time: '18:30',
                            title: 'Upsell follow-up for Ananya',
                            description: 'Share membership benefits after evening therapy.',
                            tag: 'Lead',
                            icon: 'fa-comments',
                            accent: 'bg-rose-100 text-rose-600'
                        }
                    ]
                }
            ];

            const branchConsolidatedSummary = {
                lounges: chillbreezeLocations.length,
                period: 'Week to date',
                metrics: [
                    { label: 'Total revenue', value: 'S$186,400', change: 8.4 },
                    { label: 'Appointments completed', value: '386', change: 5.2 },
                    { label: 'Active leads', value: '128', change: 6.1 }
                ],
                highlights: [
                    'Orchard lounge delivered 40% of revenue via premium add-ons.',
                    'Anna Nagar events pushed community conversions up 9% week-over-week.'
                ]
            };

            let selectedQuickActionsLocationId = chillbreezeLocations[0]?.id || '';

            const api = {
                getTools: async () => {
                    await new Promise(r => setTimeout(r, 500));
                    return Object.keys(toolSchemas).map(name => ({
                        name,
                        description: `A tool to ${toolSchemas[name].title.toLowerCase()}.`
                    }));
                },
                runAgent: async (prompt) => {
                    const lowerCasePrompt = prompt.toLowerCase();

                    const mockResponses = {
                        appointmentList: {
                            output: "Here are the upcoming appointments I found.",
                            tool: "Appointment",
                            dataPoints: [
                                { status: "confirmed", appointmentId: "APT-001", queueNumber: "A01", businessId: 1003, customer: "Senthil", serviceId: 200, datetime: "2025-09-22T18:00:00+08:00" },
                                { status: "confirmed", appointmentId: "APT-002", queueNumber: "B02", businessId: 1003, customer: "Jane Doe", serviceId: 201, datetime: "2025-09-23T11:00:00+08:00" },
                                { status: "pending", appointmentId: "APT-003", queueNumber: "C03", businessId: 1003, customer: "John Smith", serviceId: 202, datetime: "2025-09-23T14:00:00+08:00" }
                            ]
                        },
                        appointmentSlots: {
                            output: "I found a few available slots for tomorrow.",
                            tool: "Appointment",
                            dataPoints: [
                                { status: "available", appointmentId: "SLOT-100", queueNumber: "-", businessId: 1003, customer: "", serviceId: 301, datetime: "2025-09-22T10:00:00+08:00" },
                                { status: "available", appointmentId: "SLOT-101", queueNumber: "-", businessId: 1003, customer: "", serviceId: 302, datetime: "2025-09-22T14:30:00+08:00" },
                                { status: "available", appointmentId: "SLOT-102", queueNumber: "-", businessId: 1003, customer: "", serviceId: 303, datetime: "2025-09-22T16:00:00+08:00" }
                            ]
                        },
                        invoice: {
                            output: "Invoice INV-00001 for Alex has been created successfully. The total amount is 52.0 SGD. You can pay via this link: https://pay.qtick.co/INV-00001",
                            tool: "Invoice",
                            dataPoints: [
                                {
                                    invoiceId: "INV-00001",
                                    total: 52.0,
                                    currency: "SGD",
                                    status: "created",
                                    createdAt: "2025-09-21T06:22:15.421334+00:00",
                                    paymentLink: "https://pay.qtick.co/INV-00001",
                                    items: [
                                        { description: "Haircut", quantity: 1, unitPrice: 25, taxRate: 0.08 },
                                        { description: "Hair serum", quantity: 2, unitPrice: 12.5 }
                                    ],
                                    customer: "Alex",
                                    businessId: 123
                                }
                            ]
                        },
                        analyticsReport: {
                            output: "Here's the latest performance summary for the business.",
                            tool: "Analytics",
                            dataPoints: [
                                { metric: "Revenue", value: 18250, currency: "SGD", change: 12 },
                                { metric: "Completed Appointments", value: 42, change: 6 },
                                { metric: "No-Show Rate", value: 3.2, suffix: "%", change: -1.2 }
                            ],
                            insights: [
                                "Revenue is up 12% compared to the previous week.",
                                "Color treatments generated the highest revenue share at 38%.",
                                "Saturday remains the busiest day with 14 confirmed appointments."
                            ],
                            chart: {
                                type: 'line',
                                data: {
                                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                                    datasets: [
                                        {
                                            label: 'Revenue (SGD)',
                                            data: [3200, 2800, 3400, 4200, 3600, 3900, 3050],
                                            borderColor: '#f97316',
                                            backgroundColor: 'rgba(249, 115, 22, 0.15)',
                                            fill: true,
                                            tension: 0.4,
                                            yAxisID: 'y'
                                        },
                                        {
                                            label: 'Appointments',
                                            data: [12, 9, 11, 15, 13, 14, 10],
                                            borderColor: '#6366f1',
                                            backgroundColor: 'rgba(99, 102, 241, 0.15)',
                                            fill: false,
                                            tension: 0.3,
                                            yAxisID: 'y1'
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    interaction: { mode: 'index', intersect: false },
                                    plugins: {
                                        legend: { display: true },
                                        tooltip: { enabled: true }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            title: { display: true, text: 'Revenue (SGD)' }
                                        },
                                        y1: {
                                            beginAtZero: true,
                                            position: 'right',
                                            grid: { drawOnChartArea: false },
                                            title: { display: true, text: 'Appointments' }
                                        }
                                    }
                                }
                            },
                            chartMeta: { range: 'Last 7 days' }
                        },
                        leadsSummary: {
                            output: "Here's how many new leads were created this week.",
                            tool: "Analytics",
                            dataPoints: [
                                { metric: "New Leads", value: 28, change: 8 },
                                { metric: "Follow-ups Scheduled", value: 19, change: 5 },
                                { metric: "Lead-to-Customer", value: 32, suffix: "%", change: 2 }
                            ],
                            insights: [
                                "Social media campaigns contributed 45% of new leads.",
                                "Wednesday saw the highest conversions at 7 customers.",
                                "Average response time dropped to 1h 45m (12% faster)."
                            ],
                            chart: {
                                type: 'bar',
                                data: {
                                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                                    datasets: [
                                        {
                                            label: 'New Leads',
                                            data: [3, 4, 6, 5, 4, 3, 3],
                                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                            borderRadius: 8
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    plugins: {
                                        legend: { display: false }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            title: { display: true, text: 'Leads' }
                                        }
                                    }
                                }
                            },
                            chartMeta: { range: 'This week' }
                        },
                        fallback: {
                            output: "I'm ready when you are! How can I help today?",
                            tool: null,
                            dataPoints: []
                        }
                    };

                    let fallbackKey = null;
                    if (lowerCasePrompt.includes("list appointment")) {
                        fallbackKey = "appointmentList";
                    } else if (lowerCasePrompt.includes("available appointment") || lowerCasePrompt.includes("available slot")) {
                        fallbackKey = "appointmentSlots";
                    } else if (lowerCasePrompt.includes("invoice")) {
                        fallbackKey = "invoice";
                    } else if (lowerCasePrompt.includes("performance report") || lowerCasePrompt.includes("business report")) {
                        fallbackKey = "analyticsReport";
                    } else if (lowerCasePrompt.includes("leads") && (lowerCasePrompt.includes("week") || lowerCasePrompt.includes("this week"))) {
                        fallbackKey = "leadsSummary";
                    }

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000);

                    try {
                        const response = await fetch("https://qtick-mcp.onrender.com/agent/run", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: prompt }),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            try {
                                const errorBody = await response.json();
                                if (errorBody && errorBody.detail) {
                                    throw new Error(errorBody.detail);
                                }
                            } catch (e) {
                                throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                            }
                        }
                        return await response.json();
                    } catch (error) {
                        clearTimeout(timeoutId);
                        if (error.name === 'AbortError') {
                            throw new Error("Request timed out. The server might be starting up, please try again in a moment.");
                        }
                        if (fallbackKey && mockResponses[fallbackKey]) {
                            showToast("Live data unavailable, showing sample data instead.", true);
                            return mockResponses[fallbackKey];
                        }
                        throw error;
                    }
                }
            };
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            function setupRecognition(lang) {
                if (!SpeechRecognition) {
                    micBtn.disabled = true;
                    micBtn.title = "Speech recognition not supported in this browser.";
                    setMicStatus('Voice capture not supported in this browser', 'idle');
                    return;
                }
                recognition = new SpeechRecognition();
                recognition.lang = lang;
                recognition.continuous = false;
                recognition.interimResults = false;
                micBtn.disabled = false;
                micBtn.setAttribute('aria-pressed', 'false');
                micBtn.title = 'Start voice capture';

                recognition.onstart = () => {
                    micBtn.classList.add('listening', 'bg-red-500');
                    micBtn.classList.remove('bg-orange-500');
                    micBtn.setAttribute('aria-pressed', 'true');
                    micBtn.title = 'Stop voice capture';
                    setMicStatus('Listening…', 'listening');
                };
                recognition.onend = () => {
                    micBtn.classList.remove('listening', 'bg-red-500');
                    micBtn.classList.add('bg-orange-500');
                    micBtn.setAttribute('aria-pressed', 'false');
                    micBtn.title = 'Start voice capture';
                    if (!speechSubmitting) {
                        setMicStatus('Tap the mic to speak', 'idle');
                    }
                };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.trim();
                    if (!transcript) return;
                    speechSubmitting = true;
                    setMicStatus('Transcribing your request…', 'ready');
                    chatInput.value = transcript;
                    chatForm.dispatchEvent(new Event('submit', { bubbles: true }));
                };
                recognition.onerror = (event) => {
                    showToast(`Speech recognition error: ${event.error}`, true);
                    setMicStatus('Mic issue, try again', 'idle');
                };
            }

            const synth = window.speechSynthesis;
            let voices = [];

            function populateVoiceList() {
                voices = synth.getVoices();
            }
            populateVoiceList();
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = populateVoiceList;

            function speak(text, lang) {
                if (!voiceEnabled || !synth.speak || !text) return;
                synth.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                const voice = voices.find(v => v.lang === lang) || voices.find(v => v.lang && v.lang.startsWith(lang.split('-')[0]));
                if (voice) utterance.voice = voice;
                utterance.lang = lang;
                utterance.volume = notificationVolume;
                synth.speak(utterance);
            }

            micBtn.addEventListener('click', () => {
                if (!recognition) {
                    setMicStatus('Voice capture not ready', 'idle');
                    return;
                }
                if (!micBtn.classList.contains('listening')) {
                    try {
                        recognition.start();
                    } catch (e) {
                        showToast('Speech recognition already started.', true);
                        setMicStatus('Already listening…', 'listening');
                    }
                }
            });

            ttsToggleBtn.addEventListener('click', () => {
                voiceEnabled = !voiceEnabled;
                updateTtsAffordance();
                try {
                    localStorage.setItem(STORAGE_KEYS.voice, String(voiceEnabled));
                } catch (error) {
                    console.warn('Unable to persist voice toggle', error);
                }
                showToast(voiceEnabled ? "Voice responses enabled" : "Voice responses disabled");
                if (!voiceEnabled) synth.cancel();
            });

            attachBtn.addEventListener('click', () => fileInput.click());

            if (fileInput) {
                fileInput.addEventListener('change', () => {
                    const file = fileInput.files && fileInput.files[0];
                    if (file) {
                        renderFilePreview(file);
                    } else {
                        clearFilePreview();
                    }
                });
            }

            if (filePreviewContainer) {
                filePreviewContainer.addEventListener('click', (event) => {
                    if (event.target.closest('[data-remove-file]')) {
                        event.preventDefault();
                        clearFilePreview();
                    }
                });
            }

            if (notificationVolumeInput) {
                notificationVolumeInput.addEventListener('input', (event) => {
                    const value = Number(event.target.value);
                    if (!Number.isNaN(value)) {
                        notificationVolume = Math.min(1, Math.max(0, value));
                        updateVolumeLabel(notificationVolume);
                    }
                });
            }

            function showToast(message, isError = false) {
                const toast = document.createElement('div');
                toast.className = `toast transform translate-x-full opacity-0 p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-slate-800'}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.remove('translate-x-full', 'opacity-0'), 10);
                setTimeout(() => {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }
            function createContextId(prefix) {
                contextCounter += 1;
                return `${prefix}-${Date.now()}-${contextCounter}`;
            }

            function cloneData(data) {
                try {
                    return JSON.parse(JSON.stringify(data));
                } catch (error) {
                    return data;
                }
            }

            function saveChatState() {
                if (typeof localStorage === 'undefined') return;
                if (chatHistory.dataset.onboarding === 'true') return;
                try {
                    localStorage.setItem(STORAGE_KEYS.chat, chatHistory.innerHTML);
                    localStorage.setItem(STORAGE_KEYS.context, JSON.stringify({
                        contexts: conversationMemory.contexts,
                        contextOrder: conversationMemory.contextOrder,
                        lastAppointments: conversationMemory.lastAppointments,
                        lastSlots: conversationMemory.lastSlots,
                        lastSlotsContextId: conversationMemory.lastSlotsContextId,
                        lastInvoice: conversationMemory.lastInvoice,
                        lastInvoiceContextId: conversationMemory.lastInvoiceContextId,
                        lastSelectedAppointment: conversationMemory.lastSelectedAppointment,
                        lastSelectedContextId: conversationMemory.lastSelectedContextId,
                        lastCustomer: conversationMemory.lastCustomer,
                        lastAnalytics: conversationMemory.lastAnalytics,
                        lastAction: conversationMemory.lastAction
                    }));
                } catch (error) {
                    console.warn('Unable to persist chat history', error);
                }
            }

            function restoreChatState() {
                if (typeof localStorage === 'undefined') return;
                try {
                    const savedHTML = localStorage.getItem(STORAGE_KEYS.chat);
                    if (savedHTML) {
                        chatHistory.innerHTML = savedHTML;
                        delete chatHistory.dataset.onboarding;
                    }
                    const savedContext = localStorage.getItem(STORAGE_KEYS.context);
                    if (savedContext) {
                        const parsed = JSON.parse(savedContext);
                        if (parsed && typeof parsed === 'object') {
                            conversationMemory.contexts = parsed.contexts || {};
                            conversationMemory.contextOrder = parsed.contextOrder || [];
                            conversationMemory.lastAppointments = parsed.lastAppointments || [];
                            conversationMemory.lastSlots = parsed.lastSlots || [];
                            conversationMemory.lastSlotsContextId = parsed.lastSlotsContextId || null;
                            conversationMemory.lastInvoice = parsed.lastInvoice || null;
                            conversationMemory.lastInvoiceContextId = parsed.lastInvoiceContextId || null;
                            conversationMemory.lastSelectedAppointment = parsed.lastSelectedAppointment || null;
                            conversationMemory.lastSelectedContextId = parsed.lastSelectedContextId || null;
                            conversationMemory.lastCustomer = parsed.lastCustomer || '';
                            conversationMemory.lastAnalytics = parsed.lastAnalytics || null;
                            conversationMemory.lastAction = parsed.lastAction || null;
                        }
                    }
                } catch (error) {
                    console.warn('Unable to restore chat history', error);
                }
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            window.addEventListener('beforeunload', saveChatState);

            function getContextById(id) {
                if (!id) return null;
                return conversationMemory.contexts[id] || null;
            }

            function getLatestContextByType(type) {
                for (let i = conversationMemory.contextOrder.length - 1; i >= 0; i -= 1) {
                    const contextId = conversationMemory.contextOrder[i];
                    const context = conversationMemory.contexts[contextId];
                    if (context && context.type === type) {
                        return { id: contextId, data: context.data };
                    }
                }
                return null;
            }

            function updateLastCustomerFromAppointment(record) {
                if (!record) return;
                const candidate = record.customer || record.name || record.contactName;
                if (candidate && typeof candidate === 'string') {
                    conversationMemory.lastCustomer = candidate;
                }
            }

            function registerContext(context) {
                if (!context || !context.id) return;
                const cloned = cloneData(context.data);
                conversationMemory.contexts[context.id] = { type: context.type, data: cloned };
                conversationMemory.contextOrder = conversationMemory.contextOrder.filter(existing => existing !== context.id);
                conversationMemory.contextOrder.push(context.id);

                if (context.type === 'appointments') {
                    conversationMemory.lastAppointments = Array.isArray(cloned) ? cloned : [];
                    const last = conversationMemory.lastAppointments[conversationMemory.lastAppointments.length - 1];
                    if (last) updateLastCustomerFromAppointment(last);
                } else if (context.type === 'slots') {
                    conversationMemory.lastSlots = Array.isArray(cloned) ? cloned : [];
                    conversationMemory.lastSlotsContextId = context.id;
                } else if (context.type === 'invoice') {
                    conversationMemory.lastInvoice = cloned;
                    conversationMemory.lastInvoiceContextId = context.id;
                } else if (context.type === 'analytics') {
                    conversationMemory.lastAnalytics = cloned;
                }

                saveChatState();
            }

            function bootstrapCharts(root = document) {
                if (typeof Chart === 'undefined') return;
                const canvases = root.querySelectorAll('canvas[data-chart-config]');
                canvases.forEach(canvas => {
                    if (canvas.dataset.chartInitialized === 'true') return;
                    try {
                        const config = JSON.parse(canvas.dataset.chartConfig);
                        const chart = new Chart(canvas.getContext('2d'), config);
                        const key = canvas.id || `chart-${Date.now()}-${Math.random().toString(16).slice(2)}`;
                        activeCharts[key] = chart;
                        canvas.dataset.chartInitialized = 'true';
                    } catch (error) {
                        console.error('Failed to render chart', error);
                    }
                });
            }

            const render = {
                addMessageToChat: (content, isUser = false, options = {}) => {
                    if (chatHistory.dataset.onboarding === 'true') {
                        chatHistory.innerHTML = '';
                        delete chatHistory.dataset.onboarding;
                    }
                    const id = `msg-${Date.now()}-${Math.random().toString(16).slice(2)}`;
                    const messageWrapper = document.createElement('div');
                    messageWrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'} w-full`;
                    const message = document.createElement('div');
                    message.id = id;
                    message.dataset.rich = options.isRich ? 'true' : 'false';
                    message.dataset.fullWidth = !isUser && options.fullWidth ? 'true' : 'false';
                    message.classList.add('rounded-lg');
                    if (!isUser && options.fullWidth) {
                        message.classList.add('w-full', 'max-w-3xl');
                    } else {
                        message.classList.add('max-w-md');
                    }
                    if (isUser) {
                        message.classList.add('bg-orange-600', 'text-white', 'p-3', 'shadow-sm');
                    } else if (!options.isRich) {
                        message.classList.add('bg-slate-200', 'text-slate-800', 'p-3');
                    }
                    message.innerHTML = content;
                    messageWrapper.appendChild(message);
                    chatHistory.appendChild(messageWrapper);
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    saveChatState();
                    return id;
                },
                removeMessage: (id) => {
                    const msg = document.getElementById(id);
                    if (msg) {
                        const wrapper = msg.parentElement;
                        if (wrapper) wrapper.remove();
                        else msg.remove();
                        saveChatState();
                    }
                },
                updateMessage: (id, newContent, isRich = false) => {
                    const msg = document.getElementById(id);
                    if (msg) {
                        msg.innerHTML = newContent;
                        msg.dataset.rich = isRich ? 'true' : 'false';
                        if (isRich) {
                            msg.classList.remove('bg-slate-200', 'text-slate-800', 'p-3');
                            if (msg.dataset.fullWidth === 'true') {
                                msg.classList.add('w-full', 'max-w-3xl');
                                msg.classList.remove('max-w-md');
                            }
                        } else {
                            msg.classList.add('bg-slate-200', 'text-slate-800', 'p-3');
                            if (msg.dataset.fullWidth === 'true') {
                                msg.classList.add('w-full', 'max-w-3xl');
                                msg.classList.remove('max-w-md');
                            }
                        }
                        saveChatState();
                    }
                    return msg;
                },
                tools: () => {
                    if (!toolCatalog) return;
                    if (!tools.length) {
                        toolCatalog.innerHTML = `
                            <div class="flex items-center justify-center h-full text-slate-400">
                                <i class="fa fa-spinner fa-spin mr-2"></i> Loading Tools...
                            </div>
                        `;
                        return;
                    }

                    const availableCategories = new Set(Object.values(toolSchemas).map(schema => schema.category));
                    if (toolCategorySelect && !toolFiltersHydrated) {
                        const options = Array.from(availableCategories).sort().map(category => `
                            <option value="${escapeAttribute(category)}">${escapeAttribute(category)}</option>
                        `).join('');
                        toolCategorySelect.insertAdjacentHTML('beforeend', options);
                        toolFiltersHydrated = true;
                        if (toolCategoryFilter !== 'all') {
                            toolCategorySelect.value = toolCategoryFilter;
                        }
                    }

                    if (toolSearchInput && toolSearchInput.value.trim().toLowerCase() !== toolSearchTerm) {
                        toolSearchInput.value = toolSearchTerm;
                    }

                    const normalizedTools = tools.map(tool => {
                        const schema = toolSchemas[tool.name] || { title: tool.name, icon: 'fa-toolbox', category: 'Other' };
                        return { ...tool, schema };
                    });

                    const filteredTools = normalizedTools.filter(tool => {
                        const category = tool.schema.category || 'Other';
                        if (toolCategoryFilter !== 'all' && category !== toolCategoryFilter) {
                            return false;
                        }
                        if (!toolSearchTerm) return true;
                        const haystack = [tool.schema.title, tool.description, tool.name].filter(Boolean).join(' ').toLowerCase();
                        return haystack.includes(toolSearchTerm);
                    });

                    if (!filteredTools.length) {
                        toolCatalog.innerHTML = `
                            <div class="flex h-full flex-col items-center justify-center gap-3 rounded-3xl border border-dashed border-slate-300 bg-white/80 p-6 text-center text-sm text-slate-500">
                                <i class="fa-solid fa-binoculars text-xl text-slate-300"></i>
                                <p>No tools match your current filters.</p>
                                <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-300 px-4 py-2 text-xs font-semibold text-slate-600 hover:border-orange-300 hover:text-orange-600" data-clear-tool-filters>
                                    <i class="fa-solid fa-eraser"></i>
                                    Reset filters
                                </button>
                            </div>
                        `;
                        const clearFiltersBtn = toolCatalog.querySelector('[data-clear-tool-filters]');
                        if (clearFiltersBtn) {
                            clearFiltersBtn.addEventListener('click', () => {
                                toolSearchTerm = '';
                                toolCategoryFilter = 'all';
                                if (toolSearchInput) toolSearchInput.value = '';
                                if (toolCategorySelect) toolCategorySelect.value = 'all';
                                render.tools();
                            });
                        }
                        return;
                    }

                    const groupedTools = filteredTools.reduce((acc, tool) => {
                        const category = tool.schema.category || 'Other';
                        if (!acc[category]) acc[category] = [];
                        acc[category].push(tool);
                        return acc;
                    }, {});

                    toolCatalog.innerHTML = `
                        <div class="flex flex-col gap-6">
                            ${Object.entries(groupedTools).map(([category, toolList]) => `
                                <section class="rounded-3xl border border-slate-200/70 bg-white/80 p-6 shadow-sm backdrop-blur">
                                    <div class="flex flex-col gap-2">
                                        <span class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-orange-500/80">
                                            <i class="fa-solid fa-layer-group"></i>
                                            ${escapeAttribute(category)}
                                        </span>
                                        <h3 class="text-lg font-semibold text-slate-800">Curated tools for ${escapeAttribute(category.toLowerCase())} excellence</h3>
                                        <p class="text-sm text-slate-500">Explore beautifully organised actions that keep your team moving fast.</p>
                                    </div>
                                    <div class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3">
                                        ${toolList.map(tool => {
                                            const safeDescription = escapeAttribute(tool.description || '');
                                            const safeTitle = escapeAttribute(tool.schema.title || 'Tool');
                                            const safeTitleToken = escapeAttribute((tool.schema.title || '').split(' ')[0] || 'Tool');
                                            return `<button type="button" data-example="${escapeAttribute(tool.name)}" class="tool-item group relative w-full rounded-3xl border border-slate-200/70 bg-white/90 p-6 text-left shadow-sm transition duration-200 hover:-translate-y-1 hover:border-orange-300 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-orange-500/60">
                                                <div class="absolute inset-0 bg-gradient-to-br from-orange-500/10 via-transparent to-slate-100 opacity-0 transition duration-200 group-hover:opacity-100"></div>
                                                <div class="relative flex min-h-[220px] flex-col gap-6">
                                                    <div class="flex items-center justify-between gap-4">
                                                        <span class="inline-flex items-center gap-2 rounded-full border border-orange-500/20 bg-orange-500/10 px-3 py-1 text-[11px] font-medium text-orange-600">
                                                            <i class="fa-solid ${tool.schema.icon}"></i>
                                                            ${safeTitleToken}
                                                        </span>
                                                        <span class="flex h-10 w-10 items-center justify-center rounded-full border border-slate-200/60 bg-white text-slate-400 transition group-hover:border-orange-200 group-hover:text-orange-500">
                                                            <i class="fa-solid fa-bolt"></i>
                                                        </span>
                                                    </div>
                                                    <div class="space-y-2">
                                                        <h4 class="text-lg font-semibold text-slate-800 transition group-hover:text-orange-600">${safeTitle}</h4>
                                                        <p class="text-sm leading-relaxed text-slate-500">${safeDescription}</p>
                                                    </div>
                                                    <div class="mt-auto flex items-center justify-between text-slate-400 transition group-hover:text-orange-50">
                                                        <span class="inline-flex items-center gap-2 text-xs font-medium uppercase tracking-wide text-slate-400/80">${escapeAttribute(category)}</span>
                                                        <span class="inline-flex items-center gap-2 text-sm font-semibold text-orange-500 transition group-hover:text-white">
                                                            <i class="fa-solid fa-arrow-up-right-from-square"></i>
                                                        </span>
                                                    </div>
                                                </div>
                                            </button>`;
                                        }).join('')}
                                    </div>
                                </section>
                            `).join('')}
                        </div>
                    `;
                    toolCatalog.querySelectorAll('.tool-item').forEach(item => item.addEventListener('click', () => {
                        chatInput.value = item.dataset.example;
                        chatInput.focus();
                    }));
                },
                quickActions: () => {
                    if (!quickActionsList) return;

                    const selectedLocation = chillbreezeLocations.find(location => location.id === selectedQuickActionsLocationId) || chillbreezeLocations[0];

                    if (!selectedLocation) {
                        quickActionsList.innerHTML = `
                            <div class="flex h-full items-center justify-center rounded-2xl border border-dashed border-slate-300 bg-white/80 p-6 text-sm text-slate-500">
                                No businesses available right now.
                            </div>
                        `;
                        return;
                    }

                    const businessOptions = chillbreezeLocations.map(location => `
                        <option value="${escapeAttribute(location.id)}">${escapeAttribute(location.name)}</option>
                    `).join('');

                    const availableActions = quickActionTemplates.filter(action => {
                        if (!Array.isArray(action.roles) || action.roles.length === 0) {
                            return true;
                        }
                        return action.roles.includes(currentRole);
                    });

                    const actionCards = availableActions.map(action => {
                        const description = action.description
                            ? `<p class="text-xs text-slate-500">${escapeAttribute(action.description)}</p>`
                            : '';
                        const locationLine = action.showLocation === false
                            ? ''
                            : `<p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">${escapeAttribute(selectedLocation.name)}</p>`;
                        return `
                            <div class="quick-action-card group w-full rounded-2xl border border-slate-200/80 bg-white px-5 py-5 shadow-sm transition hover:-translate-y-0.5 hover:border-orange-300 hover:shadow-lg" role="button" tabindex="0" data-template="${escapeAttribute(action.promptTemplate)}">
                                <div class="flex items-start gap-4">
                                    <div class="h-12 w-12 rounded-xl flex items-center justify-center ${action.accent}">
                                        <i class="fa-solid ${action.icon} text-lg"></i>
                                    </div>
                                    <div class="flex-1 space-y-2">
                                        <p class="text-base font-semibold text-slate-800">${escapeAttribute(action.label)}</p>
                                        ${description}
                                        ${locationLine}
                                    </div>
                                    <i class="fa-solid fa-arrow-up-right-from-square text-slate-300 transition group-hover:text-orange-500"></i>
                                </div>
                                <div class="mt-6 flex items-center justify-between gap-3">
                                    <div class="flex items-center gap-2 text-[11px] font-medium text-slate-500">
                                        <i class="fa-regular fa-calendar"></i>
                                        <span>Time range</span>
                                    </div>
                                    <select class="time-range-select rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-medium text-slate-700 focus:border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-200/70" data-range-select>
                                        ${timeRangeOptions.map((option, index) => `
                                            <option value="${escapeAttribute(option.value)}" ${index === 0 ? 'selected' : ''}>${escapeAttribute(option.label)}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        `;
                    }).join('');

                    const spotlightSection = `
                        <section class="rounded-2xl border border-slate-200/80 bg-white/90 p-4 shadow-sm backdrop-blur">
                            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                <div class="space-y-1">
                                    <h3 class="text-sm font-semibold text-slate-700">Business spotlight</h3>
                                    <p class="text-xs text-slate-500">Switch lounges to tailor these ready-made prompts.</p>
                                </div>
                                <div class="sm:w-64">
                                    <label for="business-select" class="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500">Business</label>
                                    <select id="business-select" class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-200/70">
                                        ${businessOptions}
                                    </select>
                                </div>
                            </div>
                            <p class="mt-3 text-xs text-slate-500">${escapeAttribute(selectedLocation.focus)}</p>
                            <div class="mt-3 flex flex-col gap-3 rounded-xl bg-slate-50 px-3 py-3 text-slate-600 sm:flex-row sm:items-center sm:justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="flex h-9 w-9 items-center justify-center rounded-full bg-orange-500/10 text-orange-500">
                                        <i class="fa-solid fa-location-dot"></i>
                                    </span>
                                    <div>
                                        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Located in</p>
                                        <p class="text-sm font-semibold text-slate-800">${escapeAttribute(selectedLocation.area)}</p>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500 sm:text-right">Tailor these prompts for ${escapeAttribute(selectedLocation.name)}.</p>
                            </div>
                        </section>
                    `;

                    const cardsSection = availableActions.length
                        ? `<div class="grid grid-cols-1 gap-4 sm:grid-cols-2">${actionCards}</div>`
                        : `<div class="flex h-36 flex-col items-center justify-center gap-2 rounded-2xl border border-dashed border-slate-300 bg-white/80 p-4 text-sm text-slate-500">
                                <i class="fa-solid fa-compass text-lg text-slate-300"></i>
                                <p class="text-center">No quick actions match the ${escapeAttribute(ROLE_LABELS[currentRole] || 'selected')} workspace yet.</p>
                                <button type="button" class="text-xs font-semibold text-orange-600 hover:underline" data-show-tools-from-empty>Browse the tool catalog</button>
                           </div>`;

                    quickActionsList.innerHTML = `
                        <div class="flex flex-col gap-5">
                            ${spotlightSection}
                            <section class="rounded-2xl border border-slate-200/80 bg-white/95 p-4 shadow-sm backdrop-blur-sm">
                                <div class="flex items-start justify-between gap-2">
                                    <div>
                                        <h3 class="text-sm font-semibold text-slate-700">Insights & actions</h3>
                                        <p class="text-xs text-slate-500">Tap any card to ask the assistant instantly.</p>
                                    </div>
                                    <i class="fa-solid fa-wand-magic-sparkles text-slate-300"></i>
                                </div>
                                <div class="mt-4">
                                    ${cardsSection}
                                </div>
                            </section>
                        </div>
                    `;

                    const businessSelect = quickActionsList.querySelector('#business-select');
                    if (businessSelect) {
                        businessSelect.value = selectedLocation.id;
                        businessSelect.addEventListener('change', (event) => {
                            selectedQuickActionsLocationId = event.target.value;
                            render.quickActions();
                        });
                    }
                }
            };

            const ROLE_LABELS = { manager: 'Manager', ceo: 'CEO' };

            const closeRoleMenu = () => {
                if (roleSwitcherMenu) {
                    roleSwitcherMenu.classList.add('hidden');
                }
            };

            const updateRoleMenu = () => {
                if (roleSwitcherLabel) {
                    roleSwitcherLabel.textContent = ROLE_LABELS[currentRole] || ROLE_LABELS.manager;
                }
                if (roleSwitcherMenu) {
                    roleSwitcherMenu.querySelectorAll('[data-role-option]').forEach(option => {
                        const isActive = option.dataset.roleOption === currentRole;
                        option.classList.toggle('bg-orange-50', isActive);
                        option.classList.toggle('font-semibold', isActive);
                    });
                }
            };

            const setRole = (role) => {
                if (role !== 'manager' && role !== 'ceo') return;
                if (currentRole === role) {
                    updateRoleMenu();
                    return;
                }
                currentRole = role;
                try {
                    localStorage.setItem(STORAGE_KEYS.role, currentRole);
                } catch (error) {
                    console.warn('Unable to persist role preference', error);
                }
                updateRoleMenu();
                render.quickActions();
            };

            if (quickActionsList) {
                const handleQuickAction = (card) => {
                    if (!card) return;
                    const promptTemplate = card.dataset.template;
                    if (!promptTemplate) return;

                    const businessSelect = quickActionsList.querySelector('#business-select');
                    const selectedLocationId = businessSelect ? businessSelect.value : (chillbreezeLocations[0]?.id || '');
                    const selectedLocation = chillbreezeLocations.find(location => location.id === selectedLocationId) || chillbreezeLocations[0];
                    const rangeSelect = card.querySelector('[data-range-select]');
                    const selectedRange = rangeSelect ? rangeSelect.value : timeRangeOptions[0]?.value || 'today';

                    const prompt = promptTemplate
                        .replace(/\{location\}/g, selectedLocation ? selectedLocation.name : 'the business')
                        .replace(/\{timeRange\}/g, selectedRange);

                    chatInput.value = prompt;
                    chatInput.focus();
                    chatForm.dispatchEvent(new Event('submit', { bubbles: true }));
                };

                quickActionsList.addEventListener('click', (event) => {
                    const showToolsBtn = event.target.closest('[data-show-tools-from-empty]');
                    if (showToolsBtn) {
                        event.preventDefault();
                        updateSideRailState(false);
                        activateTab('tools');
                        showToast('Switched to the tool catalog');
                        return;
                    }
                    if (event.target.closest('select')) return;
                    const card = event.target.closest('.quick-action-card[data-template]');
                    handleQuickAction(card);
                });

                quickActionsList.addEventListener('keydown', (event) => {
                    if (event.target.closest('select')) return;
                    if (event.key !== 'Enter' && event.key !== ' ') return;
                    const card = event.target.closest('.quick-action-card[data-template]');
                    if (!card) return;
                    event.preventDefault();
                    handleQuickAction(card);
                });
            }

            if (roleSwitcherBtn && roleSwitcherMenu) {
                roleSwitcherBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    roleSwitcherMenu.classList.toggle('hidden');
                });

                roleSwitcherMenu.addEventListener('click', (event) => {
                    const option = event.target.closest('[data-role-option]');
                    if (!option) return;
                    event.preventDefault();
                    closeRoleMenu();
                    setRole(option.dataset.roleOption);
                });

                document.addEventListener('click', (event) => {
                    if (!roleSwitcherMenu || roleSwitcherMenu.classList.contains('hidden')) return;
                    if (roleSwitcherMenu.contains(event.target) || roleSwitcherBtn.contains(event.target)) return;
                    closeRoleMenu();
                });

                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        closeRoleMenu();
                    }
                });
            }

            function formatTextContent(text) {
                if (!text) return '';
                const escaped = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>');
                return escaped.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="text-orange-600 underline">$1</a>');
            }

            function formatCurrency(value, currency) {
                if (value === null || value === undefined || value === '') return '-';
                const num = Number(value);
                if (!Number.isFinite(num)) return `${value}${currency ? ` ${currency}` : ''}`;
                if (currency) {
                    try {
                        return new Intl.NumberFormat(undefined, { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
                    } catch (error) {
                        return `${num.toFixed(2)} ${currency}`;
                    }
                }
                return num.toFixed(2);
            }

            function formatDateTime(value) {
                if (!value) return '-';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return value;
                return date.toLocaleString();
            }

            function escapeAttribute(value) {
                if (value === null || value === undefined) return '';
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }

            function getLeadName(record) {
                if (!record || typeof record !== 'object') return '-';
                const nameParts = [];
                if (record.firstName) nameParts.push(String(record.firstName).trim());
                if (record.lastName) nameParts.push(String(record.lastName).trim());
                const combined = nameParts.filter(Boolean).join(' ').trim();
                if (combined) return combined;
                const candidateKeys = ['name', 'customerName', 'leadName', 'customer', 'contactName', 'fullName'];
                for (const key of candidateKeys) {
                    const value = record[key];
                    if (value !== null && value !== undefined) {
                        const text = String(value).trim();
                        if (text) return text;
                    }
                }
                return '-';
            }

            function formatSlotDisplay(value) {
                if (!value) {
                    return { displayDate: '', displayTime: '', iso: value };
                }
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return { displayDate: value, displayTime: '', iso: value };
                }
                return {
                    displayDate: date.toLocaleDateString(undefined, {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    }),
                    displayTime: date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }),
                    iso: value
                };
            }

            function formatMetricValue(point) {
                if (!point) return '-';
                const { value, currency, suffix, prefix } = point;
                if (value === null || value === undefined) return '-';
                if (currency) return formatCurrency(value, currency);
                if (prefix) return `${prefix}${value}`;
                if (suffix) return `${value}${suffix}`;
                if (typeof value === 'number' && Number.isFinite(value)) return value.toLocaleString();
                return value;
            }

            function formatChange(change) {
                if (change === null || change === undefined || change === '') return '';
                const value = Number(change);
                if (!Number.isFinite(value)) return change;
                const arrow = value >= 0 ? '▲' : '▼';
                const formatted = Math.abs(value) < 1 ? Math.abs(value).toFixed(1) : Math.abs(value).toFixed(0);
                return `${arrow} ${formatted}%`;
            }

            function flattenText(value) {
                if (value === null || value === undefined) return [];
                if (typeof value === 'string') {
                    const trimmed = value.trim();
                    return trimmed ? [trimmed] : [];
                }
                if (typeof value === 'number' || typeof value === 'boolean') {
                    return [String(value)];
                }
                if (Array.isArray(value)) {
                    return value.flatMap(item => flattenText(item));
                }
                if (typeof value === 'object') {
                    return Object.values(value).flatMap(item => flattenText(item));
                }
                return [String(value)];
            }

            function getFirstRaw(record, keys) {
                if (!record || typeof record !== 'object') return null;
                for (const key of keys) {
                    if (!Object.prototype.hasOwnProperty.call(record, key)) continue;
                    const value = record[key];
                    if (value === null || value === undefined) continue;
                    if (typeof value === 'string' && value.trim() === '') continue;
                    if (Array.isArray(value) && value.length === 0) continue;
                    if (typeof value === 'object' && !Array.isArray(value) && Object.keys(value).length === 0) continue;
                    return value;
                }
                return null;
            }

            function formatBusinessText(value) {
                return flattenText(value).join(', ');
            }

            function getFirstText(record, keys) {
                const raw = getFirstRaw(record, keys);
                if (raw === null || raw === undefined) return '';
                return formatBusinessText(raw);
            }

            function formatBusinessAddress(value) {
                const parts = flattenText(value);
                const unique = Array.from(new Set(parts.filter(Boolean)));
                return unique.join(', ');
            }

            function formatOperatingHoursDisplay(hours) {
                if (hours === null || hours === undefined) return '';
                if (typeof hours === 'string' || typeof hours === 'number' || typeof hours === 'boolean') {
                    const text = formatBusinessText(hours);
                    return text ? `<p class="text-xs text-slate-600">${escapeAttribute(text)}</p>` : '';
                }
                if (Array.isArray(hours)) {
                    const rows = hours.map(item => {
                        if (!item) return '';
                        if (typeof item === 'string') {
                            return `<p class="text-xs text-slate-600">${escapeAttribute(item)}</p>`;
                        }
                        if (typeof item === 'object') {
                            const day = getFirstText(item, ['day', 'label', 'name']);
                            const valueText = formatBusinessText(getFirstRaw(item, ['hours', 'value', 'time', 'range', 'slot']) ?? item);
                            if (day) {
                                return valueText
                                    ? `<div class="flex items-center justify-between gap-3 text-xs text-slate-500"><span class="font-medium text-slate-600">${escapeAttribute(day)}</span><span>${escapeAttribute(valueText)}</span></div>`
                                    : '';
                            }
                            return valueText ? `<p class="text-xs text-slate-600">${escapeAttribute(valueText)}</p>` : '';
                        }
                        return '';
                    }).filter(Boolean);
                    return rows.join('');
                }
                if (typeof hours === 'object') {
                    const rows = Object.entries(hours).map(([day, value]) => {
                        const valueText = formatBusinessText(value);
                        if (!valueText) return '';
                        return `<div class="flex items-center justify-between gap-3 text-xs text-slate-500"><span class="font-medium text-slate-600">${escapeAttribute(day)}</span><span>${escapeAttribute(valueText)}</span></div>`;
                    }).filter(Boolean);
                    return rows.join('');
                }
                const text = formatBusinessText(hours);
                return text ? `<p class="text-xs text-slate-600">${escapeAttribute(text)}</p>` : '';
            }

            function buildBusinessStatusBadge(status) {
                if (!status) return '';
                const normalized = status.toLowerCase();
                let classes = 'bg-emerald-100 text-emerald-600';
                if (normalized.includes('inactive') || normalized.includes('closed') || normalized.includes('suspended')) {
                    classes = 'bg-rose-100 text-rose-600';
                } else if (normalized.includes('pending') || normalized.includes('draft')) {
                    classes = 'bg-amber-100 text-amber-600';
                }
                return `<span class="rounded-full px-3 py-1 text-xs font-semibold ${classes} capitalize">${escapeAttribute(status)}</span>`;
            }

            const SOURCE_LINKS = {
                appointment: { label: 'Open in QTick calendar', href: 'https://crm.chillbreeze.app/appointments' },
                slots: { label: 'Manage availability', href: 'https://crm.chillbreeze.app/calendar' },
                invoice: { label: 'Show more detail in QTick billing', href: 'https://crm.chillbreeze.app/billing' },
                lead: { label: 'View in sales pipeline', href: 'https://crm.chillbreeze.app/leads' },
                analytics: { label: 'Open analytics workspace', href: 'https://crm.chillbreeze.app/analytics' }
            };

            function buildSourceLink(toolKey) {
                const meta = SOURCE_LINKS[toolKey];
                if (!meta) return '';
                return `
                    <div class="flex items-center justify-between rounded-lg border border-slate-200 bg-white/80 px-3 py-2 text-xs text-slate-500">
                        <span>${escapeAttribute(meta.label)}</span>
                        <a href="${escapeAttribute(meta.href)}" target="_blank" class="inline-flex items-center gap-1 font-semibold text-orange-600">
                            Open <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i>
                        </a>
                    </div>
                `;
            }

            function appointmentActionButtons(contextId, index) {
                const actions = [
                    { action: 'send-reminder', label: 'Send Reminder', icon: 'fa-bell' },
                    { action: 'reschedule', label: 'Reschedule', icon: 'fa-calendar-pen' },
                    { action: 'view-history', label: 'View Customer History', icon: 'fa-user-clock' }
                ];
                return `
                    <div class="flex flex-wrap gap-2">
                        ${actions.map(item => `
                            <button type="button" class="appointment-action-btn inline-flex items-center gap-2 rounded-md bg-white border border-slate-200 px-3 py-2 text-sm font-medium text-slate-600 hover:border-orange-300 hover:text-orange-600" data-appointment-action="${item.action}" data-context-id="${contextId || ''}" data-index="${index}">
                                <i class="fa-solid ${item.icon}"></i>
                                ${item.label}
                            </button>
                        `).join('')}
                    </div>
                `;
            }
            function buildToolDisplay(response) {
                if (!response) return null;
                const dataPoints = Array.isArray(response.dataPoints)
                    ? response.dataPoints
                    : response.dataPoints
                        ? [response.dataPoints]
                        : [];
                const normalizedTool = String(response.tool || '').toLowerCase();

                const builders = {
                    business: (records) => {
                        if (!records.length) return null;
                        const contextId = createContextId('businesses');
                        const normalized = records.map((record, index) => {
                            const name = getFirstText(record, ['name', 'businessName', 'title', 'label', 'displayName']) || `Business ${index + 1}`;
                            const id = getFirstText(record, ['id', 'businessId', 'locationId', 'externalId']);
                            const status = getFirstText(record, ['status', 'state', 'businessStatus']);
                            const type = getFirstText(record, ['type', 'businessType', 'category', 'segment']);
                            const phone = getFirstText(record, ['phone', 'phoneNumber', 'contactNumber', 'mobile', 'telephone']);
                            const email = getFirstText(record, ['email', 'contactEmail', 'supportEmail']);
                            const website = getFirstText(record, ['website', 'site', 'url']);
                            const addressRaw = getFirstRaw(record, ['address', 'address1', 'addressLine1', 'addressLine', 'addressLines', 'street', 'location', 'fullAddress']);
                            const address = addressRaw ? formatBusinessAddress(addressRaw) : '';
                            const area = getFirstText(record, ['area', 'neighborhood', 'city', 'region', 'state', 'country']);
                            const hoursRaw = getFirstRaw(record, ['hours', 'operatingHours', 'openingHours', 'businessHours']);
                            const hoursMarkup = formatOperatingHoursDisplay(hoursRaw);
                            let tags = [];
                            const rawTags = getFirstRaw(record, ['tags', 'labels', 'categories', 'segments']);
                            if (Array.isArray(rawTags)) {
                                tags = rawTags.map(tag => formatBusinessText(tag)).map(tag => tag.trim()).filter(Boolean);
                            } else if (rawTags) {
                                const tagText = formatBusinessText(rawTags).trim();
                                if (tagText) tags = [tagText];
                            }
                            return { name, id, status, type, phone, email, website, address, area, hoursMarkup, tags, raw: record };
                        });

                        if (normalized.length > 1) {
                            const cards = normalized.map((business, index) => {
                                const statusBadge = buildBusinessStatusBadge(business.status);
                                const tagsMarkup = business.tags.length
                                    ? `<div class="flex flex-wrap gap-2">${business.tags.map(tag => `<span class="rounded-full bg-orange-50 px-3 py-1 text-[11px] font-semibold text-orange-600">${escapeAttribute(tag)}</span>`).join('')}</div>`
                                    : '';
                                const hoursSection = business.hoursMarkup
                                    ? `<div class="rounded-xl border border-slate-200 bg-slate-50 p-3 space-y-1">
                                            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Operating hours</p>
                                            ${business.hoursMarkup}
                                       </div>`
                                    : '';
                                const areaLine = business.area && business.area !== business.address
                                    ? `<p class="flex items-start gap-2"><i class="fa-solid fa-map text-slate-400"></i><span>${escapeAttribute(business.area)}</span></p>`
                                    : '';
                                return `
                                    <div class="business-card flex h-full flex-col gap-4 rounded-2xl border border-slate-200/80 bg-white/90 p-5 shadow-sm" data-context-id="${contextId}" data-index="${index}">
                                        <div class="flex items-start justify-between gap-3">
                                            <div class="space-y-1">
                                                <p class="text-base font-semibold text-slate-800">${escapeAttribute(business.name)}</p>
                                                ${business.type ? `<p class="text-xs uppercase tracking-wide text-slate-400">${escapeAttribute(business.type)}</p>` : ''}
                                                ${business.id ? `<p class="text-[11px] text-slate-400">ID: ${escapeAttribute(business.id)}</p>` : ''}
                                            </div>
                                            ${statusBadge}
                                        </div>
                                        <div class="space-y-2 text-sm text-slate-600">
                                            ${business.address ? `<p class="flex items-start gap-2"><i class="fa-solid fa-location-dot mt-1 text-slate-400"></i><span>${escapeAttribute(business.address)}</span></p>` : ''}
                                            ${areaLine}
                                            ${business.phone ? `<p class="flex items-center gap-2"><i class="fa-solid fa-phone text-slate-400"></i><span>${escapeAttribute(business.phone)}</span></p>` : ''}
                                            ${business.email ? `<p class="flex items-center gap-2"><i class="fa-solid fa-envelope text-slate-400"></i><span>${escapeAttribute(business.email)}</span></p>` : ''}
                                            ${business.website ? `<p class="flex items-center gap-2"><i class="fa-solid fa-globe text-slate-400"></i><span class="break-all">${escapeAttribute(business.website)}</span></p>` : ''}
                                        </div>
                                        ${hoursSection}
                                        ${tagsMarkup}
                                    </div>
                                `;
                            }).join('');

                            const markup = `
                                <div class="chat-response-container space-y-4" data-context-id="${contextId}" data-context-type="businesses">
                                    <div class="flex items-center justify-between gap-3">
                                        <h4>Businesses</h4>
                                        <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-500">${normalized.length} found</span>
                                    </div>
                                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">${cards}</div>
                                    ${buildSourceLink('business')}
                                </div>
                            `;

                            return {
                                markup,
                                contexts: [{ id: contextId, type: 'businesses', data: records }],
                                renderOptions: { isRich: true, fullWidth: true }
                            };
                        }

                        const business = normalized[0];
                        const statusBadge = buildBusinessStatusBadge(business.status);
                        const detailItems = [
                            { label: 'Business ID', value: business.id },
                            { label: 'Type', value: business.type },
                            { label: 'Address', value: business.address || business.area },
                            { label: 'Phone', value: business.phone },
                            { label: 'Email', value: business.email, type: 'email' },
                            { label: 'Website', value: business.website, type: 'link' }
                        ].filter(item => item.value);

                        const detailMarkup = detailItems.length
                            ? `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-slate-600">
                                    ${detailItems.map(item => {
                                        const safeValue = escapeAttribute(item.value);
                                        let content = safeValue;
                                        if (item.type === 'link') {
                                            const hrefValue = /^(https?:)?\/\//i.test(item.value) ? item.value : `https://${item.value}`;
                                            content = `<a href="${escapeAttribute(hrefValue)}" target="_blank" class="text-orange-600 underline break-all">${safeValue}</a>`;
                                        } else if (item.type === 'email') {
                                            content = `<a href="mailto:${safeValue}" class="text-orange-600 underline break-all">${safeValue}</a>`;
                                        }
                                        return `<div><span class="block font-semibold text-slate-700">${item.label}</span>${content}</div>`;
                                    }).join('')}
                               </div>`
                            : '';

                        const tagsMarkup = business.tags.length
                            ? `<div class="flex flex-wrap gap-2">${business.tags.map(tag => `<span class="rounded-full bg-orange-50 px-3 py-1 text-[11px] font-semibold text-orange-600">${escapeAttribute(tag)}</span>`).join('')}</div>`
                            : '';

                        const markup = `
                            <div class="chat-response-container space-y-4" data-context-id="${contextId}" data-context-type="businesses">
                                <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                    <div>
                                        <h4>${escapeAttribute(business.name)}</h4>
                                        ${business.type ? `<p class="text-xs uppercase tracking-wide text-slate-400">${escapeAttribute(business.type)}</p>` : ''}
                                        ${business.id ? `<p class="text-xs text-slate-400">ID: ${escapeAttribute(business.id)}</p>` : ''}
                                    </div>
                                    ${statusBadge}
                                </div>
                                ${detailMarkup}
                                ${business.hoursMarkup ? `<div class="rounded-xl border border-slate-200 bg-slate-50 p-4 space-y-2"><p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Operating hours</p>${business.hoursMarkup}</div>` : ''}
                                ${tagsMarkup}
                                ${buildSourceLink('business')}
                            </div>
                        `;

                        return {
                            markup,
                            contexts: [{ id: contextId, type: 'businesses', data: records }],
                            renderOptions: { isRich: true, fullWidth: true }
                        };
                    },
                    invoice: (records) => {
                        const invoice = records[0] || {};
                        const contextId = createContextId('invoice');
                        const currency = invoice.currency;
                        const items = Array.isArray(invoice.items) ? invoice.items.map(item => `
                            <tr>
                                <td class="py-2 text-sm text-slate-600">${item.description || '-'}</td>
                                <td class="py-2 text-sm text-center text-slate-600">${item.quantity ?? 1}</td>
                                <td class="py-2 text-sm text-right text-slate-600">${item.unitPrice !== undefined ? formatCurrency(item.unitPrice, currency) : '-'}</td>
                                <td class="py-2 text-sm text-right text-slate-600">${item.taxRate !== undefined ? `${Math.round(item.taxRate * 100)}%` : '-'}</td>
                                <td class="py-2 text-sm text-right text-slate-600">${item.unitPrice !== undefined ? formatCurrency((item.quantity ?? 1) * item.unitPrice, currency) : '-'}</td>
                            </tr>
                        `).join('') : '';

                        const markup = `
                            <div class="chat-response-container space-y-4" data-context-id="${contextId}" data-context-type="invoice">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                    <div>
                                        <h4>Invoice ${invoice.invoiceId || ''}</h4>
                                        <p class="text-sm text-slate-500">Customer: ${invoice.customer || '-'}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs uppercase text-slate-500">Total Due</p>
                                        <p class="text-2xl font-bold text-orange-600">${formatCurrency(invoice.total, currency)}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 text-sm text-slate-600">
                                    <div><span class="block font-semibold text-slate-700">Status</span>${invoice.status || '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Created</span>${invoice.createdAt ? new Date(invoice.createdAt).toLocaleString() : '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Business ID</span>${invoice.businessId ?? '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Payment Link</span>${invoice.paymentLink ? `<a href="${invoice.paymentLink}" target="_blank" class="text-orange-600 underline break-all">Pay now</a>` : '-'}</div>
                                </div>
                                ${items ? `
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full text-left">
                                            <thead>
                                                <tr class="text-xs uppercase tracking-wide text-slate-500">
                                                    <th class="pb-2">Description</th>
                                                    <th class="pb-2 text-center">Qty</th>
                                                    <th class="pb-2 text-right">Unit Price</th>
                                                    <th class="pb-2 text-right">Tax</th>
                                                    <th class="pb-2 text-right">Line Total</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-200">${items}</tbody>
                                        </table>
                                    </div>
                                ` : ''}
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" class="invoice-action-btn inline-flex items-center gap-2 rounded-md bg-orange-50 border border-orange-200 px-3 py-2 text-sm font-medium text-orange-600 hover:bg-orange-100" data-invoice-action="send-whatsapp" data-context-id="${contextId}">
                                        <i class="fa-solid fa-paper-plane"></i>
                                        Send to Customer via WhatsApp
                                    </button>
                                    <button type="button" class="invoice-action-btn inline-flex items-center gap-2 rounded-md bg-slate-100 border border-slate-300 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200" data-invoice-action="mark-paid" data-context-id="${contextId}">
                                        <i class="fa-solid fa-circle-check"></i>
                                        Mark as Paid
                                    </button>
                                </div>
                                ${buildSourceLink('invoice')}
                            </div>
                        `;

                        return {
                            markup,
                            contexts: [{ id: contextId, type: 'invoice', data: invoice }],
                            renderOptions: { isRich: true, fullWidth: true }
                        };
                    },
                    appointment: (records) => {
                        if (!records.length) return null;
                        const allAvailable = records.every(record => String(record.status || '').toLowerCase() === 'available');
                        if (allAvailable) {
                            const contextId = createContextId('slots');
                            const normalizedSlots = records.map(record => {
                                const display = formatSlotDisplay(record.datetime || record.iso || record.slot || record);
                                return {
                                    iso: display.iso,
                                    displayDate: display.displayDate,
                                    displayTime: display.displayTime,
                                    serviceId: record.serviceId,
                                    businessId: record.businessId,
                                    customer: record.customer || ''
                                };
                            });
                            const cards = normalizedSlots.map((slot, index) => `
                                <button type="button" class="available-slot-card border border-slate-200 rounded-lg p-3 text-left bg-slate-50 hover:bg-orange-50 hover:border-orange-200 transition flex flex-col gap-1" data-context-id="${contextId}" data-index="${index}" data-slot="${escapeAttribute(slot.iso)}" data-customer="${escapeAttribute(slot.customer)}">
                                    <span class="text-sm font-semibold text-slate-700">${slot.displayTime || slot.displayDate || 'Slot'}</span>
                                    ${slot.displayDate ? `<span class="text-xs text-slate-500">${slot.displayDate}</span>` : ''}
                                </button>
                            `).join('');
                            const markup = `
                                <div class="chat-response-container space-y-3" data-context-id="${contextId}" data-context-type="slots">
                                    <div class="flex items-center justify-between">
                                        <h4>Available Slots</h4>
                                        <span class="text-xs px-2 py-1 bg-slate-100 text-slate-500 rounded-full">${normalizedSlots.length} options</span>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                        ${cards}
                                    </div>
                                    <p class="text-xs text-slate-500">Click a slot to populate a booking command automatically.</p>
                                    ${buildSourceLink('slots')}
                                </div>
                            `;
                            return {
                                markup,
                                contexts: [{ id: contextId, type: 'slots', data: normalizedSlots }],
                                renderOptions: { isRich: true, fullWidth: true }
                            };
                        }

                        if (records.length > 1) {
                            const contextId = createContextId('appointments');
                            const rows = records.map((record, index) => `
                                <tr class="appointment-row" data-context-id="${contextId}" data-index="${index}">
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.appointmentId || record.queueNumber || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.customer || record.name || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.serviceId ?? '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${formatDateTime(record.datetime)}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700 capitalize">${record.status || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.queueNumber || '-'}</td>
                                </tr>
                            `).join('');
                            const markup = `
                                <div class="chat-response-container space-y-4 appointments-wrapper" data-context-id="${contextId}" data-context-type="appointments">
                                    <h4>Appointments</h4>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full">
                                            <thead>
                                                <tr>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">ID</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Customer</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Service</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Date & Time</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Status</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Queue</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-200">${rows}</tbody>
                                        </table>
                                    </div>
                                    <div class="appointment-action-panel border border-dashed border-orange-200 rounded-lg p-3 bg-orange-50 text-sm text-orange-700" data-action-panel="${contextId}">
                                        Tap a row to reveal quick actions.
                                    </div>
                                    ${buildSourceLink('appointment')}
                                </div>
                            `;
                            return {
                                markup,
                                contexts: [{ id: contextId, type: 'appointments', data: records }],
                                renderOptions: { isRich: true, fullWidth: true }
                            };
                        }

                        const appointment = records[0];
                        const contextId = createContextId('appointments');
                        const detailRows = [
                            { label: 'Customer', value: appointment.customer || appointment.name || '-' },
                            { label: 'Status', value: appointment.status || '-' },
                            { label: 'Date & Time', value: formatDateTime(appointment.datetime) },
                            { label: 'Queue Number', value: appointment.queueNumber || '-' },
                            { label: 'Service ID', value: appointment.serviceId ?? '-' },
                            { label: 'Business ID', value: appointment.businessId ?? '-' }
                        ];
                        const statusMessage = appointment.message
                            ? `<p class="text-sm text-slate-600 bg-orange-50 border border-orange-200 p-3 rounded-md">${appointment.message}</p>`
                            : '';

                        const suggestedSlots = Array.isArray(appointment.suggestedSlots) ? appointment.suggestedSlots.filter(Boolean) : [];
                        let slotContextId = null;
                        let suggestedSlotsMarkup = '';
                        if (suggestedSlots.length) {
                            slotContextId = createContextId('slots');
                            const normalizedSlots = suggestedSlots.map(slot => {
                                const display = formatSlotDisplay(slot);
                                return {
                                    iso: display.iso,
                                    displayDate: display.displayDate,
                                    displayTime: display.displayTime,
                                    serviceId: appointment.serviceId,
                                    businessId: appointment.businessId,
                                    customer: appointment.customer || appointment.name || ''
                                };
                            });
                            suggestedSlotsMarkup = `
                                <div class="space-y-2" data-context-id="${slotContextId}" data-context-type="slots">
                                    <h5 class="font-semibold text-slate-700">Available times</h5>
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                        ${normalizedSlots.map((slot, index) => `
                                            <button type="button" class="suggested-slot-card border border-slate-200 rounded-lg p-3 text-left bg-slate-50 hover:bg-orange-50 hover:border-orange-200 transition flex flex-col gap-1" data-slot="${escapeAttribute(slot.iso)}" data-customer="${escapeAttribute(slot.customer)}" data-context-id="${slotContextId}" data-index="${index}">
                                                <span class="text-sm font-semibold text-slate-700">${slot.displayTime || slot.displayDate || 'Slot'}</span>
                                                ${slot.displayDate ? `<span class="text-xs text-slate-500">${slot.displayDate}</span>` : ''}
                                            </button>
                                        `).join('')}
                                    </div>
                                    <p class="text-xs text-slate-500">Select a time to update your request.</p>
                                </div>
                            `;
                            return {
                                markup: `
                                    <div class="chat-response-container space-y-4" data-context-id="${contextId}" data-context-type="appointments">
                                        <h4>Appointment ${appointment.appointmentId || appointment.queueNumber || ''}</h4>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-slate-600">
                                            ${detailRows.map(item => `<div><span class="block font-semibold text-slate-700">${item.label}</span>${item.value}</div>`).join('')}
                                        </div>
                                        ${statusMessage}
                                        ${suggestedSlotsMarkup}
                                        <div class="space-y-2">
                                            <p class="text-sm font-semibold text-slate-700">Quick actions</p>
                                            ${appointmentActionButtons(contextId, 0)}
                                            <p class="text-xs text-slate-500">Use these shortcuts or continue the conversation.</p>
                                        </div>
                                        ${buildSourceLink('appointment')}
                                    </div>
                                `,
                                contexts: [
                                    { id: contextId, type: 'appointments', data: [appointment] },
                                    { id: slotContextId, type: 'slots', data: normalizedSlots }
                                ],
                                renderOptions: { isRich: true, fullWidth: true }
                            };
                        }

                        const markup = `
                            <div class="chat-response-container space-y-4" data-context-id="${contextId}" data-context-type="appointments">
                                <h4>Appointment ${appointment.appointmentId || appointment.queueNumber || ''}</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-slate-600">
                                    ${detailRows.map(item => `<div><span class="block font-semibold text-slate-700">${item.label}</span>${item.value}</div>`).join('')}
                                </div>
                                ${statusMessage}
                                <div class="space-y-2">
                                    <p class="text-sm font-semibold text-slate-700">Quick actions</p>
                                    ${appointmentActionButtons(contextId, 0)}
                                    <p class="text-xs text-slate-500">Use these shortcuts or continue the conversation.</p>
                                </div>
                                ${buildSourceLink('appointment')}
                            </div>
                        `;
                        return {
                            markup,
                            contexts: [{ id: contextId, type: 'appointments', data: [appointment] }],
                            renderOptions: { isRich: true, fullWidth: true }
                        };
                    },
                    lead: (records) => {
                        if (!records.length) return null;
                        if (records.length > 1) {
                            const rows = records.map(record => `
                                <tr>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.leadId || record.id || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${getLeadName(record)}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.phone || record.phoneNumber || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.email || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.source || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.count ?? formatDateTime(record.createdAt)}</td>
                                </tr>
                            `).join('');
                            return {
                                markup: `
                                    <div class="chat-response-container">
                                        <h4>Leads</h4>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full">
                                                <thead>
                                                    <tr>
                                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Lead</th>
                                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Name</th>
                                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Phone</th>
                                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Email</th>
                                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Source</th>
                                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Count / Created</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-slate-200">${rows}</tbody>
                                            </table>
                                        </div>
                                        ${buildSourceLink('lead')}
                                    </div>
                                `,
                                renderOptions: { isRich: true, fullWidth: true }
                            };
                        }

                        const lead = records[0];
                        const leadName = getLeadName(lead);
                        const leadTitle = (lead.leadId || (leadName !== '-' ? leadName : '') || '').toString().trim();
                        const leadHeading = leadTitle ? `Lead ${leadTitle}` : 'Lead';
                        const detailRows = [
                            { label: 'Lead ID', value: lead.leadId || lead.id || '-' },
                            { label: 'Name', value: leadName },
                            { label: 'Phone', value: lead.phone || lead.phoneNumber || '-' },
                            { label: 'Email', value: lead.email || '-' },
                            { label: 'Source', value: lead.source || '-' },
                            { label: 'Notes', value: lead.notes || '-' },
                            { label: 'Created At', value: formatDateTime(lead.createdAt) }
                        ];
                        const visibleDetails = detailRows.filter(item => item.value !== '-' && item.value !== undefined && item.value !== null && item.value !== '');
                        const displayDetails = visibleDetails.length ? visibleDetails : detailRows;
                        return {
                            markup: `
                                <div class="chat-response-container space-y-4">
                                    <h4>${leadHeading}</h4>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-slate-600">
                                        ${displayDetails.map(item => `<div><span class="block font-semibold text-slate-700">${item.label}</span>${item.value || '-'}</div>`).join('')}
                                    </div>
                                    ${buildSourceLink('lead')}
                                </div>
                            `,
                            renderOptions: { isRich: true, fullWidth: true }
                        };
                    },
                    analytics: (records) => {
                        const contextId = createContextId('analytics');
                        const insights = Array.isArray(response.insights) ? response.insights : [];
                        const chartConfig = response.chart || null;
                        const chartMeta = response.chartMeta || {};
                        const cards = records.map(point => {
                            const changeLabel = formatChange(point.change);
                            const isPositive = typeof point.change === 'number' ? point.change >= 0 : String(point.change || '').startsWith('+');
                            const baselineText = point.baseline || chartMeta.baseline || 'Last period average';
                            return `
                                <div class="rounded-xl border border-slate-200 bg-slate-50 p-4 space-y-2">
                                    <div>
                                        <p class="text-xs uppercase tracking-wide text-slate-500">${point.metric || 'Metric'}</p>
                                        <p class="text-2xl font-bold text-slate-800">${formatMetricValue(point)}</p>
                                    </div>
                                    ${changeLabel ? `<p class="text-xs font-medium ${isPositive ? 'text-emerald-600' : 'text-rose-600'}">${changeLabel} vs last period</p>` : ''}
                                    <p class="text-[11px] text-slate-400">Baseline: ${escapeAttribute(baselineText)}</p>
                                </div>
                            `;
                        }).join('');

                        const legendItems = (() => {
                            if (Array.isArray(chartMeta.legendItems) && chartMeta.legendItems.length) {
                                return chartMeta.legendItems;
                            }
                            if (chartConfig && chartConfig.data && Array.isArray(chartConfig.data.datasets)) {
                                return chartConfig.data.datasets.map(dataset => ({
                                    label: dataset.label || 'Series',
                                    color: Array.isArray(dataset.borderColor) ? dataset.borderColor[0] : (dataset.borderColor || (Array.isArray(dataset.backgroundColor) ? dataset.backgroundColor[0] : dataset.backgroundColor))
                                })).filter(item => item.label);
                            }
                            return [];
                        })();

                        const legendMarkup = legendItems.length
                            ? `<div class="flex flex-wrap gap-3 text-xs text-slate-500">
                                    ${legendItems.map(item => {
                                        if (typeof item === 'string') {
                                            return `<span class=\"inline-flex items-center gap-2\"><span class=\"h-2 w-2 rounded-full bg-orange-400\"></span>${escapeAttribute(item)}</span>`;
                                        }
                                        const color = escapeAttribute(item.color || '#f97316');
                                        return `<span class=\"inline-flex items-center gap-2\"><span class=\"h-2 w-2 rounded-full\" style=\"background-color:${color}\"></span>${escapeAttribute(item.label)}</span>`;
                                    }).join('')}
                               </div>`
                            : '';

                        const chartId = chartConfig ? `${contextId}-chart` : null;
                        const chartMarkup = chartConfig ? `
                            <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                                <canvas id="${chartId}" data-chart-config="${escapeAttribute(JSON.stringify(chartConfig))}"></canvas>
                            </div>
                        ` : '';

                        const insightMarkup = insights.length
                            ? `<div class="space-y-2">
                                    <h5 class="text-sm font-semibold text-slate-700">Insights</h5>
                                    <ul class="list-disc pl-5 space-y-1 text-sm text-slate-600">
                                        ${insights.map(item => `<li>${item}</li>`).join('')}
                                    </ul>
                                </div>`
                            : '';

                        return {
                            markup: `
                                <div class="chat-response-container space-y-4" data-context-id="${contextId}" data-context-type="analytics">
                                    <div class="flex items-center justify-between gap-3">
                                        <h4>Business Intelligence</h4>
                                        ${chartMeta.range ? `<span class="text-xs px-2 py-1 bg-slate-100 text-slate-500 rounded-full">${chartMeta.range}</span>` : ''}
                                    </div>
                                    ${legendMarkup}
                                    ${cards ? `<div class="grid grid-cols-1 sm:grid-cols-3 gap-3">${cards}</div>` : ''}
                                    ${chartMarkup}
                                    ${insightMarkup}
                                    ${buildSourceLink('analytics')}
                                </div>
                            `,
                            contexts: [{ id: contextId, type: 'analytics', data: { metrics: records, insights, chart: chartConfig } }],
                            charts: chartConfig ? [{ id: chartId, config: chartConfig }] : [],
                            renderOptions: { isRich: true, fullWidth: true }
                        };
                    }
                };

                if (builders[normalizedTool]) {
                    return builders[normalizedTool](dataPoints);
                }
                const matchedKey = Object.keys(builders).find(key => normalizedTool.includes(key));
                if (matchedKey) {
                    return builders[matchedKey](dataPoints);
                }
                if (response.chart) {
                    return builders.analytics(dataPoints);
                }
                if (!dataPoints.length) return null;
                return {
                    markup: `<div class="chat-response-container" data-context-type="generic"><h4>${response.tool || 'Details'}</h4><pre class="text-sm text-slate-600 whitespace-pre-wrap">${escapeAttribute(JSON.stringify(dataPoints, null, 2))}</pre></div>`,
                    renderOptions: { isRich: true, fullWidth: true }
                };
            }
            function handleSlotCardSelection(card) {
                const slot = card.dataset.slot || '';
                const contextId = card.dataset.contextId || card.closest('[data-context-id]')?.dataset.contextId;
                const index = Number(card.dataset.index);
                const context = getContextById(contextId);
                let record = null;
                if (context && Array.isArray(context.data)) {
                    record = context.data[index];
                }
                const display = formatSlotDisplay(slot || (record ? record.iso : ''));
                const readableParts = [display.displayTime, display.displayDate].filter(Boolean);
                const readable = readableParts.length ? readableParts.join(' on ') : slot;
                const fallbackCustomer = conversationMemory.lastCustomer || 'the last customer';
                const customer = (card.dataset.customer && card.dataset.customer.trim()) || fallbackCustomer;
                let prompt = `Book an appointment for ${customer}`;
                if (readable) {
                    prompt += ` at ${readable}`;
                } else if (slot) {
                    prompt += ` at ${slot}`;
                }
                if (record && record.serviceId) {
                    prompt += ` for service ${record.serviceId}`;
                }
                chatInput.value = prompt.trim();
                chatInput.focus();
                showToast(readable ? `Ready to book ${readable}` : 'Added slot to your command.');
                saveChatState();
            }

            function handleAppointmentRowClick(row) {
                const contextId = row.dataset.contextId || row.closest('[data-context-id]')?.dataset.contextId;
                const index = Number(row.dataset.index);
                const context = getContextById(contextId);
                if (!context || !Array.isArray(context.data)) return;
                const appointment = context.data[index];
                if (!appointment) return;

                const tbody = row.parentElement;
                if (tbody) {
                    tbody.querySelectorAll('.appointment-row').forEach(r => r.classList.remove('bg-orange-50', 'ring-1', 'ring-orange-300'));
                }
                row.classList.add('bg-orange-50', 'ring-1', 'ring-orange-300');

                conversationMemory.lastSelectedAppointment = cloneData(appointment);
                conversationMemory.lastSelectedContextId = contextId;
                updateLastCustomerFromAppointment(appointment);

                const wrapper = row.closest('.appointments-wrapper');
                const panel = wrapper ? wrapper.querySelector(`[data-action-panel="${contextId}"]`) : null;
                if (panel) {
                    panel.innerHTML = `
                        <div class="space-y-2">
                            <p class="text-sm font-semibold text-slate-700">Quick actions for ${appointment.customer || appointment.name || 'this customer'}:</p>
                            ${appointmentActionButtons(contextId, index)}
                            <p class="text-xs text-slate-500">Use these shortcuts or continue the conversation.</p>
                        </div>
                    `;
                }
                saveChatState();
            }

            function handleAppointmentAction(button) {
                const action = button.dataset.appointmentAction;
                const contextId = button.dataset.contextId || conversationMemory.lastSelectedContextId;
                let index = Number(button.dataset.index);
                if (Number.isNaN(index) || index < 0) index = conversationMemory.lastAppointments.length - 1;
                const context = getContextById(contextId);
                let appointment = context && Array.isArray(context.data) ? context.data[index] : null;
                if (!appointment) {
                    appointment = conversationMemory.lastSelectedAppointment || conversationMemory.lastAppointments[index] || conversationMemory.lastAppointments[conversationMemory.lastAppointments.length - 1];
                }
                if (!appointment) return;

                updateLastCustomerFromAppointment(appointment);
                const appointmentId = appointment.appointmentId || appointment.queueNumber || `appointment ${index + 1}`;
                const when = formatDateTime(appointment.datetime);
                const customerName = appointment.customer || appointment.name || 'the customer';

                let prompt;
                switch (action) {
                    case 'send-reminder':
                        prompt = `Send a reminder to ${customerName} about appointment ${appointmentId} scheduled for ${when}.`;
                        showToast(`Prepared reminder for ${customerName}.`);
                        conversationMemory.lastAction = { type: 'appointmentReminder', appointmentId, timestamp: Date.now() };
                        break;
                    case 'reschedule':
                        prompt = `Reschedule appointment ${appointmentId} for ${customerName} to `;
                        showToast('Add the new time to the message to reschedule.');
                        conversationMemory.lastAction = { type: 'appointmentReschedule', appointmentId, timestamp: Date.now() };
                        break;
                    case 'view-history':
                        prompt = `Show the customer history for ${customerName}.`;
                        showToast(`Ready to view ${customerName}'s history.`);
                        conversationMemory.lastAction = { type: 'customerHistory', customerName, appointmentId, timestamp: Date.now() };
                        break;
                    case 'notify-cancel':
                        prompt = `Send a WhatsApp notification to ${customerName} about the cancellation of appointment ${appointmentId} scheduled for ${when}.`;
                        showToast('Notification command prepared.');
                        conversationMemory.lastAction = { type: 'appointmentNotifyCancel', appointmentId, timestamp: Date.now() };
                        break;
                    case 'undo':
                        prompt = `Undo the cancellation for appointment ${appointmentId}.`;
                        showToast('Prepared undo request.');
                        conversationMemory.lastAction = { type: 'appointmentUndo', appointmentId, timestamp: Date.now() };
                        break;
                    default:
                        return;
                }

                chatInput.value = prompt.trim();
                chatInput.focus();
                saveChatState();
            }

            function handleInvoiceAction(button) {
                const action = button.dataset.invoiceAction;
                const contextId = button.dataset.contextId || conversationMemory.lastInvoiceContextId;
                const context = getContextById(contextId);
                const invoice = context ? context.data : conversationMemory.lastInvoice;
                if (!invoice) return;
                const invoiceId = invoice.invoiceId || invoice.id || 'the invoice';
                const customerName = invoice.customer || 'the customer';
                let prompt;
                if (action === 'send-whatsapp') {
                    prompt = `Send invoice ${invoiceId} to ${customerName} via WhatsApp.`;
                    showToast(`Ready to send invoice ${invoiceId}.`);
                    conversationMemory.lastAction = { type: 'invoiceSend', invoiceId, timestamp: Date.now() };
                } else if (action === 'mark-paid') {
                    prompt = `Mark invoice ${invoiceId} as paid.`;
                    showToast(`Marked ${invoiceId} for payment update.`);
                    conversationMemory.lastAction = { type: 'invoicePaid', invoiceId, timestamp: Date.now() };
                } else {
                    return;
                }
                chatInput.value = prompt;
                chatInput.focus();
                saveChatState();
            }
            chatHistory.addEventListener('click', (event) => {
                const slotCard = event.target.closest('.suggested-slot-card, .available-slot-card');
                if (slotCard) {
                    handleSlotCardSelection(slotCard);
                    return;
                }

                const appointmentRow = event.target.closest('.appointment-row');
                if (appointmentRow) {
                    handleAppointmentRowClick(appointmentRow);
                    return;
                }

                const appointmentActionBtn = event.target.closest('.appointment-action-btn');
                if (appointmentActionBtn) {
                    handleAppointmentAction(appointmentActionBtn);
                    return;
                }

                const invoiceActionBtn = event.target.closest('.invoice-action-btn');
                if (invoiceActionBtn) {
                    handleInvoiceAction(invoiceActionBtn);
                }
            });
            function handleMemoryPrompt(prompt, placeholderId) {
                const lower = prompt.toLowerCase();
                let speechSummary = null;

                if (conversationMemory.lastAppointments.length) {
                    const appointment = conversationMemory.lastSelectedAppointment || conversationMemory.lastAppointments[conversationMemory.lastAppointments.length - 1];
                    if (appointment) {
                        const appointmentId = appointment.appointmentId || appointment.queueNumber || 'the appointment';
                        const when = formatDateTime(appointment.datetime);
                        const customerName = appointment.customer || appointment.name || 'the customer';
                        if (lower.includes('cancel') && (lower.includes('last') || lower.includes('one') || lower.includes('that'))) {
                            const message = `Understood. I have canceled the appointment for ${customerName} at ${when}. Should I notify them?`;
                            const markup = `
                                <div class="chat-response-container space-y-3" data-context-id="${conversationMemory.lastSelectedContextId || ''}" data-context-type="appointment-follow-up">
                                    <p class="text-sm text-slate-700">${message}</p>
                                    <div class="flex flex-wrap gap-2">
                                        <button type="button" class="appointment-action-btn inline-flex items-center gap-2 rounded-md bg-orange-50 border border-orange-200 px-3 py-2 text-sm font-medium text-orange-600 hover:bg-orange-100" data-appointment-action="notify-cancel" data-context-id="${conversationMemory.lastSelectedContextId || ''}" data-index="${conversationMemory.lastSelectedAppointment ? 0 : conversationMemory.lastAppointments.length - 1}">
                                            <i class="fa-solid fa-comment-dots"></i>
                                            Notify Customer
                                        </button>
                                        <button type="button" class="appointment-action-btn inline-flex items-center gap-2 rounded-md bg-slate-100 border border-slate-300 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200" data-appointment-action="undo" data-context-id="${conversationMemory.lastSelectedContextId || ''}" data-index="${conversationMemory.lastSelectedAppointment ? 0 : conversationMemory.lastAppointments.length - 1}">
                                            <i class="fa-solid fa-rotate-left"></i>
                                            Undo Cancellation
                                        </button>
                                    </div>
                                </div>
                            `;
                            render.updateMessage(placeholderId, markup, true);
                            conversationMemory.lastAction = { type: 'appointmentCancelled', appointmentId, timestamp: Date.now() };
                            saveChatState();
                            speechSummary = message;
                            return { speech: speechSummary };
                        }
                    }
                }

                if (conversationMemory.lastSlots.length && lower.includes('book') && lower.includes('slot')) {
                    let slot = conversationMemory.lastSlots[conversationMemory.lastSlots.length - 1];
                    if (lower.includes('first')) {
                        slot = conversationMemory.lastSlots[0];
                    }
                    if (slot) {
                        const readable = [slot.displayTime, slot.displayDate].filter(Boolean).join(' on ');
                        const message = `Great choice! I've prepared the booking for the ${readable || slot.iso}.`;
                        const markup = `
                            <div class="chat-response-container space-y-3" data-context-id="${conversationMemory.lastSlotsContextId || ''}" data-context-type="slots-follow-up">
                                <p class="text-sm text-slate-700">${message}</p>
                                <p class="text-xs text-slate-500">Use the quick action buttons if you would like to fine tune it further.</p>
                            </div>
                        `;
                        render.updateMessage(placeholderId, markup, true);
                        conversationMemory.lastAction = { type: 'slotPrepared', slot: slot.iso, timestamp: Date.now() };
                        saveChatState();
                        speechSummary = message;
                        return { speech: speechSummary };
                    }
                }

                if (conversationMemory.lastInvoice) {
                    const invoice = conversationMemory.lastInvoice;
                    const invoiceId = invoice.invoiceId || invoice.id || 'the invoice';
                    const customerName = invoice.customer || 'the customer';
                    if (lower.includes('send') && (lower.includes('customer') || lower.includes('whatsapp') || lower.includes('them'))) {
                        const message = `I'll send invoice ${invoiceId} to ${customerName} via WhatsApp right away.`;
                        const markup = `
                            <div class="chat-response-container space-y-3" data-context-id="${conversationMemory.lastInvoiceContextId || ''}" data-context-type="invoice-follow-up">
                                <p class="text-sm text-slate-700">${message}</p>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" class="invoice-action-btn inline-flex items-center gap-2 rounded-md bg-orange-50 border border-orange-200 px-3 py-2 text-sm font-medium text-orange-600 hover:bg-orange-100" data-invoice-action="send-whatsapp" data-context-id="${conversationMemory.lastInvoiceContextId || ''}">
                                        <i class="fa-solid fa-paper-plane"></i>
                                        Send again
                                    </button>
                                    <button type="button" class="invoice-action-btn inline-flex items-center gap-2 rounded-md bg-slate-100 border border-slate-300 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200" data-invoice-action="mark-paid" data-context-id="${conversationMemory.lastInvoiceContextId || ''}">
                                        <i class="fa-solid fa-circle-check"></i>
                                        Mark as Paid
                                    </button>
                                </div>
                            </div>
                        `;
                        render.updateMessage(placeholderId, markup, true);
                        conversationMemory.lastAction = { type: 'invoiceSend', invoiceId, timestamp: Date.now() };
                        saveChatState();
                        speechSummary = message;
                        return { speech: speechSummary };
                    }

                    if (lower.includes('mark') && lower.includes('paid')) {
                        const message = `Done. Invoice ${invoiceId} is now marked as paid.`;
                        render.updateMessage(placeholderId, `<div class="chat-response-container"><p class="text-sm text-slate-700">${message}</p></div>`, true);
                        conversationMemory.lastAction = { type: 'invoicePaid', invoiceId, timestamp: Date.now() };
                        saveChatState();
                        speechSummary = message;
                        return { speech: speechSummary };
                    }
                }

                return null;
            }
            async function handleChatSubmit(e) {
                e.preventDefault();
                const prompt = chatInput.value.trim();
                if (!prompt) {
                    speechSubmitting = false;
                    setMicStatus('Tap the mic to speak', 'idle');
                    return;
                }

                render.addMessageToChat(`<p>${formatTextContent(prompt)}</p>`, true);
                if (speechSubmitting) {
                    chatInput.value = prompt;
                    speechSubmitting = false;
                } else {
                    chatInput.value = '';
                }

                const thinkingMessageId = render.addMessageToChat(`<div class="bg-slate-200 text-slate-800 p-3 rounded-lg"><p class="italic text-slate-500 thinking-bubble">Connecting to agent</p></div>`, false);

                const memoryResult = handleMemoryPrompt(prompt, thinkingMessageId);
                if (memoryResult) {
                    if (memoryResult.speech) speak(memoryResult.speech, currentLang);
                    return;
                }

                try {
                    const response = await api.runAgent(prompt);

                    const textResponse = formatTextContent(response.output || response.confirmation_text);
                    if (textResponse) {
                        render.updateMessage(thinkingMessageId, `<p>${textResponse}</p>`, false);
                        speak(response.output || response.confirmation_text, currentLang);
                    } else {
                        render.removeMessage(thinkingMessageId);
                    }

                    const toolContent = buildToolDisplay(response);
                    if (toolContent) {
                        const messageId = render.addMessageToChat(toolContent.markup, false, toolContent.renderOptions || { isRich: true, fullWidth: true });
                        const messageElement = document.getElementById(messageId);
                        if (toolContent.contexts) {
                            toolContent.contexts.forEach(registerContext);
                        }
                        if (messageElement) {
                            bootstrapCharts(messageElement);
                        }
                    }

                    if (!textResponse && !toolContent) {
                        showToast("Received an empty or invalid response from the agent.", true);
                    }
                } catch (error) {
                    console.error("API call failed:", error);
                    let errorMessage = "Sorry, something went wrong. Please check the backend and try again.";
                    if (error.message) {
                        if (error.message.toLowerCase().includes("timed out")) {
                            errorMessage = "The request timed out. The server might be busy or starting up. Please wait a moment and try again.";
                        } else if (error.message.toLowerCase().includes("agent error")) {
                            errorMessage = "The agent encountered an internal error. Please try a different query or contact support if the issue persists.";
                        }
                    }
                    render.updateMessage(thinkingMessageId, `<p class="text-red-500">${errorMessage}</p>`, false);
                    speak(errorMessage, currentLang);
                } finally {
                    speechSubmitting = false;
                    setMicStatus('Tap the mic to speak', 'idle');
                    saveChatState();
                }
            }

            function toggleModal(modal, show) {
                if (show) {
                    modal.classList.remove('hidden');
                    pendingThemePreference = themePreference;
                    if (themeRadios.length) {
                        themeRadios.forEach(radio => {
                            radio.checked = radio.value === pendingThemePreference;
                        });
                    }
                    if (defaultRoleSelect) {
                        defaultRoleSelect.value = currentRole;
                    }
                    if (languageSelect) {
                        languageSelect.value = currentLang;
                    }
                    if (notificationVolumeInput) {
                        notificationVolumeInput.value = notificationVolume;
                        updateVolumeLabel(notificationVolume);
                    }
                } else {
                    modal.classList.add('hidden');
                    applyTheme(themePreference);
                    if (themeRadios.length) {
                        themeRadios.forEach(radio => {
                            radio.checked = radio.value === themePreference;
                        });
                    }
                    if (notificationVolumeInput) {
                        notificationVolumeInput.value = notificationVolume;
                        updateVolumeLabel(notificationVolume);
                    }
                }
            }

            settingsBtn.addEventListener('click', () => toggleModal(settingsModal, true));
            closeModalBtn.addEventListener('click', () => toggleModal(settingsModal, false));
            saveSettingsBtn.addEventListener('click', () => {
                currentLang = languageSelect.value;
                setupRecognition(currentLang);

                themePreference = pendingThemePreference;
                applyTheme(themePreference);
                try {
                    localStorage.setItem(STORAGE_KEYS.theme, themePreference);
                } catch (error) {
                    console.warn('Unable to persist theme preference', error);
                }
                pendingThemePreference = themePreference;

                if (defaultRoleSelect) {
                    setRole(defaultRoleSelect.value);
                }

                if (notificationVolumeInput) {
                    const sliderValue = Number(notificationVolumeInput.value);
                    if (!Number.isNaN(sliderValue)) {
                        notificationVolume = Math.min(1, Math.max(0, sliderValue));
                    }
                }
                updateVolumeLabel(notificationVolume);
                try {
                    localStorage.setItem(STORAGE_KEYS.volume, String(notificationVolume));
                } catch (error) {
                    console.warn('Unable to persist notification volume', error);
                }

                showToast('Settings updated successfully');
                toggleModal(settingsModal, false);
            });

            async function init() {
                restoreChatState();
                renderOnboardingCarousel();
                renderSuggestionChips();
                chatForm.addEventListener('submit', handleChatSubmit);
                tools = await api.getTools();
                render.tools();
                updateRoleMenu();
                render.quickActions();
                activateTab('tools');
                setupRecognition(currentLang);
                bootstrapCharts(chatHistory);
            }

            init();
        });
    </script>
</body>
</html>

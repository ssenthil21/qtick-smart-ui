<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Enabled AI Assistant - QTick</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .agentic-pane {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
        }
        .main-pane-height {
             height: calc(100vh - 120px);
        }
        .modal-backdrop, .drag-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .suggestion-chip, .tab-btn {
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .thinking-bubble::after {
            content: '.';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        #mic-btn.listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(234, 88, 12, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); }
        }
        /* Styles for rich content rendering */
        .chat-response-container {
            border: 1px solid #e2e8f0; /* slate-200 */
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: white;
        }
        .chat-response-container h4 {
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #1e293b; /* slate-800 */
        }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <nav class="container mx-auto px-4 lg:px-6 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-orange-600">
                <i class="fa-solid fa-robot mr-2"></i>QTick AI Smart Assistant
            </h1>
            <div class="flex items-center space-x-4">
                <button id="tts-toggle-btn" class="text-slate-400 hover:text-orange-600" title="Toggle Voice Response">
                    <i class="fa-solid fa-volume-xmark"></i>
                </button>
                 <button id="settings-btn" class="text-slate-500 hover:text-orange-600">
                    <i class="fa-solid fa-cog text-xl"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- Main layout updated to 5 columns -->
    <main class="container mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-5 gap-6">
        
        <!-- Center Pane: Chat Window (3 cols) -->
        <div class="lg:col-span-3 agentic-pane main-pane-height relative">
            <h2 class="text-lg font-bold p-4 border-b text-slate-700">Agent Chat</h2>
            <div id="chat-history" class="flex-grow p-4 space-y-4 overflow-y-auto">
                <div class="flex">
                    <div class="bg-slate-200 text-slate-800 p-3 rounded-lg max-w-md">
                        <p>I can now display data in tables, cards, and invoice summaries. Try asking me to "list appointments".</p>
                    </div>
                </div>
            </div>
            <div id="suggestion-chips-container" class="p-4 pt-0 flex flex-wrap gap-2"></div>
            <div class="p-4 border-t bg-slate-50">
                <div id="file-preview-container" class="hidden mb-2"></div>
                <form id="chat-form" class="flex items-center space-x-2">
                    <input type="file" id="file-input" class="hidden">
                    <button type="button" id="attach-btn" class="bg-slate-200 text-slate-600 font-semibold p-2.5 rounded-md hover:bg-slate-300 transition flex-shrink-0 h-10 w-10"><i class="fa-solid fa-paperclip"></i></button>
                    <input id="chat-input" placeholder="Enter your goal..." class="flex-grow w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
                    <button type="button" id="mic-btn" class="bg-orange-500 text-white font-semibold p-2.5 rounded-md hover:bg-orange-600 transition flex-shrink-0 h-10 w-10"><i class="fa-solid fa-microphone"></i></button>
                    <button type="submit" class="bg-orange-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-orange-700 transition flex-shrink-0">
                        Run
                    </button>
                </form>
            </div>
            <div id="drag-overlay" class="absolute inset-0 z-10 hidden items-center justify-center bg-opacity-75 backdrop-blur-sm drag-overlay">
                 <div class="text-center text-white p-6 border-4 border-dashed rounded-xl">
                    <i class="fa-solid fa-upload fa-3x"></i>
                    <p class="mt-4 text-xl font-bold">Drop file to upload</p>
                </div>
            </div>
        </div>
        
        <!-- Right Column Wrapper (2 cols) -->
        <div class="lg:col-span-2 flex flex-col gap-6">
            <div class="agentic-pane flex-1 overflow-hidden">
                 <h2 class="text-lg font-bold p-4 border-b text-slate-700 flex-shrink-0">Tool Catalog</h2>
                 <div id="tool-catalog" class="p-4 space-y-3 overflow-y-auto">
                     <div class="flex items-center justify-center h-full text-slate-400">
                        <i class="fa fa-spinner fa-spin mr-2"></i> Loading Tools...
                    </div>
                 </div>
            </div>
            <div class="agentic-pane flex-1 overflow-hidden">
                <h2 class="text-lg font-bold p-4 border-b text-slate-700 flex-shrink-0">History</h2>
                <div id="conversation-history-list" class="p-2 space-y-1 overflow-y-auto"></div>
            </div>
        </div>
    </main>
    
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-3"></div>

    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95">
             <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-bold">Settings</h3>
                <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                 <div>
                    <label for="language-select" class="block text-sm font-medium text-slate-700 mb-1">Language for Voice</label>
                    <select id="language-select" class="w-full p-2 border rounded-md bg-white">
                        <option value="en-US">English (US)</option>
                        <option value="ta-IN">Tamil (India)</option>
                    </select>
                </div>
                 <hr>
                 <button id="save-settings-btn" class="w-full bg-orange-600 text-white font-semibold py-2 px-3 rounded-md hover:bg-orange-700">Save Settings</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toolCatalog = document.getElementById('tool-catalog');
            const chatHistory = document.getElementById('chat-history');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const attachBtn = document.getElementById('attach-btn');
            const fileInput = document.getElementById('file-input');
            const filePreviewContainer = document.getElementById('file-preview-container');
            const dragOverlay = document.getElementById('drag-overlay');
            const micBtn = document.getElementById('mic-btn');
            const suggestionChipsContainer = document.getElementById('suggestion-chips-container');
            const ttsToggleBtn = document.getElementById('tts-toggle-btn');
            const toastContainer = document.getElementById('toast-container');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const languageSelect = document.getElementById('language-select');
            const conversationHistoryList = document.getElementById('conversation-history-list');
            
            let tools = [];
            let voiceEnabled = false;
            let currentLang = 'en-US';
            
            const toolSchemas = {
                "find_appointment": { title: "Find Appointment", icon: "fa-calendar-check", category: "Scheduling" },
                "book_appointment": { title: "Book Appointment", icon: "fa-calendar-plus", category: "Scheduling" },
                "create_invoice": { title: "Create Invoice", icon: "fa-file-invoice-dollar", category: "Billing" },
                "send_sms": { title: "Send SMS/WhatsApp", icon: "fa-comment-sms", category: "Communication" },
                "schedule_task": { title: "Schedule Task", icon: "fa-clock", category: "Automation" }
            };

            const mockHistory = [
                { id: 1, title: "Invoice for Jane Doe", time: "Today" },
                { id: 2, title: "Appointment Follow-up", time: "Yesterday" }
            ];
            
            // --- API LOGIC ---
            const api = {
                getTools: async () => {
                    await new Promise(r => setTimeout(r, 500));
                    return Object.keys(toolSchemas).map(name => ({ name, description: `A tool to ${toolSchemas[name].title.toLowerCase()}.` }));
                },
                runAgent: async (prompt) => {
                    const lowerCasePrompt = prompt.toLowerCase();

                    const mockResponses = {
                        appointmentList: {
                            output: "Here are the upcoming appointments I found.",
                            tool: "Appointment",
                            dataPoints: [
                                { status: "confirmed", appointmentId: "APT-001", queueNumber: "A01", businessId: 1003, customer: "Senthil", serviceId: 200, datetime: "2025-09-22T18:00:00+08:00" },
                                { status: "confirmed", appointmentId: "APT-002", queueNumber: "B02", businessId: 1003, customer: "Jane Doe", serviceId: 201, datetime: "2025-09-23T11:00:00+08:00" },
                                { status: "pending", appointmentId: "APT-003", queueNumber: "C03", businessId: 1003, customer: "John Smith", serviceId: 202, datetime: "2025-09-23T14:00:00+08:00" }
                            ]
                        },
                        appointmentSlots: {
                            output: "I found a few available slots for tomorrow.",
                            tool: "Appointment",
                            dataPoints: [
                                { status: "available", appointmentId: "SLOT-100", queueNumber: "-", businessId: 1003, customer: "", serviceId: 301, datetime: "2025-09-22T10:00:00+08:00" },
                                { status: "available", appointmentId: "SLOT-101", queueNumber: "-", businessId: 1003, customer: "", serviceId: 302, datetime: "2025-09-22T14:30:00+08:00" },
                                { status: "available", appointmentId: "SLOT-102", queueNumber: "-", businessId: 1003, customer: "", serviceId: 303, datetime: "2025-09-22T16:00:00+08:00" }
                            ]
                        },
                        invoice: {
                            output: "Invoice INV-00001 for Alex has been created successfully. The total amount is 52.0 SGD. You can pay via this link: https://pay.qtick.co/INV-00001",
                            tool: "Invoice",
                            dataPoints: [
                                {
                                    invoiceId: "INV-00001",
                                    total: 52.0,
                                    currency: "SGD",
                                    status: "created",
                                    createdAt: "2025-09-21T06:22:15.421334+00:00",
                                    paymentLink: "https://pay.qtick.co/INV-00001",
                                    items: [
                                        { description: "Haircut", quantity: 1, unitPrice: 25, taxRate: 0.08 },
                                        { description: "Hair serum", quantity: 2, unitPrice: 12.5 }
                                    ],
                                    customer: "Alex",
                                    businessId: 123
                                }
                            ]
                        },
                        fallback: {
                            output: "I'm ready when you are! How can I help today?",
                            tool: null,
                            dataPoints: []
                        }
                    };

                    if (lowerCasePrompt.includes("list appointment")) {
                        await new Promise(r => setTimeout(r, 1000));
                        return mockResponses.appointmentList;
                    }

                    if (lowerCasePrompt.includes("available appointment")) {
                        await new Promise(r => setTimeout(r, 1000));
                        return mockResponses.appointmentSlots;
                    }

                    if (lowerCasePrompt.includes("invoice")) {
                        await new Promise(r => setTimeout(r, 1000));
                        return mockResponses.invoice;
                    }

                    // FALLBACK TO LIVE API with TIMEOUT
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 seconds timeout

                    try {
                        const response = await fetch("https://qtick-mcp.onrender.com/agent/run", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: prompt }),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            try {
                                const errorBody = await response.json();
                                if (errorBody && errorBody.detail) {
                                    throw new Error(errorBody.detail);
                                }
                            } catch (e) {
                                // If parsing JSON fails or no 'detail' field, fall back to status text
                                throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                            }
                        }
                        return await response.json();
                    } catch (error) {
                        clearTimeout(timeoutId);
                        if (error.name === 'AbortError') {
                            throw new Error("Request timed out. The server might be starting up, please try again in a moment.");
                        }
                        throw error;
                    }
                }
            };

            // --- SPEECH RECOGNITION & SYNTHESIS ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            function setupRecognition(lang) {
                if (!SpeechRecognition) {
                    micBtn.disabled = true;
                    micBtn.title = "Speech recognition not supported in this browser.";
                    return;
                }
                recognition = new SpeechRecognition();
                recognition.lang = lang;
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => { micBtn.classList.add('listening', 'bg-red-500'); micBtn.classList.remove('bg-orange-500'); };
                recognition.onend = () => { micBtn.classList.remove('listening', 'bg-red-500'); micBtn.classList.add('bg-orange-500'); };
                recognition.onresult = (event) => {
                    chatInput.value = event.results[0][0].transcript;
                    chatForm.dispatchEvent(new Event('submit', { bubbles: true }));
                };
                recognition.onerror = (event) => showToast(`Speech recognition error: ${event.error}`, true);
            }

            let synth = window.speechSynthesis;
            let voices = [];
            function populateVoiceList() { voices = synth.getVoices(); }
            populateVoiceList();
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = populateVoiceList;

            function speak(text, lang) {
                if (!voiceEnabled || !synth.speak || !text) return;
                synth.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                const voice = voices.find(v => v.lang === lang) || voices.find(v => v.lang.startsWith(lang.split('-')[0]));
                if (voice) utterance.voice = voice;
                utterance.lang = lang;
                synth.speak(utterance);
            }
            
            micBtn.addEventListener('click', () => {
                if (recognition && !micBtn.classList.contains('listening')) {
                    try { recognition.start(); } catch (e) { showToast('Speech recognition already started.', true); }
                }
            });

            ttsToggleBtn.addEventListener('click', () => {
                voiceEnabled = !voiceEnabled;
                ttsToggleBtn.innerHTML = voiceEnabled ? '<i class="fa-solid fa-volume-high text-orange-600"></i>' : '<i class="fa-solid fa-volume-xmark"></i>';
                showToast(voiceEnabled ? "Voice responses enabled" : "Voice responses disabled");
                if (!voiceEnabled) synth.cancel();
            });

            // --- UI RENDERING & HELPERS ---
            function showToast(message, isError = false) {
                const toast = document.createElement('div');
                toast.className = `toast transform translate-x-full opacity-0 p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-slate-800'}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.remove('translate-x-full', 'opacity-0'), 10);
                setTimeout(() => {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            const render = {
                addMessageToChat: (content, isUser = false) => {
                    const id = `msg-${Date.now()}`;
                    const messageWrapper = document.createElement('div');
                    messageWrapper.className = `flex ${isUser ? 'justify-end' : ''}`;
                    const messageClass = isUser ? 'bg-orange-600 text-white p-3' : 'bg-transparent';
                    messageWrapper.innerHTML = `<div id="${id}" class="rounded-lg max-w-md ${messageClass}">${content}</div>`;
                    chatHistory.appendChild(messageWrapper);
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    return id;
                },
                removeMessage: (id) => {
                    const msg = document.getElementById(id);
                    if (msg) {
                        const wrapper = msg.parentElement;
                        if (wrapper) wrapper.remove();
                        else msg.remove();
                    }
                },
                updateMessage: (id, newContent, isRich = false) => {
                    const msg = document.getElementById(id);
                    if(msg) {
                        msg.innerHTML = newContent;
                        if (!isRich) msg.classList.add('bg-slate-200', 'text-slate-800', 'p-3');
                         else msg.classList.remove('bg-slate-200', 'text-slate-800', 'p-3');
                    }
                },
                table: (data) => {
                    const headers = data.headers.map(h => `<th class="px-4 py-2 text-left text-sm font-semibold text-slate-600 bg-slate-50">${h}</th>`).join('');
                    const rows = data.rows.map(row => `<tr>${row.map(cell => `<td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${cell}</td>`).join('')}</tr>`).join('');
                    return `<div class="chat-response-container"><h4>${data.title}</h4><div class="overflow-x-auto"><table class="min-w-full"><thead><tr>${headers}</tr></thead><tbody class="divide-y divide-slate-200">${rows}</tbody></table></div></div>`;
                },
                cards: (data) => {
                    const cards = data.items.map(item => `<div class="border rounded-lg p-3 bg-slate-50 text-center hover:shadow-md transition cursor-pointer"><h5 class="font-bold text-orange-600 text-lg">${item.title}</h5><p class="text-sm text-slate-500">${item.details}</p></div>`).join('');
                    return `<div class="chat-response-container"><h4>${data.title}</h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-3">${cards}</div></div>`;
                },
                invoice: (data) => {
                    const items = data.items.map(item => `<div class="flex justify-between text-slate-700"><span>${item.description}</span><span>$${item.amount}</span></div>`).join('');
                    return `<div class="chat-response-container"><h4>${data.title}</h4><p class="text-sm text-slate-500 mb-4">For: ${data.customer}</p><div class="space-y-2 border-t border-slate-200 pt-3">${items}</div><div class="space-y-1 border-t border-slate-200 mt-3 pt-3 text-sm"><div class="flex justify-between text-slate-500"><span>Subtotal</span><span>$${data.subtotal}</span></div><div class="flex justify-between text-slate-500"><span>Tax (7%)</span><span>$${data.tax}</span></div><div class="flex justify-between font-bold text-slate-800 text-base"><span>Total</span><span>$${data.total}</span></div></div></div>`;
                },
                tools: () => {
                    const groupedTools = tools.reduce((acc, tool) => {
                        const schema = toolSchemas[tool.name];
                        if (!schema) return acc;
                        (acc[schema.category] = acc[schema.category] || []).push(tool);
                        return acc;
                    }, {});
                    toolCatalog.innerHTML = Object.entries(groupedTools).map(([category, toolList]) => `<div><h3 class="font-bold text-slate-500 text-sm mb-2">${category}</h3><div class="space-y-2">${toolList.map(tool => { const schema = toolSchemas[tool.name]; return `<div data-example="${tool.name}" class="tool-item border p-3 rounded-md hover:bg-slate-50 cursor-pointer"><h4 class="font-bold text-slate-800"><i class="fa-solid ${schema.icon} mr-2 text-orange-500 w-5"></i>${schema.title}</h4></div>`; }).join('')}</div></div>`).join('');
                    toolCatalog.querySelectorAll('.tool-item').forEach(item => item.addEventListener('click', () => { chatInput.value = item.dataset.example; chatInput.focus(); }));
                },
                history: () => { conversationHistoryList.innerHTML = mockHistory.map((item, index) => `<div class="p-2 rounded-md ${index === 0 ? 'bg-orange-100 border-l-4 border-orange-500' : 'hover:bg-slate-100'} cursor-pointer"><p class="font-semibold text-sm truncate">${item.title}</p><p class="text-xs text-slate-500">${item.time}</p></div>`).join(''); }
            };
            
            // --- MAIN CHAT LOGIC ---
            function formatTextContent(text) {
                if (!text) return '';
                const escaped = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>');
                return escaped.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="text-orange-600 underline">$1</a>');
            }

            function formatCurrency(value, currency) {
                if (value === null || value === undefined || value === '') return '-';
                const num = Number(value);
                if (!Number.isFinite(num)) return `${value}${currency ? ` ${currency}` : ''}`;
                if (currency) {
                    try {
                        return new Intl.NumberFormat(undefined, { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
                    } catch (error) {
                        return `${num.toFixed(2)} ${currency}`;
                    }
                }
                return num.toFixed(2);
            }

            function formatDateTime(value) {
                if (!value) return '-';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return value;
                return date.toLocaleString();
            }

            function buildToolDisplay(tool, dataPoints) {
                if (!tool || !Array.isArray(dataPoints) || !dataPoints.length) return null;

                const builders = {
                    Invoice: (records) => {
                        const invoice = records[0] || {};
                        const currency = invoice.currency;
                        const items = Array.isArray(invoice.items) ? invoice.items.map(item => {
                            const quantity = item.quantity ?? 1;
                            const unitPrice = item.unitPrice !== undefined ? formatCurrency(item.unitPrice, currency) : '-';
                            const lineTotal = item.unitPrice !== undefined ? formatCurrency(quantity * item.unitPrice, currency) : '-';
                            const taxRate = item.taxRate !== undefined ? `${Math.round(item.taxRate * 100)}%` : '-';
                            return `
                                <tr>
                                    <td class="py-2 text-sm text-slate-600">${item.description || '-'}</td>
                                    <td class="py-2 text-sm text-slate-600 text-center">${quantity}</td>
                                    <td class="py-2 text-sm text-slate-600 text-right">${unitPrice}</td>
                                    <td class="py-2 text-sm text-slate-600 text-right">${taxRate}</td>
                                    <td class="py-2 text-sm text-slate-600 text-right">${lineTotal}</td>
                                </tr>
                            `;
                        }).join('') : '';

                        return `
                            <div class="chat-response-container space-y-4">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                    <div>
                                        <h4>Invoice ${invoice.invoiceId || ''}</h4>
                                        <p class="text-sm text-slate-500">Customer: ${invoice.customer || '-'}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm uppercase text-slate-500">Total Due</p>
                                        <p class="text-xl font-bold text-orange-600">${formatCurrency(invoice.total, currency)}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm text-slate-600">
                                    <div><span class="block font-semibold text-slate-700">Status</span>${invoice.status || '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Created</span>${invoice.createdAt ? new Date(invoice.createdAt).toLocaleString() : '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Business ID</span>${invoice.businessId ?? '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Payment Link</span>${invoice.paymentLink ? `<a href="${invoice.paymentLink}" target="_blank" class="text-orange-600 underline break-all">Pay now</a>` : '-'}</div>
                                </div>
                                ${items ? `
                                    <div>
                                        <h5 class="font-semibold text-slate-700 mb-2">Items</h5>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full text-left">
                                                <thead>
                                                    <tr class="text-xs uppercase tracking-wide text-slate-500">
                                                        <th class="pb-2">Description</th>
                                                        <th class="pb-2 text-center">Qty</th>
                                                        <th class="pb-2 text-right">Unit Price</th>
                                                        <th class="pb-2 text-right">Tax</th>
                                                        <th class="pb-2 text-right">Line Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-slate-200">${items}</tbody>
                                            </table>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    },
                    Appointment: (records) => {
                        if (records.length > 1) {
                            const rows = records.map(record => `
                                <tr>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.appointmentId || record.queueNumber || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.customer || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${formatDateTime(record.datetime)}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.status || '-'}</td>
                                    <td class="border-t border-slate-200 px-4 py-2 text-sm text-slate-700">${record.queueNumber || '-'}</td>
                                </tr>
                            `).join('');

                            return `
                                <div class="chat-response-container">
                                    <h4>Appointments</h4>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full">
                                            <thead>
                                                <tr>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">ID</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Customer</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Date & Time</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Status</th>
                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500 bg-slate-50">Queue</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-200">${rows}</tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }

                        const appointment = records[0];
                        return `
                            <div class="chat-response-container space-y-4">
                                <h4>Appointment ${appointment.appointmentId || ''}</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-slate-600">
                                    <div><span class="block font-semibold text-slate-700">Customer</span>${appointment.customer || '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Status</span>${appointment.status || '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Date & Time</span>${formatDateTime(appointment.datetime)}</div>
                                    <div><span class="block font-semibold text-slate-700">Queue Number</span>${appointment.queueNumber || '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Service ID</span>${appointment.serviceId ?? '-'}</div>
                                    <div><span class="block font-semibold text-slate-700">Business ID</span>${appointment.businessId ?? '-'}</div>
                                </div>
                            </div>
                        `;
                    }
                };

                if (builders[tool]) {
                    return builders[tool](dataPoints);
                }

                return `<div class="chat-response-container"><h4>${tool} Details</h4><pre class="text-sm text-slate-600 whitespace-pre-wrap">${JSON.stringify(dataPoints, null, 2)}</pre></div>`;
            }

            async function handleChatSubmit(e) {
                e.preventDefault();
                const prompt = chatInput.value.trim();
                if (!prompt) return;

                render.addMessageToChat(`<p>${prompt}</p>`, true);
                chatInput.value = '';

                const thinkingMessageId = render.addMessageToChat(`<div class="bg-slate-200 text-slate-800 p-3 rounded-lg"><p class="italic text-slate-500 thinking-bubble">Connecting to agent</p></div>`, false);

                try {
                    const response = await api.runAgent(prompt);

                    const textResponse = formatTextContent(response.output || response.confirmation_text);
                    if (textResponse) {
                        render.updateMessage(thinkingMessageId, `<p>${textResponse}</p>`, false);
                        speak(response.output || response.confirmation_text, currentLang);
                    } else {
                        render.removeMessage(thinkingMessageId);
                    }

                    const normalizedDataPoints = Array.isArray(response.dataPoints)
                        ? response.dataPoints
                        : response.dataPoints
                            ? [response.dataPoints]
                            : [];

                    const toolContent = buildToolDisplay(response.tool, normalizedDataPoints);
                    if (toolContent) {
                        render.addMessageToChat(toolContent, false);
                    }

                    if (!textResponse && !toolContent) {
                        showToast("Received an empty or invalid response from the agent.", true);
                    }

                } catch (error) {
                    console.error("API call failed:", error);
                    let errorMessage = "Sorry, something went wrong. Please check the backend and try again.";
                    if (error.message) {
                        if (error.message.toLowerCase().includes("timed out")) {
                            errorMessage = "The request timed out. The server might be busy or starting up. Please wait a moment and try again.";
                        } else if (error.message.toLowerCase().includes("agent error")) {
                            errorMessage = "The agent encountered an internal error. Please try a different query or contact support if the issue persists.";
                        }
                    }
                    render.updateMessage(thinkingMessageId, `<p class="text-red-500">${errorMessage}</p>`, false);
                    speak(errorMessage, currentLang);
                }
            }

            // --- SETTINGS ---
            function toggleModal(modal, show) {
                 if (show) modal.classList.remove('hidden');
                 else modal.classList.add('hidden');
            }
            
            settingsBtn.addEventListener('click', () => toggleModal(settingsModal, true));
            closeModalBtn.addEventListener('click', () => toggleModal(settingsModal, false));
            saveSettingsBtn.addEventListener('click', () => {
                currentLang = languageSelect.value;
                setupRecognition(currentLang);
                showToast(`Language set to ${languageSelect.options[languageSelect.selectedIndex].text}`);
                toggleModal(settingsModal, false);
            });
            
            // --- INITIALIZATION ---
            async function init() {
                chatForm.addEventListener('submit', handleChatSubmit);
                tools = await api.getTools();
                render.tools();
                render.history();
                setupRecognition(currentLang);
            }

            init();
        });
    </script>
</body>
</html>

